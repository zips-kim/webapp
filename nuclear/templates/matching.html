{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ğŸ”— êµìœ¡ ê²°ê³¼ ì •ë°€ ë§¤ì¹­ (ë‹¤ì¤‘ ì„ íƒ)</h2>
    <form action="{{ url_for('matching') }}" class="d-flex">
        <select name="set_id" class="form-select" onchange="this.form.submit()">
            {% for s in sets %}
            <option value="{{ s[0] }}" {% if s[0] == current_set_id %}selected{% endif %}>{{ s[1] }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<div class="alert alert-info py-2 small">
    <strong>ğŸ’¡ í•„í„° ì ìš©ë¨:</strong> 
    ì‘ì—… íš¨ìœ¨ì„ ìœ„í•´ <strong>[ëª…ë‹¨ì— ìˆëŠ” ì‚¬ëŒ]</strong>ê³¼ <strong>[ì´ë©”ì¼ ë¯¸ë“±ë¡]</strong> ê¸°ë¡ë§Œ ë³´ì´ë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
    (í‡´ì§ì ê¸°ë¡ì„ ë³´ë ¤ë©´ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ 'ğŸ“‹ ëª…ë‹¨ ìˆëŠ” ì‚¬ëŒë§Œ' ìŠ¤ìœ„ì¹˜ë¥¼ ë„ì„¸ìš”.)
</div>

<div class="row" style="height: 650px;">
    <div class="col-md-4 h-100">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>1. ë°©ì¬ìš”ì› ({{ personnel|length }}ëª…)</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filterPersonNoEmail" onchange="applyFilters('person')">
                        <label class="form-check-label small" for="filterPersonNoEmail">ğŸ“§ ë¯¸ë“±ë¡ë§Œ</label>
                    </div>
                </div>
                <input type="text" id="searchPerson" class="form-control form-control-sm" placeholder="ì´ë¦„ ê²€ìƒ‰...">
            </div>
            <div class="card-body p-0" style="overflow-y: auto;">
                <div class="list-group list-group-flush" id="personList">
                    {% for p in personnel %}
                    <button type="button" class="list-group-item list-group-item-action person-item" 
                            data-id="{{ p.id }}" data-name="{{ p.name }}" data-email="{{ p.email or '' }}">
                        <div class="d-flex justify-content-between w-100">
                            <h6 class="mb-1 fw-bold">{{ p.name }}</h6>
                            <small>{{ p.dept }}</small>
                        </div>
                        <small class="text-muted">
                            {% if p.email %}ğŸ“§ {{ p.email }}{% else %}<span class="text-danger small fw-bold">(ì´ë©”ì¼ ë¯¸ë“±ë¡)</span>{% endif %}
                        </small>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 h-100 d-flex flex-column justify-content-center align-items-center px-2">
        <div class="card p-3 w-100 shadow-sm bg-light border-primary">
            <h6 class="text-center text-muted mb-3">âš¡ ë§¤ì¹­ ì„¤ì •</h6>
            
            <div class="mb-2">
                <label class="form-label small fw-bold">ì„ íƒëœ ìš”ì›</label>
                <input type="text" id="dispPerson" class="form-control text-center bg-white" readonly placeholder="-">
            </div>

            <div class="text-center text-primary my-1">â¬‡ï¸ ì—°ê²° â¬‡ï¸</div>

            <div class="mb-3">
                <label class="form-label small fw-bold">ì„ íƒëœ êµìœ¡ ì´ë ¥</label>
                <div class="d-grid text-center">
                    <span class="badge bg-success fs-6" id="selectedCountBadge">0ê±´ ì„ íƒë¨</span>
                </div>
            </div>

            <hr>

            <div class="mb-3">
                <label class="form-label small fw-bold text-primary">ğŸ”— ì—°ê²°í•  ì´ë©”ì¼</label>
                <input type="email" id="matchEmail" class="form-control border-primary fw-bold text-center" placeholder="ì´ë©”ì¼ ì…ë ¥">
            </div>
            
            <button id="btnMatch" class="btn btn-primary w-100" disabled onclick="executeMatch()">
                ë§¤ì¹­ í™•ì •
            </button>
        </div>
    </div>

    <div class="col-md-5 h-100">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-end gap-3 mb-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filterHistoryCurrentOnly" onchange="applyFilters('history')" checked>
                        <label class="form-check-label small" for="filterHistoryCurrentOnly">ğŸ“‹ ëª…ë‹¨ ìˆëŠ” ì‚¬ëŒë§Œ</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filterHistoryNoEmail" onchange="applyFilters('history')" checked>
                        <label class="form-check-label small" for="filterHistoryNoEmail">ğŸ“§ ë¯¸ë“±ë¡ë§Œ</label>
                    </div>
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white text-success border-0 fw-bold">2. ì´ë ¥</span>
                    <input type="text" id="searchHistory" class="form-control" placeholder="ì „ì²´ ê²€ìƒ‰...">
                    <button class="btn btn-outline-light" type="button" onclick="$('#searchHistory').val('').trigger('keyup')">X</button>
                </div>
            </div>
            <div class="card-body p-0" style="overflow-y: auto;">
                <div class="list-group list-group-flush" id="historyList">
                    {% for h in history %}
                    <div class="list-group-item history-item-row" data-name="{{ h.name }}" data-email="{{ h.email or '' }}">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <input class="form-check-input history-checkbox" type="checkbox" 
                                       value="{{ h.id }}" id="hist_{{ h.id }}"
                                       data-email="{{ h.email or '' }}"
                                       style="transform: scale(1.3); cursor: pointer;">
                            </div>
                            <label class="flex-grow-1" for="hist_{{ h.id }}" style="cursor: pointer;">
                                <div class="d-flex justify-content-between w-100">
                                    <h6 class="mb-1">
                                        <span class="text-primary text-decoration-underline fw-bold history-name-trigger" 
                                              onclick="filterBothSides(event, '{{ h.name }}')"
                                              title="í´ë¦­ ì‹œ ì´ ì´ë¦„ìœ¼ë¡œ ì–‘ìª½ ëª©ë¡ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.">
                                            {{ h.name }}
                                        </span> 
                                        <small class="text-dark fw-normal">({{ h.training_year }})</small>
                                    </h6>
                                    <small>{{ h.training_date }}</small>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">{{ h.dept }} / {{ h.training_type }}</small>
                                    {% if h.email %}
                                        <small class="text-primary">{{ h.email }}</small>
                                    {% else %}
                                        <small class="text-danger fw-bold">ì´ë©”ì¼ ì—†ìŒ</small>
                                    {% endif %}
                                </div>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedPersonId = null;
    const personnelNames = new Set();

    // [ì´ˆê¸°í™”] í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì› ì´ë¦„ ìˆ˜ì§‘ ë° í•„í„° ì ìš©
    $(document).ready(function() {
        // 1. ì™¼ìª½ ëª…ë‹¨ì—ì„œ ì´ë¦„ ìˆ˜ì§‘ (ê³µë°±ì œê±°)
        $('.person-item').each(function() {
            const cleanName = $(this).data('name').toString().replace(/\s+/g, '').toLowerCase();
            personnelNames.add(cleanName);
        });
        
        console.log("í˜„ì› ìˆ˜ì§‘ ì™„ë£Œ: " + personnelNames.size + "ëª…");

        // 2. í•„í„° ì ìš©
        applyFilters('history');
    });

    // í†µí•© í•„í„° í•¨ìˆ˜
    function applyFilters(target) {
        let searchText, listItems;
        
        // í•„í„° ì¡°ê±´ë“¤
        const isPersonNoEmail = $('#filterPersonNoEmail').is(':checked');
        const isHistoryNoEmail = $('#filterHistoryNoEmail').is(':checked');
        const isHistoryCurrentOnly = $('#filterHistoryCurrentOnly').is(':checked');

        if (target === 'person') {
            searchText = $('#searchPerson').val().toLowerCase();
            listItems = $('.person-item');
        } else {
            searchText = $('#searchHistory').val().toLowerCase();
            listItems = $('.history-item-row');
        }

        listItems.each(function() {
            const text = $(this).text().toLowerCase();
            const name = $(this).data('name').toString().replace(/\s+/g, '').toLowerCase();
            const email = $(this).data('email');
            const hasEmail = (email && email !== 'None' && email.trim() !== '');

            // 1. ê²€ìƒ‰ì–´ ì²´í¬
            const matchText = text.indexOf(searchText) > -1;
            
            // 2. ì´ë©”ì¼ ë¯¸ë“±ë¡ í•„í„° ì²´í¬
            let matchEmail = true;
            if (target === 'person' && isPersonNoEmail) matchEmail = !hasEmail;
            if (target === 'history' && isHistoryNoEmail) matchEmail = !hasEmail;

            // 3. [ì‹ ê·œ] í˜„ì› ì¼ì¹˜ ì—¬ë¶€ ì²´í¬ (ì˜¤ë¥¸ìª½ ëª©ë¡ë§Œ í•´ë‹¹)
            let matchCurrent = true;
            if (target === 'history' && isHistoryCurrentOnly) {
                matchCurrent = personnelNames.has(name);
            }

            if (matchText && matchEmail && matchCurrent) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // ì´ë²¤íŠ¸ ì—°ê²°
    $('#searchPerson').on('keyup', function() { applyFilters('person'); });
    $('#searchHistory').on('keyup', function() { applyFilters('history'); });

    // ì–‘ìª½ í•„í„°ë§ í•¨ìˆ˜ (ì´ë¦„ í´ë¦­ ì‹œ)
    function filterBothSides(event, name) {
        event.preventDefault();
        event.stopPropagation();

        // ì´ë¦„ ê²€ìƒ‰ ì‹œì—ëŠ” í•„í„°ë¥¼ ì ì‹œ êº¼ì¤ë‹ˆë‹¤ (ì•ˆ ê·¸ëŸ¬ë©´ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŒ)
        $('#filterPersonNoEmail').prop('checked', false); 
        $('#filterHistoryNoEmail').prop('checked', false);
        // ë‹¨, 'í˜„ì›ë§Œ ë³´ê¸°'ëŠ” ìœ ì§€í•´ë„ ë¨ (ì–´ì°¨í”¼ í˜„ì› ì´ë¦„ì„ í´ë¦­í–ˆì„ í…Œë‹ˆê¹Œ)
        
        $('#searchPerson').val(name);
        applyFilters('person');

        $('#searchHistory').val(name);
        applyFilters('history');
    }

    // ìš”ì› ì„ íƒ ì´ë²¤íŠ¸
    $('.person-item').click(function() {
        $('.person-item').removeClass('active bg-dark text-white');
        $(this).addClass('active bg-dark text-white');
        
        selectedPersonId = $(this).data('id');
        const name = $(this).data('name');
        const email = $(this).data('email');
        
        $('#dispPerson').val(name);
        if(email && email !== 'None') $('#matchEmail').val(email);
        else $('#matchEmail').val('');
        
        // ìë™ ê²€ìƒ‰ ì‹œì—ëŠ” í•„í„° í•´ì œ
        $('#searchHistory').val(name);
        $('#filterHistoryNoEmail').prop('checked', false); 
        // í˜„ì› í•„í„°ëŠ” ì¼œë†”ë„ ë¬´ë°©í•¨
        applyFilters('history');
        autoCheckHistory(name);
        
        updateMatchButtonState();
    });

    // ìë™ ì²´í¬
    function autoCheckHistory(targetName) {
        const searchVal = targetName.replace(/\s+/g, '');
        $('.history-checkbox').prop('checked', false);
        
        $('.history-item-row:visible').each(function() {
            const hName = $(this).data('name').toString().replace(/\s+/g, '');
            if (hName.includes(searchVal)) {
                $(this).find('.history-checkbox').prop('checked', true);
                const hEmail = $(this).find('.history-checkbox').data('email');
                if(!$('#matchEmail').val() && hEmail && hEmail !== 'None') {
                    $('#matchEmail').val(hEmail);
                }
            }
        });
        updateSelectedCount();
    }

    $(document).on('change', '.history-checkbox', function() {
        updateSelectedCount();
        updateMatchButtonState();
    });

    function updateSelectedCount() {
        const checkedCount = $('.history-checkbox:checked:visible').length;
        $('#selectedCountBadge').text(checkedCount + "ê±´ ì„ íƒë¨");
    }

    function updateMatchButtonState() {
        const email = $('#matchEmail').val();
        const checkedCount = $('.history-checkbox:checked:visible').length;
        if (selectedPersonId && checkedCount > 0) {
            $('#btnMatch').prop('disabled', false);
        } else {
            $('#btnMatch').prop('disabled', true);
        }
    }
    
    $('#matchEmail').on('keyup', function() { updateMatchButtonState(); });

    // ë§¤ì¹­ ì‹¤í–‰
    function executeMatch() {
        const email = $('#matchEmail').val().trim();
        if(!email) { alert('ì—°ê²°í•  ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); $('#matchEmail').focus(); return; }

        const selectedIds = [];
        $('.history-checkbox:checked:visible').each(function() {
            selectedIds.push($(this).val());
        });

        if(selectedIds.length === 0) { alert('ì„ íƒëœ êµìœ¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        if(!confirm(`ì„ íƒëœ ${selectedIds.length}ê±´ì˜ êµìœ¡ ì´ë ¥ì„\nì´ë©”ì¼ [${email}]ë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        $.post('/api/confirm_match', {
            p_id: selectedPersonId,
            email: email,
            h_ids: selectedIds.join(',')
        }, function(res) {
            if(res.status === 'success') {
                alert(res.msg);
                location.reload(); 
            } else {
                alert('ì˜¤ë¥˜: ' + res.msg);
            }
        });
    }
</script>
{% endblock %}