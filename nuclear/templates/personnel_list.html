{% extends "base.html" %}

{% block content %}
<style>
    /* [ì‹ ê·œ] í…Œì´ë¸” í—¤ë” ê³ ì • ìŠ¤íƒ€ì¼ */
    #personnelTable thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa; /* í—¤ë” ë°°ê²½ìƒ‰ (table-lightì™€ ë™ì¼) */
        z-index: 10; /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* ì‚´ì§ ê·¸ë¦¼ì */
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ğŸ“‹ ë°©ì¬ìš”ì› ì§€ì • ë° ì´ìˆ˜ ê´€ë¦¬</h2>
    
    <form class="d-flex gap-2" action="{{ url_for('personnel_list') }}">
        <select name="target_year" class="form-select fw-bold text-primary" style="width: 140px;" onchange="this.form.submit()">
            {% for y in years %}
                <option value="{{ y }}" {% if y == target_year %}selected{% endif %}>{{ y }}ë…„ ê¸°ì¤€</option>
            {% endfor %}
        </select>

        <select name="set_id" class="form-select" style="min-width: 250px;" onchange="this.form.submit()">
            {% for s in sets %}
            <option value="{{ s[0] }}" {% if s[0] == current_set_id %}selected{% endif %}>{{ s[1] }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-start border-4 border-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-bold">ì´ ëŒ€ìƒ ì¸ì›</h6>
                        <h2 class="mb-0 fw-bold">{{ stats.total }}ëª…</h2>
                    </div>
                    <div class="text-dark opacity-25">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <span class="badge bg-info text-dark border border-info-subtle">
                        ğŸŒ± ì‹ ê·œ: {{ stats.new }}ëª…
                    </span>
                    <span class="badge bg-secondary border border-secondary-subtle">
                        ğŸ”„ ë³´ìˆ˜: {{ stats.refresher }}ëª…
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-start border-4 border-success h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-success text-uppercase mb-1 small fw-bold">êµìœ¡ ì´ìˆ˜ ì™„ë£Œ</h6>
                    <h2 class="mb-0 fw-bold text-success">{{ stats.completed }}ëª…</h2>
                    <small class="text-muted">(ë¯¸ì´ìˆ˜: {{ stats.uncompleted }}ëª…)</small>
                </div>
                <div class="text-success opacity-25">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-start border-4 border-primary h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-primary text-uppercase mb-0 small fw-bold">êµìœ¡ ì´ìˆ˜ìœ¨</h6>
                    <h2 class="mb-0 fw-bold text-primary">{{ stats.rate }}%</h2>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: {{ stats.rate }}%" 
                         aria-valuenow="{{ stats.rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card p-3 mb-3 bg-light border-0">
    <div class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-dark" onclick="openAddModal()">
            ğŸ‘¤ ê°œë³„ ë“±ë¡
        </button>
        
        <div class="vr mx-2"></div>
        
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#personnelModal">
            ğŸ“„ â‘  ì¼ê´„ ë“±ë¡(Excel)
        </button>
        
        <button type="button" class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#trainingModal">
            ğŸ“ â‘¡ êµìœ¡ ê²°ê³¼ ë“±ë¡
        </button>
        
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#deptOrderModal">
            ğŸ”¢ ë¶€ì„œ ìˆœì„œ
        </button>
        
        <a href="{{ url_for('download_excel', set_id=current_set_id, target_year=target_year) }}" class="btn btn-success ms-auto">
            ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </a>
    </div>
</div>

<div class="card p-3 shadow-sm">
    <table id="personnelTable" class="table table-bordered table-hover" style="width:100%">
        <thead class="table-light">
            <tr>
                <th class="text-center">ë¶€ì„œ</th>
                <th class="text-center">ì§ê¸‰</th>
                <th class="text-center">ì´ë¦„</th>
                <th class="text-center">ì—°ë½ì²˜</th>
                <th class="text-center">ë¹„ìƒì‹œì§ìœ„</th>
                <th class="text-center">ì§€ì •ì¼ì</th>
                <th class="text-center">êµìœ¡êµ¬ë¶„</th>
                <th class="text-center">ì´ìˆ˜í˜„í™©</th>
                <th class="text-center">ìµœê·¼ êµìœ¡ì¼</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr>
                <td>{{ row.dept }}</td>
                <td>{{ row.position }}</td>
                <td class="fw-bold text-center">
                    <a href="javascript:void(0)" onclick="openEditModal({{ row.id }})" 
                       class="text-decoration-none text-primary fw-bold" title="ìƒì„¸ ì •ë³´ ë° ìˆ˜ì •">
                        {{ row.name }}
                    </a>
                </td>
                <td class="text-center">{{ row.phone }}</td>
                <td class="text-center">{{ row.emergency_role }}</td>
                <td class="text-center">{{ row.designation_date or '-' }}</td>
                <td class="text-center">{{ row.edu_type_calc }}</td>
                <td class="text-center">
                    {% if 'ì´ìˆ˜' in row.status %}
                        <span class="badge bg-success rounded-pill">{{ row.status }}</span>
                    {% elif row.status == '6ê°œì›” ì´ë‚´' %}
                        <span class="badge bg-warning text-dark rounded-pill">6ê°œì›” ì´ë‚´</span>
                    {% else %}
                        <span class="badge bg-danger rounded-pill bg-opacity-75">ë¯¸ì´ìˆ˜</span>
                    {% endif %}
                </td>
                <td class="text-center small">{{ row.training_date or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="personnelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('upload_action') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="type" value="personnel">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“„ ì¸ì‚¬ë°œë ¹ ëª…ë‹¨ ì¼ê´„ ë“±ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ëª…ë‹¨ ì´ë¦„ (ì˜ˆ: 2026ë…„ ìƒë°˜ê¸° ì •ê¸°ì¸ì‚¬)</label>
                        <input type="text" name="set_name" class="form-control" required placeholder="ì‹ë³„í•˜ê¸° ì‰¬ìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì—‘ì…€ íŒŒì¼ (*.xlsx)</label>
                        <input type="file" name="file" class="form-control" required accept=".xlsx, .xls">
                    </div>
                    <div class="alert alert-info small">
                        <strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong> ì´ë¦„, ë¶€ì„œ(ë˜ëŠ” ì†Œì†), ì—°ë½ì²˜(ë˜ëŠ” íœ´ëŒ€ì „í™”)<br>
                        <strong>ì„ íƒ ì»¬ëŸ¼:</strong> ì§ê¸‰, ë¹„ìƒì‹œì§ìœ„, ì§€ì •ì¼ì, ì´ë©”ì¼
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="trainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('upload_action') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="type" value="training">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“ êµìœ¡ ì´ìˆ˜ ê²°ê³¼ ë“±ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">êµìœ¡ ê²°ê³¼ ì—‘ì…€ íŒŒì¼</label>
                        <input type="file" name="file" class="form-control" required accept=".xlsx, .xls">
                    </div>
                    <div class="alert alert-warning small">
                        <strong>ì£¼ì˜:</strong><br>
                        - 'ì´ë¦„', 'ë¶€ì„œ', 'êµìœ¡ì¼' ì»¬ëŸ¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.<br>
                        - íœ´ëŒ€í° ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ë” ì •í™•í•˜ê²Œ ë§¤ì¹­ë©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning text-white">ê²°ê³¼ ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deptOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('upload_action') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="type" value="dept_order">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ”¢ ë¶€ì„œ ì •ë ¬ ìˆœì„œ ë“±ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ìˆœì„œ íŒŒì¼ (ì—‘ì…€)</label>
                        <input type="file" name="file" class="form-control" required accept=".xlsx, .xls">
                        <div class="form-text mt-2">
                            Aì—´ì— ë¶€ì„œëª…ì„ ìˆœì„œëŒ€ë¡œ ì ì–´ì„œ ì—…ë¡œë“œí•˜ë©´,<br>
                            ëª…ë‹¨ ì¡°íšŒ ì‹œ í•´ë‹¹ ìˆœì„œëŒ€ë¡œ ë¶€ì„œê°€ ì •ë ¬ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-secondary">ì—…ë¡œë“œ</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="manageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalTitle">ğŸ‘¤ ìš”ì› ì •ë³´ ê´€ë¦¬</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7 border-end">
                        <form id="manageForm">
                            <input type="hidden" name="p_id" id="p_id">
                            <input type="hidden" name="set_id" value="{{ current_set_id }}">
                            
                            <div class="mb-2">
                                <label class="form-label small fw-bold">ë¶€ì„œ</label>
                                <input type="text" class="form-control" name="dept" id="dept" required>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label class="form-label small fw-bold">ì§ê¸‰</label>
                                    <input type="text" class="form-control" name="position" id="position">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small fw-bold">ì´ë¦„</label>
                                    <input type="text" class="form-control" name="name" id="name" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label class="form-label small fw-bold">ì—°ë½ì²˜</label>
                                    <input type="text" class="form-control" name="phone" id="phone" placeholder="010-0000-0000">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small fw-bold">ì´ë©”ì¼</label>
                                    <input type="email" class="form-control" name="email" id="email" placeholder="@korea.kr">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="form-label small fw-bold">ë¹„ìƒì‹œ ì§ìœ„/ì„ë¬´</label>
                                <select class="form-select" name="emergency_role" id="emergency_role">
                                    <option value="">(ì„ íƒ)</option>
                                    <option value="ì¢…í•©ì¡°ì •ë°˜">ì¢…í•©ì¡°ì •ë°˜</option>
                                    <option value="ìš´ì˜ì§€ì›ë°˜">ìš´ì˜ì§€ì›ë°˜</option>
                                    <option value="ìì›ê´€ë¦¬ë°˜">ìì›ê´€ë¦¬ë°˜</option>
                                    <option value="ì•ˆì „ê´€ë¦¬ë°˜">ì•ˆì „ê´€ë¦¬ë°˜</option>
                                    <option value="ì£¼ë¯¼ë³´í˜¸ë°˜">ì£¼ë¯¼ë³´í˜¸ë°˜</option>
                                    <option value="ì˜ë£Œì§€ì›ë°˜">ì˜ë£Œì§€ì›ë°˜</option>
                                    <option value="í™˜ê²½ê´€ë¦¬ë°˜">í™˜ê²½ê´€ë¦¬ë°˜</option>
                                    <option value="í™ë³´í˜‘ë ¥ë°˜">í™ë³´í˜‘ë ¥ë°˜</option>
                                    <option value="ì‹ ì„±ë™">ì‹ ì„±ë™</option>
                                    <option value="êµ¬ì¦‰ë™">êµ¬ì¦‰ë™</option>
                                    <option value="ê´€í‰ë™">ê´€í‰ë™</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">ë°©ì¬ìš”ì› ì§€ì •ì¼ì</label>
                                <input type="date" class="form-control" name="designation_date" id="designation_date">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" onclick="saveData()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                                <button type="button" class="btn btn-outline-danger btn-sm mt-2" id="btnDelete" onclick="deletePerson()">
                                    ğŸ—‘ï¸ ëª…ë‹¨ì—ì„œ ì‚­ì œ
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="col-md-5" id="historySection">
                        <h6 class="text-success fw-bold mb-3">ğŸ“ êµìœ¡ ì´ë ¥ (ìµœê·¼ 5ë…„)</h6>
                        <div class="table-responsive bg-white border rounded" style="max-height: 350px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0 small text-center">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>êµìœ¡ì¼ì</th>
                                        <th>ì—°ë„</th>
                                        <th>êµ¬ë¶„</th>
                                        <th>ì‹œê°„</th>
                                        <th>ì¬ë‚œ</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-muted" style="font-size: 0.75rem;">
                            * ìë™ ë§¤ì¹­ ê¸°ì¤€: ì´ë©”ì¼ ì¼ì¹˜ (ìµœìš°ì„ )
                        </div>
                    </div>

                    <div class="col-md-7 d-flex align-items-center justify-content-center text-muted" id="newInfoSection" style="display:none;">
                        <div class="text-center">
                            <h1 class="display-4">ğŸ†•</h1>
                            <p>ìƒˆë¡œìš´ ìš”ì›ì„ ë“±ë¡í•©ë‹ˆë‹¤.<br>êµìœ¡ ì´ë ¥ì€ ì €ì¥ í›„ ìë™ ë§¤ì¹­ë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function () {
        // [ìˆ˜ì •] ìŠ¤í¬ë¡¤ ì˜µì…˜ ì œê±° (ë¸Œë¼ìš°ì € ìŠ¤í¬ë¡¤ ì‚¬ìš©)
        $('#personnelTable').DataTable({
            "paging": false,
            "info": true,
            // "scrollY": "600px",  <-- ì œê±°ë¨
            // "scrollCollapse": true, <-- ì œê±°ë¨
            "language": {
                "search": "ê²€ìƒ‰:",
                "info": "ì´ _TOTAL_ëª…ì˜ ìš”ì›",
                "zeroRecords": "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
            },
            "order": [] 
        });
    });

    const modalEl = document.getElementById('manageModal');
    const modal = new bootstrap.Modal(modalEl);

    // 1. [ë“±ë¡] ëª¨ë‹¬ ì—´ê¸°
    function openAddModal() {
        $('#manageForm')[0].reset();
        $('#p_id').val('');
        $('#email').val(''); // ì´ë©”ì¼ ì´ˆê¸°í™”
        
        $('#modalTitle').text('ğŸ†• ì‹ ê·œ ìš”ì› ë“±ë¡');
        $('#btnDelete').hide();
        $('#historySection').hide();
        $('#newInfoSection').show();
        
        modal.show();
    }

    // 2. [ìˆ˜ì •] ëª¨ë‹¬ ì—´ê¸° (ì´ë¦„ í´ë¦­ì‹œ)
    function openEditModal(id) {
        $.get('/api/personnel/' + id, function(data) {
            const p = data.person;
            const h = data.history;
            
            // í¼ ë°ì´í„° ì±„ìš°ê¸°
            $('#p_id').val(p.id);
            $('#dept').val(p.dept);
            $('#position').val(p.position);
            $('#name').val(p.name);
            $('#phone').val(p.phone);
            $('#email').val(p.email); // ì´ë©”ì¼ ì±„ìš°ê¸°
            $('#emergency_role').val(p.emergency_role);
            $('#designation_date').val(p.designation_date);
            
            // UI ì„¤ì •
            $('#modalTitle').text('âœï¸ ìš”ì› ì •ë³´ ìˆ˜ì •');
            $('#btnDelete').show();
            $('#newInfoSection').hide();
            
            // ì´ë ¥ í…Œì´ë¸” ì±„ìš°ê¸°
            const tbody = $('#historyTableBody');
            tbody.empty();
            if (h.length === 0) {
                tbody.append('<tr><td colspan="5" class="text-muted py-3">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            } else {
                h.forEach(row => {
                    let safetyMark = row.safety_status === 'O' ? '<span class="text-danger fw-bold">O</span>' : '-';
                    let html = `
                        <tr>
                            <td>${row.training_date}</td>
                            <td>${row.training_year}</td>
                            <td>${row.training_type}</td>
                            <td>${row.hours}</td>
                            <td>${safetyMark}</td>
                        </tr>
                    `;
                    tbody.append(html);
                });
            }
            
            modal.show();
        });
    }

    // 3. ì €ì¥
    function saveData() {
        const pId = $('#p_id').val();
        const url = pId ? '/api/personnel/update' : '/api/personnel/add';
        const msg = pId ? 'ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
        
        if(!$('#name').val()) { alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if(!confirm(msg)) return;
        
        $.post(url, $('#manageForm').serialize(), function(res) {
            if(res.status === 'success') {
                alert(res.msg);
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + res.msg);
            }
        });
    }

    // 4. ì‚­ì œ
    function deletePerson() {
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const pId = $('#p_id').val();
        
        $.post('/api/personnel/delete', {p_id: pId}, function(res) {
            if(res.status === 'success') {
                alert(res.msg);
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + res.msg);
            }
        });
    }
</script>
{% endblock %}