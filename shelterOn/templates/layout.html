<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ìœ ì„±ì‰˜í„°{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    {% block head %}{% endblock %}
</head>
<body>
    {% if session.logged_in %}
    <div class="user-bar">
		<div>
			<a href="/"><img src="/static/images/logo.png" alt="ìœ ì„±êµ¬ì²­" style="height: 36px;"></a>
		</div>
		{% if session.shelter_name %}
		<div style="font-weight: bold; color: #e67e22;">
			ğŸ›ï¸ {{ session.shelter_name }}
			{% if session.mission %}
				<span class="badge">{{ session.mission }}</span>
			{% endif %}
		</div>
		{% endif %}
		
		<div style="display: flex; gap: 10px; align-items: center;">
			<strong>{{ session.user_name }}</strong>
			{% if session.shelter_id %}
				<a href="/finish_work" 
				   onclick="return confirm('ì˜¤ëŠ˜ ê·¼ë¬´ë¥¼ ì¢…ë£Œí•˜ê³  ê¸°ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
				   style="text-decoration:none; font-size:12px; color:#e74c3c; font-weight:bold; border:1px solid #e74c3c; padding:2px 6px; border-radius:4px;">
				   ê·¼ë¬´ì¢…ë£Œ
				</a>
			{% endif %}
			<button onclick="toggleAdminMenu()" style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 5px;" title="ê´€ë¦¬ì ë©”ë‰´ í† ê¸€">âš™ï¸</button>
    
			<div id="admin-menu-group" style="display: none; align-items: center; gap: 10px; background: #f8fafc; padding: 2px 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-left: 5px;">
			{% if session.role == 2 %} 
				<a href="/admin/resident/export_excel" class="btn-excel">ğŸ“¥ ì´ì¬ë¯¼ ì—‘ì…€ ì €ì¥</a>
				<a href="/admin/staff" class="nav-link" title="ê·¼ë¬´ì(ëª…ë ¹) ê´€ë¦¬" style="font-size: 0.85rem;">ğŸ‘· ê·¼ë¬´ì</a>
			{% endif %}
			{% if session.role == 1 %} 
				<a href="/admin/resident/export_excel" class="btn-excel">ğŸ“¥ ì´ì¬ë¯¼ ì—‘ì…€ ì €ì¥</a>
				<a href="/admin/staff" class="nav-link" title="ê·¼ë¬´ì(ëª…ë ¹) ê´€ë¦¬" style="font-size: 0.85rem;">ğŸ‘· ê·¼ë¬´ì</a>
                <a href="/db_explorer" class="nav-link" title="DB ê´€ë¦¬" style="font-size: 0.85rem;">ğŸ—„ï¸ DB</a>
				<a href="/logs" class="nav-link" title="ì‹œìŠ¤í…œ ë¡œê·¸" style="font-size: 0.85rem;">ğŸ“œ ë¡œê·¸</a>
				<a href="/upload" class="nav-link" title="íŒŒì¼ ì—…ë¡œë“œ" style="font-size: 0.85rem;">ğŸ“‚ ì†ŒìŠ¤</a>
			{% endif %}
			</div>
			<a href="/logout" style="text-decoration:none; font-size:12px; color:#e74c3c; font-weight:bold; border:1px solid #e74c3c; padding:2px 6px; border-radius:4px;">ë¡œê·¸ì•„ì›ƒ</a>
		</div>
	</div>
    {% endif %}

    <div class="container">
        {% block content %}{% endblock %}
	</div>
<div id="notification-panel" style="position: fixed; bottom:-140px; background: white; border-radius: 15px 15px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); z-index: 1000; height: 180px; display: flex; flex-direction: column; transition: height 0.3s ease;">
    <div id="panel-resizer" onclick="togglePanel(event)" style="height: 45px; background: #2c3e50; color: white; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0 15px;">
        <div style="width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%);"></div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <span id="toggle-icon">â–²</span>
            <span style="font-weight: bold; font-size: 0.9rem;">ğŸ“¢ ì‹¤ì‹œê°„ ìƒí™© ì•Œë¦¼</span>
        </div>
        <button onclick="clearNotifications(event)" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; cursor: pointer;">ë¹„ìš°ê¸°</button>
    </div>
    <div id="notification-list" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
        <div class="empty-msg" style="text-align:center; color:#94a3b8; margin-top:30px;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
</div>
<style>
#notification-panel {
    position: fixed;
    bottom: 0px; /* ë„¤ë¹„ê²Œì´ì…˜ë°” ë°”ë¡œ ìœ„ */
    left: -1px; right: -1px;
    background: #ffffff;
    border: 1px solid #ced4da;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    min-height: 45px;
    max-height: 80vh;
    height: 150px; /* ê¸°ë³¸ ë†’ì´ */
    transition: transform 0.3s;
}

#panel-resizer {
    height: 45px;
    background: #2c3e50;
    color: white;
    cursor: ns-resize; /* ìœ„ì•„ë˜ ë“œë˜ê·¸ ì•„ì´ì½˜ */
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 10px 10px 0 0;
    position: relative;
}

.handle-line {
    width: 40px; height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
    position: absolute; top: 8px;
}

#notification-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
}

.noti-item {
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 5px solid #3498db;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

@keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// --- ê´€ë¦¬ì ë©”ë‰´ í† ê¸€ ë¡œì§ ---
function toggleAdminMenu() {
    const adminMenu = document.getElementById('admin-menu-group');
    if (adminMenu.style.display === 'none' || adminMenu.style.display === '') {
        adminMenu.style.display = 'flex'; // ë©”ë‰´ ë³´ì´ê¸°
    } else {
        adminMenu.style.display = 'none'; // ë©”ë‰´ ìˆ¨ê¸°ê¸°
    }
}
// ì•Œë¦¼ì°½ í† ê¸€ ë¡œì§
const panel = document.getElementById('notification-panel');
const toggleIcon = document.getElementById('toggle-icon');
let isCollapsed = true;

function togglePanel(event) {
    // ë¹„ìš°ê¸° ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” í† ê¸€ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
    if (event.target.tagName === 'BUTTON') return;

    const panel = document.getElementById('notification-panel');
    const icon = document.getElementById('toggle-icon');
    
    if (!isCollapsed) {
        panel.style.bottom = '-140px';
        icon.innerText = 'â–²';
        isCollapsed = true;
    } else {
        panel.style.bottom = '-1px';
        icon.innerText = 'â–¼';
        isCollapsed = false;
    }
}
const socket = io(); 

// 2. ì—°ê²° í™•ì¸ ë¡œê·¸
socket.on('connect', () => {
	console.log("âœ… ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: " + socket.id + ")");
});

socket.on('disconnect', () => {
	console.log("âŒ ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
});

socket.on('sys_notification', (data) => {
	console.log("ğŸ“¢ ì†Œì¼“ ì•Œë¦¼:", data);
	handleNotification(data);
});

// 4. í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì•Œë¦¼ ë Œë”ë§
document.addEventListener("DOMContentLoaded", () => {
	// 1. ê¸°ì¡´ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
	const saved = JSON.parse(localStorage.getItem('shelter_notifications') || '[]');
	renderNotifications(saved);

	// 2. ì„œë²„ì—ì„œ ë³´ë‚¸ Flash ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸ (Jinja2 ë¬¸ë²•)
	{% with messages = get_flashed_messages(with_categories=true) %} 
		{% if messages %}
			{% for category, message in messages %}
				// ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì•„ì´ì½˜/ìƒ‰ìƒ ê²°ì •
				let icon = 'ğŸ“¢';
				let color = '#3498db'; // ê¸°ë³¸ íŒŒë‘

				if ("{{ category }}" === "error") {
					icon = 'âŒ';
					color = '#e74c3c'; // ë¹¨ê°•
				} else if ("{{ category }}" === "warning") {
					icon = 'âš ï¸';
					color = '#f1c40f'; // ë…¸ë‘
				} else if ("{{ category }}" === "success") {
					icon = 'âœ…';
					color = '#2ecc71'; // ì´ˆë¡
				}

				// ê°€ì§œ ì•Œë¦¼ ê°ì²´ ìƒì„±
				const flashNoti = {
					message: message,
					time: new Date().toLocaleTimeString('ko-KR', {hour12: false}),
					type: "{{ category }}", // ì €ì¥ìš© íƒ€ì…
					color: color,           // UIìš© ìƒ‰ìƒ
					icon: icon              // UIìš© ì•„ì´ì½˜
				};
				
				// ì•Œë¦¼ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
				handleNotification(flashNoti);
			{% endfor %}
		{% endif %}
	{% endwith %}
});

// [UI í•¨ìˆ˜] ì•Œë¦¼ ëª©ë¡ ê·¸ë¦¬ê¸°
function renderNotifications(dataArray) {
	const notiList = document.getElementById('notification-list');
	if (!notiList) return;

	if (dataArray.length === 0) {
		notiList.innerHTML = '<div class="empty-msg" style="text-align:center; color:#94a3b8; margin-top:30px;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
		return;
	}
	notiList.innerHTML = dataArray.map(data => {
        // ë°ì´í„°ì— ì €ì¥ëœ ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        const borderCol = data.color || '#3498db'; 
        const icon = data.icon || '';
        
        return `
            <div style="background:white; padding:12px; border-radius:10px; margin-bottom:10px; border-left:5px solid ${borderCol}; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <strong style="font-size:0.9rem;">${icon} ${data.message}</strong>
                    <small style="color:#999;">${data.time}</small>
                </div>
            </div>
        `;
    }).join('');
}

function handleNotification(data) {
	// 1. ì €ì¥
	let saved = JSON.parse(localStorage.getItem('shelter_notifications') || '[]');
	saved.unshift(data);
	if (saved.length > 50) saved.pop();
	localStorage.setItem('shelter_notifications', JSON.stringify(saved));

	// 2. ë Œë”ë§
	renderNotifications(saved);
	/*
	// 3. íŒ¨ë„ ì—´ê¸°
	const panel = document.getElementById('notification-panel');
	const icon = document.getElementById('toggle-icon');
	if (panel) {
		panel.style.bottom = '-1px';
		if(icon) icon.innerText = 'â–¼';
	}
	*/
}


// 4. ì•Œë¦¼ ë¹„ìš°ê¸°
function clearNotifications() {
    if (confirm('ëª¨ë“  ì•Œë¦¼ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('shelter_notifications');
        renderNotifications([]);
    }
}

</script>
    


</body>
</html>