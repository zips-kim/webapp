{% extends "layout.html" %}

{% block title %}ğŸ  ìœ ì„±ì‰˜í„° (Shelter-On){% endblock %}

{% block content %}

        <div class="card">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">ğŸ‘¥ ì´ì¬ë¯¼ ê´€ë¦¬</h2>
				
                <button onclick="openModal('residentAddModal')" style="background:#3498db; width:auto; padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap;">â• ì´ì¬ë¯¼ ë“±ë¡</button>

            </div>
            
			<div style="display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 10px;">
				<a href="{{ url_for('admin_resident', status='IN', search=search_keyword) }}" 
				   style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: bold; {{ 'background: white; color: #3498db; box-shadow: 0 2px 4px rgba(0,0,0,0.1);' if current_status == 'IN' else 'color: #666;' }}">
				   ğŸ  ì…ì†Œì¤‘
				</a>
				<a href="{{ url_for('admin_resident', status='HOSPITAL', search=search_keyword) }}" 
				   style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: bold; {{ 'background: white; color: #e74c3c; box-shadow: 0 2px 4px rgba(0,0,0,0.1);' if current_status == 'HOSPITAL' else 'color: #666;' }}">
				   ğŸ¥ ë³‘ì›ì´ì†¡
				</a>
				<a href="{{ url_for('admin_resident', status='OUT', search=search_keyword) }}" 
				   style="flex: 1; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: bold; {{ 'background: white; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.1);' if current_status == 'OUT' else 'color: #666;' }}">
				   ğŸšª í‡´ì†Œì™„ë£Œ
				</a>
			</div>

			<form action="/admin/resident" method="get" id="searchForm" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
				<input type="hidden" name="status" value="{{ current_status }}">
				
				<div style="display: flex; gap: 5px;">
					<select name="shelter_id" onchange="this.form.submit()" class="search-input" style="flex: 1; margin-bottom: 0; background-color: white;" {% if session.role == 3 %}disabled{% endif %}>
						<option value="">ì „ì²´ êµ¬í˜¸ì†Œ</option>
						{% for s in all_shelters_list %}
						<option value="{{ s[0] }}" {% if current_shelter == s[0]|string %}selected{% endif %}>{{ s[1] }}</option>
						{% endfor %}
					</select>
					
					<div style="flex: 2; position: relative; display: flex; align-items: center;">
						<input type="text" name="search" id="searchInput" value="{{ search_keyword }}" placeholder="ì´ë¦„, ì—°ë½ì²˜ ê²€ìƒ‰..." class="search-input" style="width: 100%; margin-bottom: 0; padding-right: 35px;">
						
						{% if search_keyword %}
						<span onclick="clearSearch()" style="position: absolute; right: 10px; cursor: pointer; color: #999; font-weight: bold; font-size: 18px;">Ã—</span>
						{% endif %}
					</div>
					
					<button type="submit" style="width: 60px; background: #2c3e50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">ê²€ìƒ‰</button>
				</div>
			</form>
            
						
						<div class="mobile-card-container">
						{% if residents %}
							{% set ns = namespace(last_family_id=None) %}
							{% for r in residents %}
							
							
							
							<div class="data-card">
							<!--
								{# [í•µì‹¬] ê°€ì¡± IDê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ì²´í¬í•˜ì—¬ ê·¸ë£¹ í—¤ë” í‘œì‹œ #}
							{% if r.family_id != ns.last_family_id and r.family_id %}
								<div style="padding: 10px 15px; background:#e9ecef; border-left: 5px solid #2c3e50; margin: 0px 0 10px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
									<span style="font-weight:bold; color:#2c3e50;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì½”ë“œ: {{ r.family_id }}</span>
									<button onclick="copyToClipboard('{{ r.family_id }}')" style="font-size:11px; padding:2px 8px; background:#6c757d; color:white; border:none; border-radius:3px;">ì½”ë“œë³µì‚¬</button>
								</div>
								{# ë³€ìˆ˜ ì—…ë°ì´íŠ¸: ì—ëŸ¬ê°€ ë°œìƒí•˜ë˜ ë¶€ë¶„ì„ namespaceë¡œ ëŒ€ì²´ #}
								{% set ns.last_family_id = r.family_id %}
							{% endif %}
							-->
							
								<div class="card-title">
									<!--{% if r.family_id and r.family_role %} [{{ r.family_role }}] {% else %} {% endif %}-->
									{{ r.name }} ({{ r.gender }}, {{ r.age[:4] if r.age else '' }})<br>
									<small>{{ r.phone }}</small>
								</div>

								<div class="card-info">{{ r.shelter_name }}</div>
								<div style="padding: 0px 0px 10px 0px; background: #f8fafc; border-radius: 8px;">
										
									<div style="margin: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
									{% if r.received_items %}
											{% for item in r.received_items.split(',') %}
											{% set parts = item.split(':') %}
											<span style="background: #ebf5fb; color: #2980b9; padding: 2px 8px; border-radius: 12px; font-size: 12px; border: 1px solid #3498db;">
												{{ parts[0] }}
												<a href="/cancel_resident_distribute/{{ parts[2] }}" style="color: #e74c3c; text-decoration: none; margin-left: 5px; font-weight: bold;">Ã—</a>
											</span>
											{% endfor %}
										{% endif %}
									</div>
									
									<form action="/distribute" method="post" style="display: flex; gap: 3px;">ğŸ“¦ 
										<input type="hidden" name="res_id" value="{{ r.id }}">
										<select name="sup_id" required style="flex:1; font-size:12px; height:32px;min-width:50%;">
											<option value="">+ êµ¬í˜¸ë¬¼í’ˆ</option>
											{# í•´ë‹¹ ì´ì¬ë¯¼ì˜ êµ¬í˜¸ì†Œ ID(r.shelter_id)ì— í•´ë‹¹í•˜ëŠ” ë¬¼í’ˆë§Œ ì¶œë ¥ #}
											{% if shelter_supplies[r.shelter_id] %}
												{% for s in shelter_supplies[r.shelter_id] %}
												<option value="{{ s.id }}">{{ s.name }} ({{ s.quantity }}ê°œ ë‚¨ìŒ)</option>
												{% endfor %}
											{% else %}
												<option disabled>ë³´ìœ  ë¬¼í’ˆ ì—†ìŒ</option>
											{% endif %}
										</select>
										<button type="submit" style="width:50px; padding: 2px 6px; background: #27ae60; font-size: 11px;">ì§€ê¸‰</button>
									</form>
									
								</div>
								<div class="card-actions" style="display: flex; gap: 5px; width: 100%;">
			
									{% if current_status == 'IN' %}
										<a href="/update_status/list/{{ r.id }}/{{ r.shelter_id }}/HOSPITAL" 
										   onclick="return confirm('ë³‘ì›ìœ¼ë¡œ ì´ì†¡ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
										   style="flex: 1; text-align: center; background: #2c3e50; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; text-decoration: none; font-size: 13px;">ğŸ¥ ë³‘ì›</a>
										
										<a href="/update_status/list/{{ r.id }}/{{ r.shelter_id }}/OUT" 
										   onclick="return confirm('í‡´ì†Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
										   style="flex: 1; text-align: center; background: #fff; color: #e53e3e; border: 1px solid #e53e3e; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 13px;">ğŸšª í‡´ì†Œ</a>
									
									{% else %}
										<a href="/update_status/list/{{ r.id }}/{{ r.shelter_id }}/IN" 
										   onclick="return confirm('í•´ë‹¹ ì´ì¬ë¯¼ì„ êµ¬í˜¸ì†Œë¡œ ë³µê·€(ì¬ì…ì†Œ) ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
										   style="flex: 1; text-align: center; background: #27ae60; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; text-decoration: none; font-size: 14px;">
										   ğŸ”„ êµ¬í˜¸ì†Œ ë³µê·€(ì¬ì…ì†Œ)
										</a>
									{% endif %}

								</div>
							
						</div>
							{% endfor %}
					{% else %}
						<div>
							<div colspan="4" style="text-align:center; padding: 20px;">í‘œì‹œí•  ì´ì¬ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
						</div>
					{% endif %}
			
		</div>
			
			<div class="pagination" style="display: flex; justify-content: center; gap: 5px; margin-top: 20px;">
				{% if page > 1 %}
				<a href="{{ url_for('admin_resident', page=page-1, status=current_status, shelter_id=current_shelter, search=search_keyword) }}" class="btn-sm" style="text-decoration:none; background:#95a5a6; color:white; padding:5px 10px; border-radius:4px;">&laquo;</a>
				{% endif %}
				
				{% for p in range(1, total_pages + 1) %}
				<a href="{{ url_for('admin_resident', page=p, status=current_status, shelter_id=current_shelter, search=search_keyword) }}" 
				   class="btn-sm" 
				   style="text-decoration:none; padding:5px 10px; border-radius:4px; {% if p == page %}background:#3498db; color:white;{% else %}background:#ecf0f1; color:#333;{% endif %}" >
				   {{ p }}
				</a>
				{% endfor %}
				
				{% if page < total_pages %}
				<a href="{{ url_for('admin_resident', page=page+1, status=current_status, shelter_id=current_shelter, search=search_keyword) }}" class="btn-sm" style="text-decoration:none; background:#95a5a6; color:white; padding:5px 10px; border-radius:4px;">&raquo;</a>
				{% endif %}
			</div>

			<div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
				ì „ì²´ {{ total_pages }} í˜ì´ì§€ ì¤‘ {{ page }} í˜ì´ì§€
			</div>
        </div>


<div id="residentAddModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('residentAddModal')">&times;</span>
        <h3>ğŸ‘¤ ì‹ ê·œ ì´ì¬ë¯¼ ë“±ë¡</h3>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <form action="/add_resident_admin" method="post">
			<div class="form-group" style="margin-bottom: 15px;">
				<label style="display:block; margin-bottom:5px; font-weight:bold;">ê°€êµ¬ êµ¬ë¶„</label>
				<select name="family_role" class="form-control" onchange="toggleHeadPhone(this)" style="width:100%; padding:8px;">
					<option value="ì„¸ëŒ€ì£¼" selected>ğŸ  ì„¸ëŒ€ì£¼ (ëŒ€í‘œ)</option>
					<option value="ì„¸ëŒ€ì›">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ì„¸ëŒ€ì› (ê°€ì¡±)</option>
				</select>
			</div>

			<div id="headPhoneField" class="form-group" style="display:none; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 4px;">
				<label style="display:block; margin-bottom:5px; font-size:0.9em;">ğŸ”— ì—°ê²°í•  ì„¸ëŒ€ì£¼ ì—°ë½ì²˜</label>
				<input type="text" name="head_phone" class="form-control" placeholder="ì„¸ëŒ€ì£¼ì˜ í•¸ë“œí° ë²ˆí˜¸ ì…ë ¥" style="width:100%; padding:8px;">
				<small style="color:#666; font-size:0.8em;">* ì¼ì¹˜í•˜ëŠ” ì„¸ëŒ€ì£¼ê°€ ìˆìœ¼ë©´ ê°™ì€ ê°€ì¡±ìœ¼ë¡œ ë¬¶ì…ë‹ˆë‹¤.</small>
			</div>
            <div style="margin-bottom: 10px;">
                <label style="display:block; font-weight:bold; margin-bottom:5px;">ì„±í•¨</label>
                <input type="text" name="name" required class="search-input" style="width:100%; box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">ì„±ë³„</label>
                    <select name="gender" class="search-input" style="width:100%;">
                        <option value="ë‚¨">ë‚¨ì„±</option>
                        <option value="ì—¬">ì—¬ì„±</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">ìƒë…„ì›”ì¼(8ìë¦¬)</label>
                    <input type="text" name="age" placeholder="19900101" required class="search-input" style="width:100%; box-sizing: border-box;" value="19850102">
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display:block; font-weight:bold; margin-bottom:5px;">ì—°ë½ì²˜</label>
                <input type="text" name="phone" placeholder="010-0000-0000" required class="search-input" style="width:100%; box-sizing: border-box;"  value="010-1234-5678">
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display:block; font-weight:bold; margin-bottom:5px;">ì†Œì† êµ¬í˜¸ì†Œ</label>
                <select name="shelter_id" required class="search-input" style="width:100%;">
                    {% for s in all_shelters_list %}
                    <option value="{{ s[0] }}">{{ s[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-weight:bold; margin-bottom:5px;">ìƒì„¸ ì£¼ì†Œ</label>
                <input type="text" name="village" class="search-input" style="width:100%; box-sizing: border-box;">
            </div>
            <button type="submit" style="width:100%; background:#27ae60; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">ë“±ë¡ ë° ì…ì†Œ ì²˜ë¦¬</button>
        </form>
    </div>
</div>

<script>
// ê²€ìƒ‰ì–´ ì´ˆê¸°í™” ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
function toggleHeadPhone(select) {
    const field = document.getElementById('headPhoneField');
    if (select.value === 'ì„¸ëŒ€ì›') {
        field.style.display = 'block';
    } else {
        field.style.display = 'none';
        field.querySelector('input').value = ''; // ê°’ ì´ˆê¸°í™”
    }
}
function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        document.getElementById('searchForm').submit(); // í¼ ì œì¶œ (ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ)
    }
}
</script>
{% endblock %}