<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¯¼ë³´í˜¸ ê´€ì œ ì‹œìŠ¤í…œ</title>
    <style>
        /* ==========================================================================
           1. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ & ìœ í‹¸ë¦¬í‹°
           ========================================================================== */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #layout-container { display: flex; width: 100%; height: 100vh; }
        .cursor-pointer { cursor: pointer; }
        
        /* ==========================================================================
           2. ì‚¬ì´ë“œë°” (Sidebar)
           ========================================================================== */
        #sidebar {
            width: 280px; top:0px; bottom:-30px; background-color: #f8fafc; border-right: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: width 0.3s ease-in-out;
            display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 1000;
        }
        #sidebar.collapsed { width: 40px; }
        #sidebar.collapsed .sidebar-header-content,
        #sidebar.collapsed .sidebar-content-wrapper { opacity: 0; pointer-events: none; transition: opacity 0.2s; }


        .sidebar-vertical-text {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            writing-mode: vertical-rl; text-orientation: upright;
            font-weight: bold; color: #2c3e50; font-size: 14px; letter-spacing: 5px;
            white-space: nowrap; opacity: 0; transition: opacity 0.3s 0.2s;
        }
        #sidebar.collapsed .sidebar-vertical-text { opacity: 1; pointer-events: auto; }

        .toggle-btn {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; background: #f1f3f5; border: none; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 2001; font-size: 10px; color: #555;
        }
        #sidebar.collapsed .toggle-btn { right: 50%; transform: translateX(50%); top: 10px; }

        .sidebar-header { padding: 15px; height: 40px; display: flex; align-items: center;  }
        .sidebar-header-content { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .sidebar-content-wrapper { flex: 1; overflow-y: auto; }
		
		/* ì‚¬ê³  ëª…ì¹­ í—¤ë” ë””ìì¸ ìˆ˜ì • */
		.incident-name-header {
			background: #f8fafc; /* ì§„í•œ ìƒ‰ì—ì„œ ë°ì€ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
			padding: 12px 15px;
			display: flex;
			align-items: center; /* ê°€ë¡œ ì •ë ¬ */
			gap: 10px;
			border-bottom: 1px solid #e2e8f0;
			overflow: hidden; /* ì˜ì—­ ë„˜ì¹¨ ë°©ì§€ */
		}

		.incident-badge {
			background: #ef4444;
			color: white;
			font-size: 10px;
			font-weight: 900;
			padding: 2px 6px;
			border-radius: 4px;
			flex-shrink: 0; /* ë°°ì§€ í¬ê¸° ê³ ì • */
			letter-spacing: 1px;
			animation: blink 2s infinite;
		}

		.incident-title-text {
			color: #334155; /* ì–´ë‘ìš´ ê·¸ë ˆì´ë¡œ í…ìŠ¤íŠ¸ ê°€ë…ì„± í™•ë³´ */
			font-size: 15px;
			font-weight: 800;
			white-space: nowrap; /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
			overflow: hidden;
			text-overflow: ellipsis; /* ë„ˆë¬´ ê¸¸ë©´ ... ì²˜ë¦¬ */
			line-height: 1;
		}

		/* On Air ê¹œë¹¡ì„ íš¨ê³¼ ìœ ì§€ */
		@keyframes blink {
			0% { opacity: 1; }
			50% { opacity: 0.6; }
			100% { opacity: 1; }
		}

		/* ëŒ€ì‹œë³´ë“œ í†µê³„ ì˜ì—­ê³¼ì˜ ì¼ì²´ê° */
		#sidebar-stats {
			padding: 0px;
			background: #ffffff; /* í†µê³„ ì˜ì—­ë„ ë°ê²Œ ìœ ì§€ */
			border-bottom: 2px solid #e2e8f0;
		}
		.sidebar-stats-list { padding: 15px; }
        
        /* ì‚¬ì´ë“œë°” ì„¹ì…˜ íƒ€ì´í‹€ */
        .panel-section-title {
            font-size: 14px; font-weight: 800; color: #2d3748;
            margin-top: 20px; margin-bottom: 10px; padding: 10px 12px;
            background: #f7fafc; border-radius: 8px;
            display: flex; align-items: center; gap: 8px;
            border-left: 5px solid #cbd5e0; transition: all 0.2s;
        }
        .panel-section-title:first-child { margin-top: 0; }
        .panel-section-title.shelter-title { background: #ebf8ff; border-left-color: #3182ce; color: #2b6cb0; }
        .panel-section-title.assembly-title { background: #fff5f5; border-left-color: #e53e3e; color: #c53030; }

        /* ì‚¬ì´ë“œë°” ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ (ì¹´ë“œí˜•) */
        .marker-item { 
            display: flex; align-items: center; padding: 8px 10px; margin-bottom: 8px; 
            background: #ffffff; border: 1px solid #dddddd; border-radius: 12px; 
            cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.02); 
        }
        .marker-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #cbd5e0; }
        
        .marker-item.inactive { background: #f8f9fa; border-color: transparent; box-shadow: none; opacity: 0.8; }
        .marker-item.hidden-map { opacity: 0.4; filter: grayscale(100%); }

        .marker-icon { 
            width: 20px; height: 28px; object-fit: contain; flex-shrink: 0; margin-right: 12px; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); cursor: pointer; transition: transform 0.2s, filter 0.2s;
        }
        .marker-icon:hover { transform: scale(1.2); filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2)); }
        .marker-item.inactive .marker-icon { filter: grayscale(100%) opacity(0.4); }

        .marker-info-box { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        .marker-name { font-size: 14px; font-weight: 700; color: #2d3748; margin-bottom: 5px; letter-spacing: -0.3px; }
        .marker-item.inactive .marker-name { color: #a0aec0; text-decoration: none; }
        .marker-stats { display: flex; gap: 6px; }

        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .stat-badge, .staff-badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .stat-badge { background: #ebf8ff; color: #3182ce; }
        .staff-badge { background: #f0fff4; color: #38a169; }
        .marker-item.inactive .stat-badge, .marker-item.inactive .staff-badge { background: #edf2f7; color: #a0aec0; }
        .badge-count { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

        /* ==========================================================================
           3. ì§€ë„ ì˜ì—­ (Map Area) & ì˜¤ë²„ë ˆì´
           ========================================================================== */
        #map-area { flex: 1; position: relative; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* ì§€ë„ ë§ˆì»¤ (Custom Overlay) */
        .marker-content { width: 30px; height: 41px; cursor: pointer; transition: transform 0.2s; }
        .marker-content img { width: 100%; height: 100%; display: block; filter: drop-shadow(2px 3px 3px rgba(0,0,0,0.3)); }
        .marker-content:hover, .marker-content.highlight { transform: translateY(-5px); z-index: 100; }
        .marker-content.grayscale img { filter: grayscale(100%) opacity(0.7) drop-shadow(1px 2px 2px rgba(0,0,0,0.2)); }

        /* ì‚¬ì´ë“œë°” ëŒ€ì‹œë³´ë“œ ê°•ì¡° ë””ìì¸ */
		#sidebar-stats {
			padding: 10px 10px;
			background: #f1f5f9; /* ë°°ê²½ìƒ‰ì„ ì‚´ì§ ê¹”ì•„ êµ¬ë³„ */
			border-bottom: 2px solid #e2e8f0;
		}

		.stat-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
		}

		.stat-mini-card {
			background: #ffffff;
			border-radius: 12px;
			padding: 12px;
			display: flex;
			flex-direction: column;
			justify-content: center;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			border-left: 6px solid #ddd; /* ê°•ì¡° ë°” */
			transition: all 0.2s ease;
			cursor: hand;
		}

		.stat-mini-card:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
		}

		/* ìƒíƒœë³„ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
		.stat-residents { border-left-color: #6366f1; } /* ë³´ë¼ */
		.stat-supplies { border-left-color: #10b981; }  /* ì´ˆë¡ */
		.stat-shelters { border-left-color: #3b82f6; }  /* íŒŒë‘ */
		.stat-assemblies { border-left-color: #f59e0b; } /* ì£¼í™© */

		.stat-label {
			font-size: 11px;
			font-weight: 800;
			color: #64748b;
			margin-bottom: 4px;
			display: flex;
			align-items: center;
			gap: 4px;
		}

		.stat-value-row {
			display: flex;
			align-items: baseline;
			justify-content: center;
			gap: 2px;
		}

		.stat-number {
			font-size: 22px;
			font-weight: 900;
			color: #1e293b;
			line-height: 1;
		}

		.stat-unit {
			font-size: 12px;
			font-weight: 600;
			color: #94a3b8;
		}

        /* ë²”ë¡€ & ì—°ê²° ê°€ì´ë“œ */
        .route-legend-container { 
			display:none;
            position: absolute; top: 5px; right: 40px; z-index: 900; 
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); max-height: 80vh; overflow-y: auto; width: 220px; 
        }
        .legend-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .route-item { display: flex; align-items: center; gap: 8px; padding: 6px; margin-bottom: 4px; background: #f8f9fa; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .color-box { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0;}
        .arrow-overlay { font-size: 16px; font-weight: 900; text-shadow: 2px 0 0 #fff, -2px 0 0 #fff, 0 2px 0 #fff, 0 -2px 0 #fff; pointer-events: none; opacity: 1; }
        
        #connect-guide { 
            display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            z-index: 901; background: rgba(44, 62, 80, 0.9); color: white; padding: 8px 16px; 
            border-radius: 30px; font-size: 13px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            animation: slideUp 0.3s ease-out; 
        }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ (ìš°í´ë¦­) */
        #contextMenu { position: absolute; display: none; z-index: 3000; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow: hidden; min-width: 140px; }
        .context-item { padding: 10px 15px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #eee; }
        .context-item:hover { background: #f1f3f5; }

        /* ì¸í¬ìœˆë„ìš° (ì§‘ê²°ì§€ìš©) */
        .iw-container { padding: 5px; text-align: center; min-width: 140px; }
        .iw-title { font-weight: bold; margin-bottom: 8px; display: block; font-size: 14px; }
        .iw-controls { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        .iw-btn-action { 
            border: none; padding: 6px 0; border-radius: 4px; 
            font-size: 11px; font-weight: bold; cursor: pointer; color: white; width: 100%; transition: opacity 0.2s;
        }
        .iw-btn-action:hover { opacity: 0.9; }
        .btn-connect { background-color: #e67e22; }
        .btn-stop { background-color: #e74c3c; }
        .btn-start { background-color: #2ecc71; }

        /* ==========================================================================
           4. ìŠ¬ë¼ì´ë“œ íŒ¨ë„ ê³µí†µ (Detail & Supply)
           ========================================================================== */
        #detail-panel, #supply-panel {
            position: absolute; top: 0; left: 0; bottom: 0; width: 370px;
            background: white; z-index: 999; box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; 
        }
        #detail-panel.open, #supply-panel.open { transform: translateX(0); }
        
        /* íŒ¨ë„ í—¤ë” */
        .detail-header {
            padding: 10px 5px 10px 15px; border-bottom: 1px solid #eee; background: #2c3e50; color: white;
            display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0;
        }
        .detail-header-title-box { flex: 1; min-width: 0; margin-right: 10px; }
        .detail-header h3 { margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .header-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .btn-close-detail { background: none; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.8; }
        .btn-close-detail:hover { opacity: 1; }

        .detail-content { flex: 1; overflow-y: auto; padding: 10px; background: #f8f9fa; }
        .detail-section {
            background: white; border-radius: 8px; padding: 10px 15px 10px 15px; margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #edf2f7;
        }
        .detail-section h4 {
            margin: 0 0 12px 0; font-size: 14px; color: #2d3748;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f3f5; padding-bottom: 8px;
        }
        .detail-list { list-style: none; padding: 0; margin: 0; font-size: 13px; }
        .detail-list li { padding: 8px 0; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between; }
        .detail-list li:last-child { border-bottom: none; }
        .empty-msg { color: #a0aec0; font-size: 12px; text-align: center; padding: 10px; }

        /* [êµ¬í˜¸ì†Œ] ìˆ˜ì •/ì €ì¥ ë²„íŠ¼ & ì¸í’‹ */
        .btn-edit-mode {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.4);
            color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap;
        }
        .btn-edit-mode:hover { background: rgba(255, 255, 255, 0.3); }
        .edit-btn-group { display: flex; gap: 5px; }
        .btn-save-action { background: #27ae60; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; }
        .btn-cancel-action { background: #95a5a6; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; }
        
        .info-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .info-table th { text-align: left; color: #718096; padding: 6px 0; width: 70px; vertical-align: top; }
        .info-table td { padding: 6px 0; color: #2d3748; font-weight: 500; }
        .info-input { padding: 5px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; background: #fff; width: 100%; box-sizing: border-box; }
        
        .view-mode { display: block; }
        .edit-mode { display: none; }
        .editing .view-mode { display: none; }
        .editing .edit-mode { display: block; }

        /* [êµ¬í˜¸ì†Œ] ê´€ë¦¬ì í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(18px); }
        .toggle-label { font-size: 12px; color: white; margin-right: 5px;}

		/* [New] íŒ¨ë„ ë‚´ ë¯¸ë‹ˆ í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
		.mini-pagination {
			display: flex;
			justify-content: center;
			gap: 4px;
			margin-top: 10px;
			padding-top: 10px;
			border-top: 1px dashed #eee;
		}
		.mini-page-btn {
			border: 1px solid #ddd;
			background: white;
			font-size: 11px;
			padding: 3px 8px;
			border-radius: 4px;
			cursor: pointer;
			color: #555;
		}
		.mini-page-btn:hover { background: #f5f5f5; }
		.mini-page-btn.active {
			background: #2c3e50;
			color: white;
			border-color: #2c3e50;
			font-weight: bold;
		}
		.mini-page-btn:disabled {
			opacity: 0.5;
			cursor: default;
		}

        /* [ë¬¼í’ˆ] íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .add-supply-form { background: #ebf8ff; padding: 15px; border-bottom: 1px solid #bee3f8; margin-bottom: 5px; }
        .form-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .form-row input { min-width: 0; padding: 5px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; }
        .btn-add-stock { width: 100%; background: #2c3e50; color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-add-stock:hover { background: #2c5282; }

        /* ë¬¼í’ˆ ì¹´ë“œ ì „ì²´ ì•„ì´í…œ */
		.supply-card-item {
			background: #ffffff;
			border: 1px solid #e2e8f0;
			border-radius: 10px;
			padding: 12px;
			margin-bottom: 10px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.02);
		}

		/* ì¤„ ë ˆì´ì•„ì›ƒ */
		.supply-row-main, .supply-row-sub {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 10px;
		}

		.supply-row-main {
			margin-bottom: 7px;
			padding-bottom: 5px;
			border-bottom: 1px dashed #edf2f7;
		}

		/* ì´ë¦„ ê·¸ë£¹ (ì¢Œì¸¡ ì •ë ¬) */
		.supply-name-group {
			flex: 1;
			min-width: 0;
		}

		.supply-name { 
			font-weight: 800; 
			color: #2d3748; 
			font-size: 14px; 
			overflow: hidden; 
			text-overflow: ellipsis; 
			white-space: nowrap; 
		}

		/* ì•¡ì…˜ ë° ìˆ˜ëŸ‰ ê·¸ë£¹ (ìš°ì¸¡ ì •ë ¬) */
		.supply-action-group {
			display: flex;
			align-items: center;
			gap: 6px;
			flex-shrink: 0;
		}

		/* ìˆ˜ëŸ‰ í‘œì‹œ ë°•ìŠ¤ */
		.supply-total-box {
			margin-right: 4px;
			text-align: right;
			min-width: 45px;
		}

		.supply-total { font-size: 16px; font-weight: 800; color: #3182ce; }
		.unit { font-size: 11px; color: #a0aec0; margin-left: 2px; }

		/* ë¯¸ë‹ˆ ì¸í’‹ & ì…€ë ‰íŠ¸ */
		.mini-input {
			width: 50px;
			padding: 5px;
			border: 1px solid #cbd5e0;
			border-radius: 4px;
			font-size: 12px;
			text-align: center;
		}

		.mini-select {
			flex: 1;
			padding: 5px;
			border: 1px solid #cbd5e0;
			border-radius: 4px;
			font-size: 12px;
			background-color: #f8fafc;
		}

		/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		.btn-mini {
			border: none;
			border-radius: 4px;
			padding: 5px 10px;
			font-size: 12px;
			font-weight: bold;
			color: white;
			cursor: pointer;
			white-space: nowrap;
		}
		.btn-green { background: #48bb78; }
		.btn-blue { background: #4299e1; }

        /* ==========================================================================
           5. ì•Œë¦¼ íŒ¨ë„ (Notification)
           ========================================================================== */
        #notification-panel {
            position: fixed; bottom: -140px; left: -1px; right: -1px;
            background: white; border-radius: 15px 15px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            z-index: 1501; height: 180px; display: flex; flex-direction: column; transition: height 0.3s ease, bottom 0.3s ease;
        }
        #panel-resizer {
            height: 45px; background: #2c3e50; color: white; border-radius: 15px 15px 0 0;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0 15px; position: relative;
        }
        .handle-line { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
		/* ==========================================================================
           6. ì…ì†Œ ë“±ë¡
           ========================================================================== */
        .resident-form-box {
            background: #fff5f5; border: 1px solid #fed7d7; border-radius: 8px;
            padding: 12px; margin-bottom: 15px; display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            animation: slideDown 0.2s ease-out;
        }
        .resident-form-box.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .form-title { font-size: 13px; font-weight: bold; color: #c53030; display: flex; align-items: center; gap: 5px; }

        .res-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .res-input-full { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; }
        .res-input { flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; min-width: 0; }
        .res-select { padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; }
        
        /* ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ (ê°€ì¡± ì„ íƒ) */
        .role-radio-group { display: flex; gap: 15px; margin-bottom: 8px; font-size: 13px; color: #4a5568; align-items: center; }
        .role-radio-group label { cursor: pointer; display: flex; align-items: center; gap: 4px; }

        .btn-reg-submit {
            width: 100%; background: #e53e3e; color: white; border: none; padding: 8px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px;
        }
        .btn-reg-submit:hover { background: #c53030; }
        
        /* ì„¸ëŒ€ì£¼ ì—°ë½ì²˜ ì…ë ¥ì¹¸ (ì¡°ê±´ë¶€ í‘œì‹œ) */
        #head-phone-row { display: none; background: #fff; padding: 5px; border-radius: 4px; border: 1px dashed #cbd5e0; margin-bottom: 8px;}
		
		/* [New] ë¦¬ìŠ¤íŠ¸ ë‚´ ìƒíƒœ ë³€ê²½ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-action-group { display: flex; gap: 4px; }
        
        .btn-res-action {
            border: none; border-radius: 4px; padding: 4px 8px; 
            font-size: 11px; font-weight: bold; color: white; cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-res-action:hover { opacity: 0.8; }
        
        .btn-out { background-color: #718096; }   /* íšŒìƒ‰ (í‡´ì†Œ) */
        .btn-hosp { background-color: #e53e3e; }  /* ë¹¨ê°• (ë³‘ì›) */
		
		/* [ìˆ˜ì •] ì´ì¬ë¯¼ ëª©ë¡ ì•„ì´í…œ (í•œ ì¤„ë¡œ ì‹¬í”Œí•˜ê²Œ) */
        .res-item-row { 
            display: flex; justify-content: space-between; align-items: center; width: 100%; 
            padding: 5px 5px; cursor: pointer; border-radius: 4px; transition: background 0.2s;
        }
        .res-item-row:hover { background: #f1f3f5; }
        
        .res-simple-info { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #2d3748; }
        .res-sub-text { 
            font-size: 12px; 
            color: #a0aec0; 
            margin-left: auto;  /* í•µì‹¬: ì™¼ìª½ ì—¬ë°±ì„ ë‹¤ ì±„ì›Œì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°ˆ */
            margin-right: 8px;  /* í™”ì‚´í‘œ(â€º)ì™€ì˜ ê°„ê²© */
            text-align: right;
        }
        .res-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #48bb78; display: inline-block; } /* ì…ì†Œì¤‘ ë…¹ìƒ‰ì  */

        /* [New] ì´ì¬ë¯¼ í†µí•© ê´€ë¦¬ ëª¨ë‹¬ (ë””ìì¸ ì—…ê·¸ë ˆì´ë“œ) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .manager-window {
            width: 95%; 
            max-width: 1400px; /* í™”ë©´ ê½‰ ì°¨ê²Œ í‚¤ì›€ */
            height: 95vh;
            background: #f0f2f5; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ (ê´€ë¦¬ì í˜ì´ì§€ ëŠë‚Œ) */
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* í—¤ë” (ë„¤ì´ë¹„ìƒ‰ ê°•ì¡°) */
        .manager-header {
            padding: 10px 10px; 
            background: #2c3e50; /* ì§„í•œ ë„¤ì´ë¹„ */
            color: white; 
            border-bottom: 1px solid #1a252f;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        /* ë³¸ë¬¸ ì˜ì—­ */
        .manager-body {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column;
        }

        /* ìƒíƒœ íƒ­ (ë””ìì¸ í†µì¼) */
        .status-tab-bar { display: flex; gap: 10px; margin-bottom: 15px; background: #e0e0e0; padding: 5px; border-radius: 10px; flex-shrink:0; }
        .status-tab {
            flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: bold; color: #666; transition: all 0.2s;
        }
        .status-tab.active-in { background: white; color: #3498db; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-tab.active-hosp { background: white; color: #e74c3c; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-tab.active-out { background: white; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ë°ì´í„° ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .data-card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;
            align-content: start; flex: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
        }
        .data-card {
            background: white; border-radius: 10px; padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e1e4e8;
            display: flex; flex-direction: column; gap: 10px; position: relative;
        }
        
        /* ì¹´ë“œ ë‚´ë¶€ í…ìŠ¤íŠ¸ */
        .card-title { font-size: 16px; font-weight: bold; color: #2c3e50; }
        .card-meta { font-size: 13px; color: #7f8c8d; margin-top: 4px; }
        
        /* ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (ìš”ì²­ì‚¬í•­ ë°˜ì˜) */
        .card-actions { display: flex; gap: 5px; margin-top: auto; }
        .btn-action {
            flex: 1; padding: 7px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; color: white; transition: opacity 0.2s;
        }
        .btn-action:hover { opacity: 0.9; }
        
        .btn-act-orange { background: #2c3e50; } /* ë³‘ì›: ì£¼í™©ìƒ‰ */
        .btn-act-gray { background: #7f8c8d; }   /* í‡´ì†Œ: ì°¨ë¶„í•œ íšŒìƒ‰ */
        .btn-act-green { background: #27ae60; }   /* ë³µê·€: ì´ˆë¡ìƒ‰ */
        .btn-act-blue { background: #3498db; }    /* ì§€ê¸‰: íŒŒë€ìƒ‰ */

        /* í—¤ë” ë‚´ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .header-select {
            padding: 8px; border-radius: 6px; border: 1px solid #34495e; 
            background: #34495e; color: white; font-weight: bold; font-size: 14px; cursor: pointer;
        }
        .header-search {
            padding: 8px 12px; border-radius: 6px; border: none; font-size: 13px; width: 250px;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ (í•˜ë‹¨ ê³ ì •) */
        .pagination-container {
            margin-top: 20px; display: flex; justify-content: center; gap: 5px; flex-shrink: 0;
        }
        .page-btn {
            padding: 6px 12px; border: 1px solid #ddd; background: white; 
            cursor: pointer; border-radius: 4px; font-size: 13px; color: #333;
        }
        .page-btn.active { background: #3498db; color: white; border-color: #3498db; font-weight: bold; }
        .page-btn:hover:not(.active) { background: #f1f1f1; }
        
        /* ì„œë¸Œ ëª¨ë‹¬ (ë“±ë¡í¼) */
        .sub-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 450px; background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 2100; display: none;
        }
        .sub-modal.open { display: block; }
		
		/* [New] ê²€ìƒ‰ì°½ ë””ìì¸ (ì‚­ì œ ì•„ì´ì½˜ + ì‹¤í–‰ ë²„íŠ¼) */
        .search-container {
            display: flex; align-items: center; gap: 5px;
        }
        
        .search-input-wrapper {
            position: relative; display: flex; align-items: center;
        }
        
        .header-search-input {
            padding: 8px 30px 8px 12px; /* ì˜¤ë¥¸ìª½ íŒ¨ë”©ì„ ëŠ˜ë ¤ Xë²„íŠ¼ ê³µê°„ í™•ë³´ */
            border-radius: 6px; border: none; font-size: 13px; width: 220px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* ì…ë ¥ì°½ ë‚´ë¶€ ì‚­ì œ(X) ë²„íŠ¼ */
        .btn-input-clear {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: #ccc; color: white; border-radius: 50%; border: none;
            width: 16px; height: 16px; font-size: 10px; line-height: 16px;
            cursor: pointer; display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            align-items: center; justify-content: center; padding: 0;
        }
        .btn-input-clear:hover { background: #999; }

        /* ê²€ìƒ‰ ì‹¤í–‰ ë²„íŠ¼ */
        .btn-search-exec {
            background: #34495e; color: white; border: 1px solid #4a6278;
            padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;
            font-size: 13px;
        }
        .btn-search-exec:hover { background: #2c3e50; }
		
		/* [New] ì´ì¬ë¯¼ ìƒì„¸ ì •ë³´ íŒ¨ë„ (êµ¬í˜¸ì†Œ íŒ¨ë„ ìœ„ì— ë®ì„) */
        #resident-info-panel {
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 370px; /* íŒ¨ë„ ë„ˆë¹„ */
            left: 369px;  /* [í•µì‹¬] êµ¬í˜¸ì†Œ íŒ¨ë„ ë„ˆë¹„ë§Œí¼ ë„ì›Œì„œ ë°°ì¹˜ */
            
            background: white; 
            z-index: 998; /* [í•µì‹¬] êµ¬í˜¸ì†Œ íŒ¨ë„(999)ë³´ë‹¤ ë‚®ê²Œ í•˜ì—¬ ë’¤ì—ì„œ ë‚˜ì˜¤ê²Œ í•¨ */
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            
            /* ì• ë‹ˆë©”ì´ì…˜: í‰ì†Œì—” ì™¼ìª½(-100%)ìœ¼ë¡œ ìˆ¨ì–´ìˆë‹¤ê°€(êµ¬í˜¸ì†Œ íŒ¨ë„ ë’¤), open ì‹œ ì œìë¦¬(0)ë¡œ ë‚˜ì˜´ */
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            display: flex; flex-direction: column; 
			display: none;
            border-left: 1px solid #dcdcdc; /* ì™¼ìª½ ê²½ê³„ì„  ì¶”ê°€ */
        }
        
        #resident-info-panel.open { 
            transform: translateX(0); /* ìš°ì¸¡ìœ¼ë¡œ ìŠ¬ë¼ì´ë“œ ì•„ì›ƒ */
        }


		
        /* (ë‚˜ë¨¸ì§€ í—¤ë”, í”„ë¡œí•„ ì¹´ë“œ ë“±ì˜ ë‚´ë¶€ ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ ìœ ì§€) */
        .res-detail-header {
            background: #2c3e50; color: white; padding: 10px 5px 10px 15px; height: 49px;
            display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #1a252f; flex-shrink: 0;
        }
        .btn-back { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 5px; }
        .btn-back:hover { opacity: 0.8; }

        /* í”„ë¡œí•„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .profile-card { background: white; padding: 20px; text-align: center; border-bottom: 1px solid #edf2f7; margin-bottom: 10px; }
        .profile-avatar { 
            width: 70px; height: 70px; background: #e2e8f0; border-radius: 50%; margin: 0 auto 10px; 
            display: flex; align-items: center; justify-content: center; font-size: 30px; 
        }
        .profile-name { font-size: 18px; font-weight: 800; color: #2d3748; margin-bottom: 5px; }
        .profile-meta { font-size: 13px; color: #718096; line-height: 1.5; }
        .profile-badge { 
            display: inline-block; padding: 3px 8px; border-radius: 12px; 
            font-size: 11px; font-weight: bold; margin-top: 5px; 
        }
        
        /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ (í¬ê²Œ) */
        .action-big-btn-row { display: flex; gap: 8px; padding: 0 15px 15px 15px; }
        .btn-big-action { 
            flex: 1; padding: 12px 0; border: none; border-radius: 8px; 
            font-size: 14px; font-weight: bold; color: white; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .btn-big-action:hover { opacity: 0.9; transform: translateY(-1px); }

        /* ë¬¼í’ˆ ì§€ê¸‰ ë¦¬ìŠ¤íŠ¸ */
        .supply-history-list { list-style: none; padding: 0; margin: 0; }
        .supply-history-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid #f1f3f5; font-size: 13px; 
        }
        .supply-history-item:last-child { border-bottom: none; }
		
		/* [New] ì…í‡´ì†Œ ì´ë ¥ ìŠ¤íƒ€ì¼ */
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 13px; color: #4a5568;
        }
        .history-item:last-child { border-bottom: none; }
        .history-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        
        .badge-in { background: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .badge-out { background: #edf2f7; color: #718096; border: 1px solid #cbd5e0; }
        .badge-hosp { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
		
		/* íŠ¹ì´ì‚¬í•­ ê¸°ë¡ìš© ìŠ¤íƒ€ì¼ */
		.note-input-area {
			display: flex; gap: 5px; margin-bottom: 10px;
		}
		.note-input {
			flex: 1; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px;
		}
		.btn-note-save {
			background: #4a5568; color: white; border: none; padding: 0 12px; 
			border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px;
		}
		.btn-note-save:hover { background: #2d3748; }

		/* ì´ë ¥ ë¦¬ìŠ¤íŠ¸ ë‚´ íŠ¹ì´ì‚¬í•­ ìŠ¤íƒ€ì¼ */
		.note-content-box {
			background: #fff5f5; /* ì—°í•œ ë…¸ë‘ ë°°ê²½ */
			padding: 8px; 
			border-radius: 6px; 
			border: 1px solid #e2e8f0;
			margin-top: 4px;
			font-size: 12px;
			color: #4a5568;
			width: 95%;
			position: relative;
		}
		.note-label {
			font-size: 11px; font-weight: bold; color: #d46b08; margin-right: 5px;
		}
		
		/* [NEW] ì‚­ì œ ë¯¸ë‹ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		.btn-del-mini {
			background: none;
			border: none;
			color: #a0aec0;
			font-weight: bold;
			cursor: pointer;
			padding: 0 5px;
			font-size: 14px;
			line-height: 1;
		}
		.btn-del-mini:hover {
			color: #e74c3c; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë¹¨ê°„ìƒ‰ */
		}
		.res-list-content {
			flex: 1;
			display: flex; 
			justify-content: space-between; 
			align-items: center;
		}
    </style>
</head>
<body>

    <div id="layout-container">
        <div id="sidebar">
            <button class="toggle-btn" onclick="toggleSidebar()">â—€</button>
            <div class="sidebar-vertical-text">ì£¼ë¯¼ë³´í˜¸ì‹œìŠ¤í…œ</div>

            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <a href="/"><img src="/static/images/logo.png" alt="ìœ ì„±êµ¬ì²­" style="height: 36px;"></a>
					<input type="hidden" id="incident_id" value="{{ incident_id }}" />
                </div>
            </div>
            
            <div class="sidebar-content-wrapper">
				<div class="incident-name-header">
					<div class="incident-badge">ON AIR</div>
					<div class="incident-title-text">{{ incident_title }}</div>
				</div>
				
				<div id="sidebar-stats">
					<div class="stat-grid">
						<div class="stat-mini-card stat-residents">
							<div class="stat-label">ğŸ‘¥ ì´ì¬ë¯¼</div>
							<div class="stat-value-row">
								<span id="val-residents" class="stat-number">{{ summary.residents }}</span>
								<span class="stat-unit">ëª…</span>
							</div>
						</div>
						
						<div class="stat-mini-card stat-supplies cursor-pointer" onclick="openSupplyPanel()">
							<div class="stat-label">ğŸ“¦ êµ¬í˜¸ë¬¼í’ˆ</div>
							<div class="stat-value-row">
								<span id="val-supplies" class="stat-number">{{ summary.supplies }}</span>
								<span class="stat-unit">ê°œ</span>
							</div>
						</div>
						
						<div class="stat-mini-card stat-shelters">
							<div class="stat-label">ğŸ¥ êµ¬í˜¸ì†Œ</div>
							<div class="stat-value-row">
								<span id="val-shelters" class="stat-number">{{ summary.shelters }}</span>
								<span class="stat-unit">ê°œì†Œ</span>
							</div>
						</div>
						
						<div class="stat-mini-card stat-assemblies">
							<div class="stat-label">ğŸš© ì§‘ê²°ì§€</div>
							<div class="stat-value-row">
								<span id="val-assemblies" class="stat-number">{{ summary.assemblies }}</span>
								<span class="stat-unit">ê°œì†Œ</span>
							</div>
						</div>
					</div>
				</div>
				<div class="sidebar-stats-list">
					<div class="panel-section-title shelter-title"><span>ğŸ¥ êµ¬í˜¸ì†Œ í˜„í™©</span></div>
					<div id="shelter-list"></div>
					
					<div class="panel-section-title assembly-title" style="margin-top: 20px;"><span>ğŸš© ì§‘ê²°ì§€ í˜„í™©</span></div>
					<div id="assembly-list"></div>
				</div>
				
            </div>
			<div style="height:30px;"></div>
        </div>

        <div id="map-area">


            <div id="detail-panel">
                <div class="detail-header">
                    <div class="detail-header-title-box"><h3 id="panel-header-title">êµ¬í˜¸ì†Œ ì •ë³´</h3></div>
                    <div class="header-actions">
                        <button id="btn-edit-mode" class="btn-edit-mode" onclick="enableEditMode()">âœï¸ ìˆ˜ì •</button>
                        <div id="edit-actions" class="edit-btn-group" style="display:none;">
                            <button class="btn-save-action" onclick="saveShelterInfo()">ì €ì¥</button>
                            <button class="btn-cancel-action" onclick="cancelEditMode()">ì·¨ì†Œ</button>
                        </div>
                        <div id="admin-switch-area"></div> 
                        <button class="btn-close-detail" onclick="closeDetailPanel()">Ã—</button>
                    </div>
                </div>

                <div class="detail-content" id="shelter-detail-content">
                    <div class="detail-section">
                        <h4>â„¹ï¸ ê¸°ë³¸ ì •ë³´</h4>
                        <table class="info-table">
                            <tr><th>ì´ë¦„</th><td><span class="view-mode" id="v-name"></span><input type="text" class="edit-mode info-input" id="e-name"></td></tr>
                            <tr><th>ì£¼ì†Œ</th><td><span class="view-mode" id="v-addr"></span><input type="text" class="edit-mode info-input" id="e-addr"></td></tr>
                            <tr><th>ìˆ˜ìš©</th><td><span class="view-mode"><span id="v-cap"></span>ëª…</span><input type="number" class="edit-mode info-input" id="e-cap"></td></tr>
                            <tr><th>ìœ„ì¹˜</th><td>
                                <div class="view-mode" style="font-size:11px; color:#718096;">ìœ„ë„: <span id="v-lat"></span>, ê²½ë„: <span id="v-lng"></span></div>
                                <div class="edit-mode" style="display:none; gap:5px;">
                                    <input type="text" class="info-input" id="e-lat" placeholder="ìœ„ë„" style="width:48%;">
                                    <input type="text" class="info-input" id="e-lng" placeholder="ê²½ë„" style="width:48%;">
                                </div>
                            </td></tr>
                        </table>
                    </div>
                    <div class="detail-section">
                        <h4 style="margin-bottom: 10px;">
							<div>ğŸ‘¥ ì´ì¬ë¯¼ ëª…ë‹¨ <span id="dt-res-count" class="badge-count">0</span></div>
							<div style="display:flex; gap:5px;">
								 <button onclick="toggleResidentForm()" style="background:#edf2f7; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer; color:#4a5568;">+ ì…ì†Œ ë“±ë¡</button>
								 <button onclick="openManagerModal(currentEditingShelterId)" style="background:#2c3e50; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;">ğŸ” ì „ì²´ ê´€ë¦¬</button>
							</div>
						</h4>

						<div style="display: flex; gap: 5px; margin-bottom: 10px;">
							<div style="position: relative; flex: 1; display: flex; align-items: center;">
								<input type="text" id="dt-res-search" placeholder="ì´ë¦„ ë˜ëŠ” ì—°ë½ì²˜ ê²€ìƒ‰..." 
									   style="width: 100%; padding: 6px 30px 6px 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; box-sizing: border-box;"
									   oninput="togglePanelSearchX()"
									   onkeyup="if(window.event.keyCode==13){searchResidentInPanel()}">
								
								<button id="btn-panel-res-clear" 
										onclick="clearPanelSearch()"
										style="position: absolute; right: 8px; background: #ccc; color: white; border-radius: 50%; border: none; width: 16px; height: 16px; font-size: 10px; cursor: pointer; display: none; align-items: center; justify-content: center; padding: 0;">
									âœ•
								</button>
							</div>
							<button onclick="searchResidentInPanel()" 
									style="background: #4a5568; color: white; border: none; padding: 0 10px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
								ê²€ìƒ‰
							</button>
						</div>
                        
                        <div id="resident-reg-form" class="resident-form-box">
                            <div class="form-header">
                                <span class="form-title">ğŸ“ ì‹ ê·œ ì…ì†Œ ë“±ë¡</span>
                                <button onclick="toggleResidentForm()" style="border:none; background:none; cursor:pointer; font-size:16px; color:#aaa;">Ã—</button>
                            </div>

                            <div class="role-radio-group">
                                <label><input type="radio" name="fam_role" value="ì„¸ëŒ€ì£¼" checked onchange="toggleHeadPhoneInput()"> ğŸ  ì„¸ëŒ€ì£¼ (ëŒ€í‘œ)</label>
                                <label><input type="radio" name="fam_role" value="ì„¸ëŒ€ì›" onchange="toggleHeadPhoneInput()"> ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ì„¸ëŒ€ì›</label>
                            </div>

                            <div id="head-phone-row">
                                <input type="text" id="reg-head-phone" class="res-input-full" placeholder="ì—°ê²°í•  ì„¸ëŒ€ì£¼ ì—°ë½ì²˜ ì…ë ¥">
                                <div style="font-size:11px; color:#718096; margin-top:2px;">* ë¨¼ì € ë“±ë¡ëœ ì„¸ëŒ€ì£¼ì˜ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
                            </div>

                            <div class="res-input-row">
                                <input type="text" id="reg-res-name" class="res-input" placeholder="ì´ë¦„ (í•„ìˆ˜)">
                                <input type="text" id="reg-res-age" class="res-input" placeholder="ìƒë…„ì›”ì¼" style="flex:0.6;">
                                <select id="reg-res-gender" class="res-select">
                                    <option value="ë‚¨">ë‚¨</option>
                                    <option value="ì—¬">ì—¬</option>
                                </select>
                            </div>
                            
                            <div class="res-input-row">
                                <input type="text" id="reg-res-phone" class="res-input-full" placeholder="ì—°ë½ì²˜ (010-0000-0000)">
                            </div>
                            
                            <div class="res-input-row">
                                <input type="text" id="reg-res-note" class="res-input-full" placeholder="íŠ¹ì´ì‚¬í•­ (ì§€ë³‘, í™˜ì, ì„ì‚°ë¶€ ë“±)">
                            </div>

                            <button class="btn-reg-submit" onclick="registerResident()">ì…ì†Œ ë“±ë¡ ì™„ë£Œ</button>
                        </div>

                        <ul id="dt-res-list" class="detail-list" style="min-height: 150px;">
							</ul>

						<div id="dt-res-pagination" class="mini-pagination"></div>
                    </div>
					
                    <div class="detail-section"><h4>ğŸ“¦ ë¬¼í’ˆ í˜„í™©</h4><ul id="dt-inv-list" class="detail-list"></ul></div>
                    <div class="detail-section">
						<h4 style="margin-bottom: 10px;">
							<div>ğŸ‘· ê·¼ë¬´ì í˜„í™©</div>
							<button onclick="toggleStaffForm()" style="background:#edf2f7; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer; color:#4a5568;">+ ê·¼ë¬´ ë“±ë¡</button>
						</h4>

						<div id="staff-reg-form" class="resident-form-box"> <div class="form-header">
								<span class="form-title" style="color:#2c5282;">ğŸ‘· ì‹ ê·œ ê·¼ë¬´ ë“±ë¡</span>
								<button onclick="toggleStaffForm()" style="border:none; background:none; cursor:pointer; font-size:16px; color:#aaa;">Ã—</button>
							</div>
							
							<div class="res-input-row">
								<input type="text" id="reg-staff-name" class="res-input" placeholder="ì´ë¦„ (í•„ìˆ˜)">
								<input type="text" id="reg-staff-dept" class="res-input" placeholder="ì†Œì† ë¶€ì„œ">
							</div>
							
							<div class="res-input-row">
								<input type="text" id="reg-staff-phone" class="res-input-full" placeholder="ì—°ë½ì²˜ (010-0000-0000)">
							</div>
							
							<div class="res-input-row">
								<select id="reg-staff-mission" class="res-input-full">
									<option value="">ë‹´ë‹¹ ì„ë¬´ ì„ íƒ (í•„ìˆ˜)</option>
									<option value="ì´ê´„">ì´ê´„ ê´€ë¦¬</option>
									<option value="ë¬¼í’ˆë°°ë¶„">ë¬¼í’ˆ ë°°ë¶„</option>
									<option value="ì´ì¬ë¯¼ë“±ë¡">ì´ì¬ë¯¼ ë“±ë¡/ìƒë‹´</option>
									<option value="ì˜ë£Œì§€ì›">ì˜ë£Œ ì§€ì›</option>
									<option value="ì¹˜ì•ˆ/ë³´ì•ˆ">ì¹˜ì•ˆ ë° ë³´ì•ˆ</option>
									<option value="ê¸°íƒ€">ê¸°íƒ€</option>
								</select>
							</div>

							<button class="btn-reg-submit" style="background:#2b6cb0;" onclick="registerStaff()">ê·¼ë¬´ì ë“±ë¡</button>
						</div>

						<ul id="dt-staff-list" class="detail-list"></ul>
					</div>
					<div style="height:30px;"></div>
                </div>
            </div>
			

            <div id="supply-panel">
                <div class="detail-header">
                    <h3>ğŸ“¦ êµ¬í˜¸ë¬¼í’ˆ ì¬ê³  ê´€ë¦¬</h3>
                    <button class="btn-close-detail" onclick="closeSupplyPanel()">Ã—</button>
                </div>
                <div class="detail-content" style="padding:0;">
                    <div class="add-supply-form">
                        <div style="font-size:13px; font-weight:bold; color:#2c5282; margin-bottom:8px;">â• ì‹ ê·œ í’ˆëª© ë“±ë¡</div>
                        <div class="form-row">
                            <input type="text" id="new-item-name" placeholder="í’ˆëª©ëª…" style="flex:2;">
                            <input type="number" id="new-item-qty" placeholder="ì´ˆê¸°ìˆ˜ëŸ‰" style="flex:1;">
                        </div>
                        <button class="btn-add-stock" onclick="addHqSupply()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div style="padding: 10px 10px;">
                        <div id="hq-supply-list"></div>
                    </div>
					<div style="height:30px;"></div>
                </div>
            </div>
			
			<div id="resident-info-panel">
                <div class="res-detail-header">
                    <button class="btn-back" onclick="closeResidentInfoPanel()">â¬…</button>
                    <h3 style="margin:0; font-size:16px;">ì´ì¬ë¯¼ ìƒì„¸ ì •ë³´</h3>
                </div>
                
                <div class="detail-content" style="padding:0; background:#f8fafc; overflow-y: auto;">
                    
                    <div class="profile-card">
                        <div class="profile-avatar">ğŸ‘¤</div>
                        <div class="profile-name" id="res-info-name"></div>
                        <div class="profile-meta">
                            <span id="res-info-gender-age"></span> | ğŸ“ <span id="res-info-phone"></span>
                        </div>
                        <div class="profile-meta" id="res-info-shelter" style="color:#2980b9; font-weight:bold; margin-top:5px;"></div>
                        <div id="res-info-note" style="margin-top:8px; color:#e53e3e; font-size:12px; font-weight:bold;"></div>
                    </div>

                    <div class="detail-section" style="margin: 0 10px 10px 10px; border:1px solid #e2e8f0;">
                        <h4 style="margin-bottom:10px; font-size:13px;">ğŸ êµ¬í˜¸ë¬¼í’ˆ ì§€ê¸‰</h4>
                        
                        <div style="display:flex; gap:5px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                            <select id="res-info-supply-select" class="info-input" style="flex:1;">
                                <option value="">ì§€ê¸‰í•  ë¬¼í’ˆ ì„ íƒ</option>
                            </select>
                            <button id="btn-info-distribute" style="background:#27ae60; color:white; border:none; border-radius:4px; padding:0 12px; font-weight:bold; cursor:pointer;">ì§€ê¸‰</button>
                        </div>
                        
                        <div style="font-size:12px; color:#718096; margin-bottom:5px; font-weight:bold;">ğŸ“‹ ìµœê·¼ ì§€ê¸‰ ë‚´ì—­</div>
                        <ul id="res-info-dist-list" class="supply-history-list" style="background:white; border:1px solid #edf2f7; border-radius:4px;">
                        </ul>
                    </div>

                    <div class="detail-section" style="margin: 0 10px 10px 10px; border:1px solid #e2e8f0;">
                        <h4 style="margin-bottom:10px; font-size:13px;">ğŸ‘£ ì´ë™/ìƒíƒœ ì´ë ¥</h4>
						<div class="note-input-area">
							<input type="text" id="res-note-input" class="note-input" placeholder="íŠ¹ì´ì‚¬í•­ (ì—”í„° ì…ë ¥)">
							<button class="btn-note-save" onclick="addResidentNote()">ë©”ëª¨</button>
						</div>
                        <ul id="res-info-history-list" class="history-list">
                        </ul>
                    </div>
                    
                    <div class="action-big-btn-row" style="background: white; border-top:1px solid #eee; padding: 15px; flex-shrink: 0;">
						<button class="btn-big-action btn-act-orange" id="btn-info-hosp">
							<span style="font-size:18px;">ğŸš‘</span> <span>ë³‘ì› ì´ì†¡</span>
						</button>
						<button class="btn-big-action btn-act-gray" id="btn-info-out">
							<span style="font-size:18px;">ğŸ </span> <span>í‡´ì†Œ ì²˜ë¦¬</span>
						</button>
					</div>
					
                </div>
				<div style="height:30px;"></div>
                
            </div>

            <div id="map"></div>
            
            <div id="notification-panel">
                <div id="panel-resizer" onclick="togglePanel(event)">
                    <div class="handle-line"></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="toggle-icon">â–²</span>
                        <span style="font-weight: bold; font-size: 0.9rem;">ğŸ“¢ ì‹¤ì‹œê°„ ìƒí™© ì•Œë¦¼</span>
                    </div>
                    <button onclick="clearNotifications(event)" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; cursor: pointer;">ë¹„ìš°ê¸°</button>
                </div>
                <div id="notification-list" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <div class="empty-msg" style="text-align:center; color:#94a3b8; margin-top:30px;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <div id="route-legend" class="route-legend-container">
                <div class="legend-title">ğŸšŒ ì£¼ë¯¼ì†Œê°œ ê²½ë¡œ</div>
                <div id="legend-list"></div>
            </div>
            <div id="connect-guide">
                ğŸ”— ì—°ê²°í•  'êµ¬í˜¸ì†Œ'ë¥¼ í´ë¦­í•˜ì„¸ìš”! <button onclick="cancelConnect()" style="margin-left:10px; padding:2px 8px; border-radius:10px; border:none; background:#e74c3c; color:white; cursor:pointer;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
	
	<div id="resident-manager-modal" class="modal-overlay">
                <div class="manager-window">
                    <div class="manager-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 20px; font-weight: bold;">ğŸ‘¥ ì´ì¬ë¯¼ í†µí•© ê´€ë¦¬</div>
                            <select id="mgr-shelter-select" class="header-select" onchange="changeManagerShelter()">
                                </select>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <div class="search-container">
                                <div class="search-input-wrapper">
                                    <input type="text" id="mgr-search" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸..." class="header-search-input" 
                                           oninput="toggleSearchClearBtn()" onkeydown="handleSearchEnter(event)">
                                    
                                    <button id="btn-mgr-clear" class="btn-input-clear" onclick="clearManagerSearch()">âœ•</button>
                                </div>
                                <button class="btn-search-exec" onclick="executeManagerSearch()">ğŸ”</button>
                            </div>

                            <button onclick="openSubModal()" style="background:#27ae60; color:white; border:none; padding:8px 18px; border-radius:6px; font-weight:bold; cursor:pointer;">â• ì‹ ê·œ ë“±ë¡</button>
                            <button onclick="closeManagerModal()" style="background:none; border:none; color:rgba(255,255,255,0.8); font-size:28px; cursor:pointer; line-height: 1;">Ã—</button>
                        </div>
                    </div>

                    <div class="manager-body">
                        <div class="status-tab-bar">
                            <div class="status-tab active-in" id="tab-IN" onclick="switchManagerTab('IN')">ğŸ  ì…ì†Œì¤‘ (<span id="cnt-IN">0</span>)</div>
                            <div class="status-tab" id="tab-HOSPITAL" onclick="switchManagerTab('HOSPITAL')">ğŸ¥ ë³‘ì›ì´ì†¡ (<span id="cnt-HOSPITAL">0</span>)</div>
                            <div class="status-tab" id="tab-OUT" onclick="switchManagerTab('OUT')">ğŸšª í‡´ì†Œì™„ë£Œ (<span id="cnt-OUT">0</span>)</div>
                        </div>

                        <div id="mgr-card-grid" class="data-card-grid">
                            </div>

                        <div id="mgr-pagination" class="pagination-container">
                            </div>
                    </div>
                </div>
                
                <div id="resident-add-modal" class="sub-modal">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <h3 style="margin:0; color:#2c3e50;">ğŸ‘¤ ì‹ ê·œ ì´ì¬ë¯¼ ë“±ë¡</h3>
                        <button onclick="closeSubModal()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">Ã—</button>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="font-size:12px; font-weight:bold; color:#555;">ì†Œì† êµ¬í˜¸ì†Œ</label>
                        <select id="modal-reg-shelter" class="info-input" style="background:#f0f8ff; border-color:#3498db;">
                            </select>
                        <label style="font-size:12px; font-weight:bold; color:#555; margin-top:5px;">ê°€êµ¬ ì •ë³´</label>
                        <select id="modal-reg-fam-role" class="info-input" onchange="toggleModalRegHeadPhone()">
                            <option value="ì„¸ëŒ€ì£¼">ğŸ  ì„¸ëŒ€ì£¼ (ëŒ€í‘œ)</option>
                            <option value="ì„¸ëŒ€ì›">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ì„¸ëŒ€ì› (ê°€ì¡±)</option>
                        </select>
                        
                        <input type="text" id="modal-reg-head-phone" class="info-input" placeholder="ğŸ”— ì„¸ëŒ€ì£¼ ì—°ë½ì²˜ ì…ë ¥ (í•„ìˆ˜)" style="display:none; background:#fff5f5; border-color:#e53e3e;">
                        
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;">
                                <input type="text" id="modal-reg-name" class="info-input" placeholder="ì´ë¦„ (í•„ìˆ˜)" style="width:100%; box-sizing:border-box;">
                            </div>
                            <div style="flex:1;">
                                <input type="text" id="modal-reg-age" class="info-input" placeholder="ìƒë…„ì›”ì¼(6/8ìë¦¬)" style="width:100%; box-sizing:border-box;">
                            </div>
                        </div>

                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;">
                                <select id="modal-reg-gender" class="info-input" style="width:100%;">
                                    <option value="ë‚¨">ë‚¨ì„±</option>
                                    <option value="ì—¬">ì—¬ì„±</option>
                                </select>
                            </div>
                            <div style="flex:1.5;">
                                <input type="text" id="modal-reg-phone" class="info-input" placeholder="ì—°ë½ì²˜ (010-...)" style="width:100%; box-sizing:border-box;">
                            </div>
                        </div>
                        
                        <input type="text" id="modal-reg-note" class="info-input" placeholder="íŠ¹ì´ì‚¬í•­ (ì§€ë³‘, ë¶€ìƒ ë“±)" style="width:100%; box-sizing:border-box;">
                        
                        <button onclick="registerResidentManager()" style="background:#27ae60; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px; font-size:15px; transition: background 0.2s;">
                            ë“±ë¡ ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </div>

    <div id="contextMenu">
        <div class="context-item" onclick="addNode('shelter')">ğŸ¥ êµ¬í˜¸ì†Œ ì¶”ê°€</div>
        <div class="context-item" onclick="addNode('assembly')">ğŸš© ì§‘ê²°ì§€ ì¶”ê°€</div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        // ------------------------------------------------------------
        // 1. ì„¤ì • ë° ìƒìˆ˜ ì •ì˜
        // ------------------------------------------------------------
        var userRole = {{ user_role|default(3) }}; 
        var locations = {{ locations | tojson }};
        
        // ì•„ì´ì½˜ SVG
        const SVG_SHELTER = `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="41" viewBox="0 0 38 52"><path d="M19 2C9.6 2 2 9.6 2 19C2 31 19 50 19 50S36 31 36 19C36 9.6 28.4 2 19 2Z" fill="#3498db" stroke="#2980b9" stroke-width="2"/><circle cx="19" cy="19" r="9" fill="white"/></svg>`;
        const SVG_ASSEMBLY = `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="41" viewBox="0 0 38 52"><path d="M19 2C9.6 2 2 9.6 2 19C2 31 19 50 19 50S36 31 36 19C36 9.6 28.4 2 19 2Z" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/><circle cx="19" cy="19" r="7" fill="white"/></svg>`;
        const IMG_SHELTER = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(SVG_SHELTER);
        const IMG_ASSEMBLY = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(SVG_ASSEMBLY);
        const ROUTE_COLORS = ['#E74C3C', '#8E44AD', '#3498DB', '#16A085', '#F39C12', '#2C3E50'];

        // ì „ì—­ ë³€ìˆ˜
        var mapContainer = document.getElementById('map');
        var mapOption = { center: new kakao.maps.LatLng(36.391170, 127.381979), level: 7 };
        var map = new kakao.maps.Map(mapContainer, mapOption); 
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        var pendingSourceNode = null; 
        var clickedLat = 0, clickedLng = 0;
        var routeManager = {};
        var markerManager = {}; 
        var routeCount = 0;
        var colorIndex = 0;
        var currentInfowindow = null;
        var currentEditingShelterId = null;
		var currentManagerShelterId = 0;
		
		var detailResData = []; // ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
		var detailResPage = 1;  // í˜„ì¬ í˜ì´ì§€
		const DETAIL_ITEMS_PER_PAGE = 5; // í˜ì´ì§€ë‹¹ 5ëª…

        // ------------------------------------------------------------
        // 2. ì†Œì¼“(Socket.IO) ì—°ê²° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        // ------------------------------------------------------------
        const socket = io(); 
        socket.on('connect', () => console.log("âœ… ì„œë²„ ì—°ê²°ë¨ (ID: " + socket.id + ")"));
        socket.on('disconnect', () => console.log("âŒ ì„œë²„ ì—°ê²° ëŠê¹€"));
        
        // ì‹œìŠ¤í…œ ì•Œë¦¼ ìˆ˜ì‹ 
        socket.on('sys_notification', (data) => {
            //console.log("ğŸ“¢ ì•Œë¦¼:", data);
            handleNotification(data);
        });

        // ë°ì´í„° ê°±ì‹  ì‹ í˜¸ ìˆ˜ì‹ 
        socket.on('map_update', function(msg) {
            //console.log("ê°±ì‹  ì‹ í˜¸:", msg);
            updateDashboardData();
            // ë¬¼í’ˆ íŒ¨ë„ì´ ì—´ë ¤ìˆë‹¤ë©´ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            if (document.getElementById('supply-panel').classList.contains('open')) {
                loadHqSupplies();
            }
        });

        // ------------------------------------------------------------
        // 3. ì§€ë„ ì´ˆê¸°í™” ë° ë§ˆì»¤ ìƒì„±
        // ------------------------------------------------------------
        var bounds = new kakao.maps.LatLngBounds();
        document.getElementById('route-legend').style.display="none";
        locations.forEach(function(loc) {
            if (loc.lat && loc.lng) {
                var coords = new kakao.maps.LatLng(loc.lat, loc.lng);
                createCustomMarker(coords, loc);
                
                // ëŒ€í”¼ ê²½ë¡œ ê·¸ë¦¬ê¸°
                if (loc.type === 'assembly' && loc.route_infos) {
                    loc.route_infos.forEach(function(route) {
                        if (route.path_data && route.path_data.length > 0) {
                            var linePath = route.path_data.map(p => new kakao.maps.LatLng(p.lat, p.lng));
                            drawPathAndAddToLegend(linePath, loc.name, route.shelter_name);
                            linePath.forEach(p => bounds.extend(p));
							
							document.getElementById('route-legend').style.display="block";
                        }
                    });
                }
            }
        });

        // ------------------------------------------------------------
        // 4. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ (ë§ˆì»¤, íŒ¨ë„, ì—°ê²°)
        // ------------------------------------------------------------
        
        // [CustomOverlay ë§ˆì»¤ ìƒì„±]
        function createCustomMarker(coords, loc) {
            var markerKey = loc.type + '_' + loc.id;
            
            var contentDiv = document.createElement('div');
            contentDiv.className = 'marker-content';
            if (!loc.is_active) contentDiv.classList.add('grayscale');

            var img = document.createElement('img');
            img.src = (loc.type === 'shelter') ? IMG_SHELTER : IMG_ASSEMBLY;
            contentDiv.appendChild(img);

            var customOverlay = new kakao.maps.CustomOverlay({
                position: coords, content: contentDiv, xAnchor: 0.5, yAnchor: 1, zIndex: 3
            });
            customOverlay.setMap(map);

            markerManager[markerKey] = { overlay: customOverlay, div: contentDiv, data: loc, visible: true };
            addMarkerToPanel(loc, markerKey);

            contentDiv.onclick = function(e) {
                e.stopPropagation();
                if (pendingSourceNode) {
                    if (loc.type === 'shelter') completeConnection(loc); 
                    else alert("âš ï¸ êµ¬í˜¸ì†Œë¥¼ ì„ íƒí•´ì•¼ ì—°ê²°ë©ë‹ˆë‹¤.");
                    return; 
                }
                if (loc.type === 'shelter') openDetailPanel(loc.id);
                else openInfoWindow(loc, coords);
            };
        }

        // [ì¢Œì¸¡ ì‚¬ì´ë“œë°” íŒ¨ë„ ë“±ë¡]
        function addMarkerToPanel(loc, key) {
            var containerId = loc.type === 'shelter' ? 'shelter-list' : 'assembly-list';
            var container = document.getElementById(containerId);
            
            var div = document.createElement('div');
            div.className = 'marker-item';
            div.id = 'panel-' + key;
            if(!loc.is_active) div.classList.add('inactive'); 
            
            div.onclick = function() {
                if (loc.type === 'shelter') openDetailPanel(loc.id);
                else {
                    var moveLatLon = new kakao.maps.LatLng(loc.lat, loc.lng);
                    map.panTo(moveLatLon);
                    openInfoWindow(loc, moveLatLon);
                }
            };
            
            div.onmouseenter = function() { if(markerManager[key]) markerManager[key].div.classList.add('highlight'); };
            div.onmouseleave = function() { if(markerManager[key]) markerManager[key].div.classList.remove('highlight'); };

            var iconImg = document.createElement('img');
            iconImg.src = (loc.type === 'shelter') ? IMG_SHELTER : IMG_ASSEMBLY;
            iconImg.className = 'marker-icon';
            iconImg.onclick = function(e) { e.stopPropagation(); toggleMapVisibility(key); };

            var infoBox = document.createElement('div');
            infoBox.className = 'marker-info-box';
            var html = `<div class="marker-name">${loc.name}</div>`;
            if(loc.type==='shelter' && (loc.stat_resident || loc.stat_staff)) {
                html += `<div class="marker-stats">`;
                html += `<span class="stat-badge">ğŸ‘¥ ${loc.stat_resident || 0}ëª…</span><span class="staff-badge">ğŸ‘® ${loc.stat_staff || 0}ëª…</span>`;
                html += `</div>`;
            }
            infoBox.innerHTML = html;

            div.appendChild(iconImg);
            div.appendChild(infoBox);
            container.appendChild(div);
        }

        // ------------------------------------------------------------
        // 5. ê¸°ëŠ¥ë³„ ë¡œì§: êµ¬í˜¸ì†Œ ìƒì„¸/ìˆ˜ì •
        // ------------------------------------------------------------
		function searchResidentInPanel() {
			const keyword = document.getElementById('dt-res-search').value.trim();
			const incidentId = document.getElementById('dt-res-search-incidentId').value.trim();
			const shelterId = currentEditingShelterId;

			// í†µí•© ê´€ë¦¬ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” APIë¥¼ ê·¸ëŒ€ë¡œ í™œìš©í•©ë‹ˆë‹¤.
			// ìƒíƒœëŠ” 'IN'(ì…ì†Œì¤‘)ì¸ ì‚¬ëŒì„ ê¸°ë³¸ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.
			const query = `?page=1&status=IN&shelter_id=${shelterId}&search=${encodeURIComponent(keyword)}`;

			fetch('/api/residents/search' + query)
			.then(r => r.json())
			.then(data => {
				if(data.result === 'ok') {
					// ê²°ê³¼ ë°ì´í„°ë¥¼ íŒ¨ë„ìš© ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
					detailResData = data.list; 
					detailResPage = 1;
					
					// ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ë° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
					document.getElementById('dt-res-count').innerText = data.counts.IN || 0;
					renderDetailResPage();
					
					// ë§Œì•½ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì•Œë¦¼
					if(data.list.length === 0 && keyword !== "") {
						document.getElementById('dt-res-list').innerHTML = `<li class="empty-msg">'${keyword}' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
					}
				}
			})
			.catch(err => console.error("íŒ¨ë„ ê²€ìƒ‰ ì˜¤ë¥˜:", err));
		}
		
		// 1. ì…ë ¥ ë‚´ìš©ì— ë”°ë¼ X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´
		function togglePanelSearchX() {
			var input = document.getElementById('dt-res-search');
			var btn = document.getElementById('btn-panel-res-clear');
			btn.style.display = (input.value.length > 0) ? 'flex' : 'none';
		}

		// 2. ê²€ìƒ‰ì–´ ì´ˆê¸°í™” ë° ë¦¬ìŠ¤íŠ¸ ì¬ë¡œë“œ
		function clearPanelSearch() {
			var input = document.getElementById('dt-res-search');
			input.value = '';
			togglePanelSearchX(); // X ë²„íŠ¼ ìˆ¨ê¸°ê¸°
			
			// ê²€ìƒ‰ì–´ ì—†ì´ ë‹¤ì‹œ ê²€ìƒ‰ ì‹¤í–‰í•˜ì—¬ ì „ì²´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
			searchResidentInPanel();
			input.focus();
		}
        function openDetailPanel(shelterId) {
            closeSupplyPanel();
            currentEditingShelterId = shelterId;
            var panel = document.getElementById('detail-panel');
            var contentDiv = document.getElementById('shelter-detail-content');
			var searchInput = document.getElementById('dt-res-search');
			if(searchInput) {
				searchInput.value = ""; 
				togglePanelSearchX(); // íŒ¨ë„ ìƒˆë¡œ ì—´ ë•Œ X ë²„íŠ¼ ìˆ¨ê¹€
			}
            
            // UI ì´ˆê¸°í™”
            contentDiv.classList.remove('editing'); 
            document.getElementById('btn-edit-mode').style.display = (userRole <= 2) ? 'inline-block' : 'none';
            document.getElementById('edit-actions').style.display = 'none';
            document.getElementById('panel-header-title').innerText = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            panel.classList.add('open');

            fetch(`/api/shelter/${shelterId}/details`).then(r => r.json()).then(data => {
                if(data.result === 'ok') {
                    document.getElementById('panel-header-title').innerText = data.name;
                    // ë³´ê¸° ëª¨ë“œ
                    document.getElementById('v-name').innerText = data.name;
                    document.getElementById('v-addr').innerText = data.address || "-";
                    document.getElementById('v-cap').innerText = data.capacity || "0";
                    document.getElementById('v-lat').innerText = data.lat;
                    document.getElementById('v-lng').innerText = data.lng;
                    // ìˆ˜ì • ëª¨ë“œ
                    document.getElementById('e-name').value = data.name;
                    document.getElementById('e-addr').value = data.address || "";
                    document.getElementById('e-cap').value = data.capacity || 0;
                    document.getElementById('e-lat').value = data.lat;
                    document.getElementById('e-lng').value = data.lng;

                    // ê´€ë¦¬ì ìŠ¤ìœ„ì¹˜
                    var switchArea = document.getElementById('admin-switch-area');
                    switchArea.innerHTML = "";
                    if (userRole <= 2) {
                        var currentLoc = locations.find(l => l.id == shelterId && l.type == 'shelter');
                        var isChecked = currentLoc ? currentLoc.is_active : false;
                        var labelText = isChecked ? "ìš´ì˜ì¤‘" : "ì¤‘ì§€ë¨";
                        switchArea.innerHTML = `<span class="toggle-label">${labelText}</span><label class="toggle-switch"><input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleStatus('shelter', ${shelterId}, '${data.name}')"><span class="slider"></span></label>`;
                    }
                    // [ìˆ˜ì •] ì´ì¬ë¯¼ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§• ì²˜ë¦¬ ì‹œì‘
					detailResData = data.residents; // ì „ì²´ ë°ì´í„° ì €ì¥
					detailResPage = 1;              // 1í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
					document.getElementById('dt-res-count').innerText = detailResData.length;
					
					renderDetailResPage(); // 1í˜ì´ì§€ ë Œë”ë§ í˜¸ì¶œ
                    document.getElementById('dt-res-count').innerText = data.residents.length;
                    renderList('dt-inv-list', data.inventory, (item) => `<span>${item.name}</span> <b>${item.qty}ê°œ</b>`, "ì¬ê³  ì—†ìŒ");
                    renderList('dt-staff-list', data.staff, (item) => `
                    <div style="width:100%;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>
                                <strong>${item.name}</strong> 
                                <small style="color:#718096;">(${item.dept || 'ì†Œì†ì—†ìŒ'})</small>
                            </span>

                            <div style="display:flex; align-items:center; gap:5px;">
                                <div style="font-size:12px; color:#4a5568;">ğŸ“‹ ${item.mission || 'ì¼ë°˜ì„ë¬´'}</div>
                                <button class="btn-del-mini" onclick="deleteStaff(${item.id})" title="ê·¼ë¬´ì ì‚­ì œ">Ã—</button>
                            </div>
                        </div>
                    </div>
                `, "í˜„ì¬ ê·¼ë¬´ì ì—†ìŒ");
                } else {
                    alert("ì •ë³´ ë¡œë”© ì‹¤íŒ¨: " + data.msg); closeDetailPanel();
                }
            });
        }
		// [New] êµ¬í˜¸ì†Œ íŒ¨ë„ ì´ì¬ë¯¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©)
		function renderDetailResPage() {
			var listContainer = document.getElementById('dt-res-list');
			var pageContainer = document.getElementById('dt-res-pagination');
			
			// ë°ì´í„°ê°€ ì—†ì„ ê²½ìš°
			if (!detailResData || detailResData.length === 0) {
				listContainer.innerHTML = '<li class="empty-msg">í˜„ì¬ ì…ì†Œí•œ ì´ì¬ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
				pageContainer.innerHTML = '';
				return;
			}

			// 1. í˜„ì¬ í˜ì´ì§€ ë°ì´í„° ìŠ¬ë¼ì´ì‹±
			var start = (detailResPage - 1) * DETAIL_ITEMS_PER_PAGE;
			var end = start + DETAIL_ITEMS_PER_PAGE;
			var pageItems = detailResData.slice(start, end);

			// 2. ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
			listContainer.innerHTML = pageItems.map(item => {
				let alertDot = item.note ? `<span style="color:#e53e3e; margin-left:4px;">â—</span>` : '';
				return `
					<div class="res-item-row" onclick="openResidentInfoPanel(${item.id})">
						<div class="res-simple-info">
							<span class="res-status-dot"></span>
							<strong>${item.name}</strong>
							${alertDot} <span class="res-sub-text">(${item.gender}, ${item.age || '?'})</span>
						</div>
						<div class="res-sub-text">
							${item.time}
						</div>
						<div style="color:#cbd5e0;">â€º</div>
					</div>
				`;
			}).join('');

			// 3. í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìƒì„±
			var totalPages = Math.ceil(detailResData.length / DETAIL_ITEMS_PER_PAGE);
			if (totalPages <= 1) {
				pageContainer.innerHTML = ''; // 1í˜ì´ì§€ë¿ì´ë©´ ë²„íŠ¼ ìˆ¨ê¹€
				return;
			}

			var html = '';
			
			// [ì´ì „] ë²„íŠ¼
			html += `<button class="mini-page-btn" onclick="changeDetailPage(${detailResPage - 1})" ${detailResPage === 1 ? 'disabled' : ''}>&lt;</button>`;

			// [í˜ì´ì§€ ë²ˆí˜¸] (ë„ˆë¬´ ë§ìœ¼ë©´ ... ì²˜ë¦¬ë¥¼ í•  ìˆ˜ë„ ìˆì§€ë§Œ, íŒ¨ë„ìš©ì´ë¼ ê°„ë‹¨íˆ ì „ì²´ í‘œì‹œí•˜ê±°ë‚˜ 5ê°œë§Œ í‘œì‹œ)
			// ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì „ì²´ í‘œì‹œí•˜ë˜, ë°ì´í„°ê°€ 100ê±´ ë„˜ì–´ê°€ë©´ ë¡œì§ ì¶”ê°€ í•„ìš”. ì¼ë‹¨ì€ ë‹¨ìˆœ ë£¨í”„.
			let startPage = Math.max(1, detailResPage - 2);
			let endPage = Math.min(totalPages, startPage + 4);
			
			// ì‹œì‘ í˜ì´ì§€ ë³´ì •
			if (endPage - startPage < 4) {
				startPage = Math.max(1, endPage - 4);
			}

			for (let i = startPage; i <= endPage; i++) {
				html += `<button class="mini-page-btn ${i === detailResPage ? 'active' : ''}" onclick="changeDetailPage(${i})">${i}</button>`;
			}

			// [ë‹¤ìŒ] ë²„íŠ¼
			html += `<button class="mini-page-btn" onclick="changeDetailPage(${detailResPage + 1})" ${detailResPage === totalPages ? 'disabled' : ''}>&gt;</button>`;

			pageContainer.innerHTML = html;
		}

		// í˜ì´ì§€ ë³€ê²½ í•¨ìˆ˜
		function changeDetailPage(newPage) {
			var totalPages = Math.ceil(detailResData.length / DETAIL_ITEMS_PER_PAGE);
			if (newPage < 1 || newPage > totalPages) return;
			
			detailResPage = newPage;
			renderDetailResPage();
		}

        function closeDetailPanel() { 
            document.getElementById('detail-panel').classList.remove('open');
            
            // [ì¶”ê°€] ë¶€ëª¨ íŒ¨ë„ì´ ë‹«íˆë©´ ìì‹(ì´ì¬ë¯¼ ìƒì„¸) íŒ¨ë„ë„ ê°™ì´ ë‹«ê¸°
            if (typeof closeResidentInfoPanel === 'function') {
                closeResidentInfoPanel();
            }
        }
        function enableEditMode() {
            document.getElementById('shelter-detail-content').classList.add('editing');
            document.getElementById('btn-edit-mode').style.display = 'none';
            document.getElementById('edit-actions').style.display = 'flex';
        }
        function cancelEditMode() {
            document.getElementById('shelter-detail-content').classList.remove('editing');
            document.getElementById('btn-edit-mode').style.display = 'inline-block';
            document.getElementById('edit-actions').style.display = 'none';
        }
        function saveShelterInfo() {
            var id = currentEditingShelterId;
            var payload = {
                name: document.getElementById('e-name').value,
                address: document.getElementById('e-addr').value,
                capacity: document.getElementById('e-cap').value,
                lat: document.getElementById('e-lat').value,
                lng: document.getElementById('e-lng').value
            };
            if(!payload.name) return alert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            fetch(`/api/shelter/${id}/update`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            }).then(r => r.json()).then(data => {
                if(data.result === 'ok') { openDetailPanel(id); updateDashboardData(); } 
                else { alert("ì˜¤ë¥˜: " + data.msg); }
            });
        }
		
		// 1. ê·¼ë¬´ì ë“±ë¡ í¼ í† ê¸€
		function toggleStaffForm() {
			if(userRole > 2) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
			var form = document.getElementById('staff-reg-form');
			form.classList.toggle('show');
			if(form.classList.contains('show')) document.getElementById('reg-staff-name').focus();
		}

		// 2. ê·¼ë¬´ì ë“±ë¡ ì‹¤í–‰
		function registerStaff() {
			const incident_id = document.getElementById('incident_id').value;
			const name = document.getElementById('reg-staff-name').value.trim();
			const dept = document.getElementById('reg-staff-dept').value.trim();
			const phone = document.getElementById('reg-staff-phone').value.trim();
			const missionEl = document.getElementById('reg-staff-mission');
			if (!missionEl) {
				console.error("ID 'reg-staff-mission' ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
				return;
			}
			const mission = missionEl.value;
			if(!name) return alert("ê·¼ë¬´ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

			fetch('/api/staff/register', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					incident_id: incident_id,
					shelter_id: currentEditingShelterId,
					name: name,
					dept: dept,
					phone: phone,
					mission: mission
				})
			})
			.then(r => r.json())
			.then(data => {
				if(data.result === 'ok') {
					// í¼ ì´ˆê¸°í™” ë° ë‹«ê¸°
					document.getElementById('reg-staff-name').value = '';
					document.getElementById('reg-staff-dept').value = '';
					document.getElementById('reg-staff-phone').value = '';
					document.getElementById('reg-staff-mission').value = '';
					toggleStaffForm();
					
					// ëª©ë¡ ê°±ì‹ 
					openDetailPanel(currentEditingShelterId);
					updateDashboardData();
				} else {
					alert("ë“±ë¡ ì‹¤íŒ¨: " + data.msg);
				}
			})
			.catch(err => console.error("ê·¼ë¬´ì ë“±ë¡ ì—ëŸ¬:", err));
		}

        // ------------------------------------------------------------
        // 6. ê¸°ëŠ¥ë³„ ë¡œì§: ë¬¼í’ˆ ê´€ë¦¬
        // ------------------------------------------------------------
        function openSupplyPanel() {
            if (userRole > 2) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            closeDetailPanel();
            document.getElementById('supply-panel').classList.add('open');
            loadHqSupplies();
        }
        function closeSupplyPanel() { document.getElementById('supply-panel').classList.remove('open'); }
        function loadHqSupplies() {
            var container = document.getElementById('hq-supply-list');
            container.innerHTML = "<div class='empty-msg'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
			const incident_id = document.getElementById('incident_id').value;
            fetch('/api/supplies/hq?incident_id='+incident_id).then(r => r.json()).then(data => {
                if(data.result === 'ok') renderSupplyCards(data.supplies, data.shelters);
                else container.innerHTML = "<div class='empty-msg'>ì˜¤ë¥˜ ë°œìƒ</div>";
            });
        }
        function addHqSupply() {
            var name = document.getElementById('new-item-name').value.trim();
            var qty = document.getElementById('new-item-qty').value;
            if(!name || !qty) return alert("ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            fetch('/api/supplies/add_hq', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_name: name, quantity: qty })
            }).then(r => r.json()).then(data => {
                if(data.result === 'ok') { 
					//alert(data.msg); 
					document.getElementById('new-item-name').value=''; 
					document.getElementById('new-item-qty').value=''; 
					loadHqSupplies(); 
				}
                else alert("ì‹¤íŒ¨: " + data.msg);
            });
        }
        function renderSupplyCards(supplies, shelters) {
			var container = document.getElementById('hq-supply-list');
			if(!supplies || supplies.length === 0) { 
				container.innerHTML = "<div class='empty-msg'>ì¬ê³  ì—†ìŒ</div>"; 
				return; 
			}

			var options = shelters.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
			
			container.innerHTML = supplies.map(item => `
				<div class="supply-card-item">
					<div class="supply-row-main">
						<div class="supply-name-group">
							<span class="supply-name">${item.name}</span>
						</div>
						<div class="supply-action-group">
							<div class="supply-total-box">
								<span class="supply-total">${item.qty}</span><span class="unit">ê°œ</span>
							</div>
							<input type="number" id="inp-stock-in-${item.id}" class="mini-input" placeholder="ì…ê³ ëŸ‰">
							<button class="btn-mini btn-green" onclick="addHqStock('${item.name}', ${item.id})">ì…ê³ </button>
						</div>
					</div>

					<div class="supply-row-sub">
						<select id="sel-target-${item.id}" class="mini-select">
							<option value="">::ë°°ë¶„í•  êµ¬í˜¸ì†Œ ì„ íƒ::</option>
							${options}
						</select>
						<div class="supply-action-group">
							<input type="number" id="inp-qty-${item.id}" class="mini-input" placeholder="ë°°ë¶„ëŸ‰" min="1" max="${item.qty}">
							<button class="btn-mini btn-blue" onclick="distributeSupply('${item.name}', ${item.id})">ë°°ë¶„</button>
						</div>
					</div>
				</div>
			`).join('');
		}
        function addHqStock(name, id) {
            var qty = document.getElementById(`inp-stock-in-${id}`).value;
            if(!qty) return alert("ìˆ˜ëŸ‰ ì…ë ¥");
            fetch('/api/supplies/add_hq', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ item_name: name, quantity: qty })
            }).then(r => r.json()).then(data => {
                if(data.result === 'ok') { 
					//alert("ì…ê³  ì™„ë£Œ"); 
					loadHqSupplies(); 
				} else alert(data.msg);
            });
        }
        function distributeSupply(name, id) {
            var target = document.getElementById(`sel-target-${id}`).value;
            var qty = document.getElementById(`inp-qty-${id}`).value;
			var incident_id = document.getElementById('incident_id').value;
            if(!target || !qty) return alert("ì •ë³´ ì…ë ¥");
            if(!confirm(`[${name}] ${qty}ê°œë¥¼ ë°°ë¶„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            fetch('/api/supplies/distribute', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ incident_id:incident_id, item_name: name, quantity: qty, target_id: target })
            }).then(r => r.json()).then(data => {
                if(data.result === 'ok') { 
					//alert(data.msg); 
					loadHqSupplies(); 
				} else alert(data.msg);
            });
        }

        // ------------------------------------------------------------
        // 7. ê¸°íƒ€ ê¸°ëŠ¥: ì‚¬ì´ë“œë°”, ì•Œë¦¼, ìœ í‹¸ë¦¬í‹°
        // ------------------------------------------------------------
        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            sb.classList.toggle('collapsed');
            document.querySelector('.toggle-btn').innerHTML = sb.classList.contains('collapsed') ? 'â–¶' : 'â—€';
            setTimeout(() => map.relayout(), 300);
        }

        function toggleMapVisibility(key) {
            var item = markerManager[key];
            if (!item) return;
            item.visible = !item.visible;
            item.overlay.setMap(item.visible ? map : null);
            var ui = document.getElementById('panel-' + key);
            item.visible ? ui.classList.remove('hidden-map') : ui.classList.add('hidden-map');
        }

        function toggleStatus(type, id, name) {
            //if(!confirm(`'${name}' ìƒíƒœ ë³€ê²½?`)) return;
            fetch('/api/map/toggle_status', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: type, id: id })
            }).then(r => r.json()).then(data => {
                if(data.result !== 'ok') alert("ì‹¤íŒ¨: " + data.msg);
                // ì†Œì¼“ updateê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„  alert ìƒëµ ê°€ëŠ¥
            });
        }

        // ì•Œë¦¼ íŒ¨ë„
        var isNotiCollapsed = true;
        function togglePanel(e) {
            if (e.target.tagName === 'BUTTON') return;
            var panel = document.getElementById('notification-panel');
            var icon = document.getElementById('toggle-icon');
            isNotiCollapsed = !isNotiCollapsed;
            panel.style.bottom = isNotiCollapsed ? '-140px' : '-1px';
            icon.innerText = isNotiCollapsed ? 'â–²' : 'â–¼';
        }
        function handleNotification(data) {
            let saved = JSON.parse(localStorage.getItem('shelter_notifications{{incident_id}}') || '[]');
			if({{incident_id}}==data.incident_id){
				saved.unshift(data);
				if (saved.length > 50) saved.pop();
				localStorage.setItem('shelter_notifications{{incident_id}}', JSON.stringify(saved));
				renderNotifications(saved);
			}
        }
        function renderNotifications(dataArray) {
            var list = document.getElementById('notification-list');
            if (dataArray.length === 0) { list.innerHTML = '<div class="empty-msg">ì•Œë¦¼ ì—†ìŒ</div>'; return; }
            list.innerHTML = dataArray.map(d => `
                <div style="background:white; padding:12px; border-radius:10px; margin-bottom:10px; border-left:5px solid ${d.color||'#3498db'}; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between;"><strong style="font-size:0.9rem;">${d.icon||''} ${d.message}</strong><small style="color:#999;">${d.time}</small></div>
                </div>`).join('');
        }
        function clearNotifications() { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem('shelter_notifications{{incident_id}}'); renderNotifications([]); } }

        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        function drawPathAndAddToLegend(path, sName, eName) {
            var color = ROUTE_COLORS[colorIndex++ % ROUTE_COLORS.length];
            var poly = new kakao.maps.Polyline({ path: path, strokeWeight: 5, strokeColor: color, strokeOpacity: 0.8 });
            poly.setMap(map);
            var arrows = createArrowsOnPath(path, color);
            var rid = `route_${routeCount++}`;
            routeManager[rid] = { polyline: poly, arrows: arrows, visible: true };
            
            var div = document.createElement('div');
            div.className = 'route-item';
            div.id = 'legend-' + rid;
            div.onclick = function() { 
                var r = routeManager[rid]; r.visible = !r.visible;
                r.polyline.setMap(r.visible ? map : null);
                r.arrows.forEach(a => a.setMap(r.visible ? map : null));
                div.classList.toggle('hidden', !r.visible);
            };
            div.innerHTML = `<div class="color-box" style="background:${color};"></div><div><b>${sName}</b> â†’ ${eName}</div>`;
            document.getElementById('legend-list').appendChild(div);
			
        }
        function createArrowsOnPath(path, color) {
            var arrows = [];
            for (var i=0; i<path.length-10; i+=10) {
                var p1 = path[i], p2 = path[i+5]; if(!p2) continue;
                var dy = p2.getLat() - p1.getLat(), dx = p2.getLng() - p1.getLng();
                var ang = Math.atan2(dy, dx) * 180 / Math.PI;
                var content = `<div class="arrow-overlay" style="color:${color}; transform: rotate(${-ang}deg);">â¤</div>`;
                arrows.push(new kakao.maps.CustomOverlay({ map: map, position: p1, content: content, yAnchor:0.5, xAnchor:0.5 }));
            }
            return arrows;
        }

        // ì—°ê²° ëª¨ë“œ
        window.startConnectModeId = function(id) {
            var item = markerManager['assembly_' + id];
            if(item) {
                if(currentInfowindow) currentInfowindow.close();
                pendingSourceNode = item.data;
                document.getElementById('connect-guide').style.display = 'block';
            }
        }
        window.cancelConnect = function() {
            pendingSourceNode = null;
            document.getElementById('connect-guide').style.display = 'none';
        }
        function completeConnection(target) {
            var source = pendingSourceNode;
            
            if(confirm(`[${source.name}] â¡ï¸ [${target.name}]\nì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                
                // [ë³€ê²½] URLì„ ì‚¬ìš©ìë¶„ì˜ ì‹¤ì œ API ì£¼ì†Œ(/api/map/connect)ë¡œ ë§ì¶¤
                fetch('/api/map/connect', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ assembly_id: source.id, shelter_id: target.id }) 
                })
                .then(r => r.json())
                .then(data => {
                    if(data.result === 'ok') {
                        // ì„œë²„ê°€ ê³„ì‚°í•´ì„œ ë³´ë‚´ì¤€ path_dataê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ê·¸ë¦¬ê¸°
                        if (data.path_data && data.path_data.length > 0) {
                            var linePath = data.path_data.map(p => new kakao.maps.LatLng(p.lat, p.lng));
                            
                            // ì´ë¯¸ ìˆëŠ” ê²½ë¡œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
                            drawPathAndAddToLegend(linePath, source.name, target.name);
                        }
                        
                        //alert("ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        alert("ì˜¤ë¥˜: " + data.msg);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
                });
            }
            
            cancelConnect();
        }

        // ì¸í¬ìœˆë„ìš° (ì§‘ê²°ì§€)
        function openInfoWindow(loc, coords) {
            if(currentInfowindow) currentInfowindow.close();
            var content = document.createElement('div');
            var color = loc.is_active ? '#e74c3c' : '#777';
            var html = `<div class="iw-container"><span class="iw-title" style="color:${color}">${loc.name}</span>`;
            if(userRole <= 2) {
                html += `<div class="iw-controls">`;
                if(loc.is_active) html += `<button class="iw-btn-action btn-connect" onclick="startConnectModeId(${loc.id})">ğŸ”— êµ¬í˜¸ì†Œ ì—°ê²°</button>`;
                html += `<button class="iw-btn-action ${loc.is_active?'btn-stop':'btn-start'}" onclick="toggleStatus('${loc.type}',${loc.id},'${loc.name}')">${loc.is_active?'â›” ìš´ì˜ ì¤‘ì§€':'âœ… ìš´ì˜ ì¬ê°œ'}</button></div>`;
            }
            html += `</div>`;
            content.innerHTML = html;
            var iw = new kakao.maps.InfoWindow({ content: content, position: coords, removable: true, zIndex: 10 });
            iw.open(map); currentInfowindow = iw;
        }

        // ë°ì´í„° ê°±ì‹  (ì†Œì¼“ ìˆ˜ì‹  ì‹œ í˜¸ì¶œ)
        function updateDashboardData() {
			const incident_id = document.getElementById('incident_id').value;
            fetch('/api/map/refresh_data/'+incident_id).then(r => r.json()).then(data => {
                if(data.result !== 'ok') return;
                document.getElementById('val-residents').innerText = data.summary.residents;
                document.getElementById('val-supplies').innerText = data.summary.supplies;
                document.getElementById('val-shelters').innerText = data.summary.shelters;
                document.getElementById('val-assemblies').innerText = data.summary.assemblies;

                data.locations.forEach(loc => {
                    var key = loc.type + '_' + loc.id;
                    var item = markerManager[key];
                    if (item) {
                        item.data.is_active = loc.is_active;
                        item.data.stat_resident = loc.stat_resident;
                        item.data.stat_staff = loc.stat_staff;
                        
                        // ë§ˆì»¤ ìŠ¤íƒ€ì¼
                        loc.is_active ? item.div.classList.remove('grayscale') : item.div.classList.add('grayscale');
                        
                        // íŒ¨ë„ ìŠ¤íƒ€ì¼
                        var panelItem = document.getElementById('panel-' + key);
                        if(panelItem) {
                            loc.is_active ? panelItem.classList.remove('inactive') : panelItem.classList.add('inactive');
                            if(loc.type==='shelter' && (loc.stat_resident || loc.stat_staff)) {
                                panelItem.querySelector('.stat-badge').innerText = `ğŸ‘¥ ${loc.stat_resident}ëª…`;
                                panelItem.querySelector('.staff-badge').innerText = `ğŸ‘® ${loc.stat_staff}ëª…`;
                            }
                        }
                    }
                });
            });
        }
        
        function renderList(eid, arr, tmpl, empty) {
            var el = document.getElementById(eid);
            el.innerHTML = (!arr || arr.length==0) ? `<li class="empty-msg">${empty}</li>` : arr.map(i=>`<li>${tmpl(i)}</li>`).join('');
        }

        // ì´ˆê¸° ì•Œë¦¼ ë¡œë“œ
        document.addEventListener("DOMContentLoaded", () => {
            var saved = JSON.parse(localStorage.getItem('shelter_notifications{{incident_id}}') || '[]');
            renderNotifications(saved);
        });

        // ìš°í´ë¦­ ë©”ë‰´
        if (userRole <= 2) {
            kakao.maps.event.addListener(map, 'rightclick', function(e) {
                clickedLat = e.latLng.getLat(); clickedLng = e.latLng.getLng();
                var m = document.getElementById('contextMenu');
                m.style.display = 'block'; m.style.left = event.clientX + 'px'; m.style.top = event.clientY + 'px';
            });
        }
        kakao.maps.event.addListener(map, 'click', function() { 
            document.getElementById('contextMenu').style.display = 'none'; 
            if(currentInfowindow) currentInfowindow.close(); 
            closeDetailPanel(); closeSupplyPanel();
        });
        
        // [ìˆ˜ì •] ìš°í´ë¦­ìœ¼ë¡œ ë…¸ë“œ ì¶”ê°€ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜)
        window.addNode = function(type) {
            // 1. ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
			const incident_id = document.getElementById('incident_id').value;
            document.getElementById('contextMenu').style.display = 'none';
            
            var typeName = type === 'shelter' ? 'ğŸ¥êµ¬í˜¸ì†Œ' : 'ğŸš©ì§‘ê²°ì§€';
            var name = prompt(`${typeName} ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” :`);
            
            if (name) {
                fetch('/api/map/add_node', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ incident_id:incident_id, type: type, name: name, lat: clickedLat, lng: clickedLng })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.result === 'ok') {
                        // alert(data.msg); // ì„±ê³µ ë©”ì‹œì§€ëŠ” ìƒëµí•˜ê±°ë‚˜ í•„ìš” ì‹œ ì£¼ì„ í•´ì œ

                        // 2. [í•µì‹¬] ìƒˆë¡œê³ ì¹¨(location.reload) ëŒ€ì‹  ë¡œì»¬ì—ì„œ ê°ì²´ ìƒì„±
                        var newLoc = {
                            id: data.id,           // ì„œë²„ì—ì„œ ë¦¬í„´ë°›ì€ ID (app.pyì—ì„œ idë¥¼ ë¦¬í„´í•´ì¤˜ì•¼ í•¨)
                            name: name,
                            lat: clickedLat,
                            lng: clickedLng,
                            type: type,
                            is_active: true,       // ì‹ ê·œ ë“±ë¡ì€ ê¸°ë³¸ í™œì„± ìƒíƒœ
                            route_infos: [],       // ê²½ë¡œ ì •ë³´ ì—†ìŒ
                            stat_resident: 0,      // ì´ˆê¸°ê°’ 0
                            stat_staff: 0          // ì´ˆê¸°ê°’ 0
                        };

                        // 3. ì „ì—­ locations ë°°ì—´ì— ì¶”ê°€ (ì¶”í›„ í•„í„°ë§/ê²€ìƒ‰ ë“±ì„ ìœ„í•´)
                        locations.push(newLoc);

                        // 4. ë§ˆì»¤ ìƒì„± ë° ì¢Œì¸¡ íŒ¨ë„ ë“±ë¡ í•¨ìˆ˜ í˜¸ì¶œ
                        // (ì´ í•¨ìˆ˜ê°€ ì§€ë„ì— í•€ë„ ì°ê³ , ì™¼ìª½ ëª©ë¡ì—ë„ ì¶”ê°€í•´ ì¤ë‹ˆë‹¤)
                        createCustomMarker(new kakao.maps.LatLng(clickedLat, clickedLng), newLoc);
                        
                        // 5. ëŒ€ì‹œë³´ë“œ í†µê³„ ì¦‰ì‹œ ê°±ì‹  (ì„ íƒì‚¬í•­)
                        //updateDashboardData();

                    } else { 
                        alert("ì˜¤ë¥˜: " + data.msg); 
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
            }
        };
		
		// ============================================================
        // [New] ì´ì¬ë¯¼ ì…ì†Œ ë“±ë¡ ê´€ë¦¬ ë¡œì§
        // ============================================================

        // 1. ë“±ë¡ í¼ ì—´ê¸°/ë‹«ê¸°
        function toggleResidentForm() {
            if(userRole > 2) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            var form = document.getElementById('resident-reg-form');
            var isClosed = !form.classList.contains('show');
            
            if(isClosed) {
                form.classList.add('show');
                document.getElementById('reg-res-name').focus(); // í¬ì»¤ìŠ¤ ì´ë™
            } else {
                form.classList.remove('show');
            }
        }

        // 2. ì„¸ëŒ€ì£¼/ì„¸ëŒ€ì› ë¼ë””ì˜¤ ë²„íŠ¼ì— ë”°ë¥¸ UI ë³€í™”
        function toggleHeadPhoneInput() {
            var role = document.querySelector('input[name="fam_role"]:checked').value;
            var headInputDiv = document.getElementById('head-phone-row');
            
            if (role === 'ì„¸ëŒ€ì›') {
                headInputDiv.style.display = 'block';
            } else {
                headInputDiv.style.display = 'none';
                document.getElementById('reg-head-phone').value = ''; // ê°’ ì´ˆê¸°í™”
            }
        }

        // 3. ì…ì†Œ ë“±ë¡ ì‹¤í–‰ (API í˜¸ì¶œ)
        function registerResident() {
			const incident_id = document.getElementById('incident_id').value;
			var name = document.getElementById('reg-res-name').value.trim();
			var age = document.getElementById('reg-res-age').value;
			var gender = document.getElementById('reg-res-gender').value;
			var phone = document.getElementById('reg-res-phone').value;
			var note = document.getElementById('reg-res-note').value;
			
			var role = document.querySelector('input[name="fam_role"]:checked').value;
			var headPhone = document.getElementById('reg-head-phone').value.trim();

			// ìœ íš¨ì„± ê²€ì‚¬
			if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			if(role === 'ì„¸ëŒ€ì›' && !headPhone) return alert("ì„¸ëŒ€ì›ì€ 'ì„¸ëŒ€ì£¼ ì—°ë½ì²˜' ì…ë ¥ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.");

			fetch('/api/resident/register', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					incident_id: incident_id,
					shelter_id: currentEditingShelterId,
					name: name,
					age: age,
					gender: gender,
					phone: phone,
					note: note,
					family_role: role,
					head_phone: headPhone
				})
			})
			.then(r => r.json())
			.then(data => {
				if(data.result === 'ok') {
					// [ì¶”ê°€] 1. í¼ ë‹«ê¸°
					var form = document.getElementById('resident-reg-form');
					form.classList.remove('show');
					
					// 2. ì…ë ¥ì°½ ì´ˆê¸°í™”
					document.getElementById('reg-res-name').value = '';
					document.getElementById('reg-res-age').value = '';
					document.getElementById('reg-res-phone').value = '';
					document.getElementById('reg-res-note').value = '';
					document.getElementById('reg-head-phone').value = ''; // ì„¸ëŒ€ì£¼ ì—°ë½ì²˜ ì´ˆê¸°í™” ì¶”ê°€
					
					// 3. ì„¸ëŒ€ì£¼ ëª¨ë“œë¡œ ë¼ë””ì˜¤ ë²„íŠ¼ ë¦¬ì…‹
					document.querySelector('input[name="fam_role"][value="ì„¸ëŒ€ì£¼"]').checked = true;
					toggleHeadPhoneInput(); // ì„¸ëŒ€ì£¼ ì—°ë½ì²˜ ì…ë ¥ì¹¸ ìˆ¨ê¹€ ì²˜ë¦¬
					
					// 4. ì¦‰ì‹œ ëª©ë¡ ê°±ì‹ 
					openDetailPanel(currentEditingShelterId);
					
					// 5. ëŒ€ì‹œë³´ë“œ í†µê³„ ê°±ì‹  ì¶”ê°€ (ì´ì¬ë¯¼ ìˆ˜ ë³€ë™ ë°˜ì˜)
					updateDashboardData();
				} else {
					alert("ë“±ë¡ ì‹¤íŒ¨: " + data.msg);
				}
			})
			.catch(err => {
				console.error(err);
				alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			});
		}
		
		// [New] ì´ì¬ë¯¼ ìƒíƒœ ë³€ê²½ (í‡´ì†Œ/ë³‘ì›)
        function changeResidentStatus(incident_id, residentId, residentName, status) {
            let actionName = "";
            let subMsg = "";

            // 3ê°€ì§€ ìƒíƒœì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ë¶„ê¸° ì²˜ë¦¬
            if (status === 'OUT') {
                actionName = "í‡´ì†Œ(ê·€ê°€)";
                subMsg = "ê´€ë¦¬ ëª©ë¡ì—ì„œ 'í‡´ì†Œì™„ë£Œ' íƒ­ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.";
            } else if (status === 'HOSPITAL') {
                actionName = "ë³‘ì› ì´ì†¡";
                subMsg = "ê´€ë¦¬ ëª©ë¡ì—ì„œ 'ë³‘ì›ì´ì†¡' íƒ­ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.";
            } else if (status === 'IN') {
                actionName = "êµ¬í˜¸ì†Œ ë³µê·€(ì¬ì…ì†Œ)";
                subMsg = "ë‹¤ì‹œ 'ì…ì†Œì¤‘' ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.";
            }
            if (!confirm(`[${residentName}] ë‹˜ì„ ì •ë§ '${actionName}' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
			
            fetch('/api/resident/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
					incident_id: incident_id,
                    resident_id: residentId,
                    shelter_id: currentManagerShelterId || currentEditingShelterId, // í˜„ì¬ ë³´ê³  ìˆëŠ” êµ¬í˜¸ì†Œ ID ì‚¬ìš©
                    status: status
                })
            })
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    // alert(data.msg); // (ì„ íƒì‚¬í•­) ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ê·€ì°®ìœ¼ë¯€ë¡œ ìƒëµ ê°€ëŠ¥
                    
                    // 1. ëª¨ë‹¬ì´ ì—´ë ¤ìˆë‹¤ë©´ ëª¨ë‹¬ ë°ì´í„° ê°±ì‹ 
                    if(document.getElementById('resident-manager-modal').classList.contains('show')) {
                        fetchManagerData(); // í˜„ì¬ í˜ì´ì§€/íƒ­ ìœ ì§€í•˜ë©° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                    }
                    
                    // 2. ë©”ì¸ ì‚¬ì´ë“œë°”(êµ¬í˜¸ì†Œ íŒ¨ë„)ë„ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ 
                    if(currentEditingShelterId) {
                        openDetailPanel(currentEditingShelterId);
                    }
					
					if(document.getElementById('resident-info-panel').classList.contains('open')) {
						closeResidentInfoPanel();
					}
                    
                    // 3. ì§€ë„ í†µê³„ ê°±ì‹ 
                    updateDashboardData();
                    
                } else {
                    alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + data.msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            });
        }
		// ============================================================
        // [New] ëª¨ë‹¬ ê´€ë¦¬ì (ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§• ì ìš©)
        // ============================================================
        
        // ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
        var mgrState = {
            page: 1,
            status: 'IN',
            shelterId: 0,
            search: ''
        };
        
        // 1. ëª¨ë‹¬ ì—´ê¸°
        function openManagerModal(shelterId) {
            var modal = document.getElementById('resident-manager-modal');
            
            // ì´ˆê¸°ê°’ ì„¤ì •
            mgrState.shelterId = (typeof shelterId !== 'undefined') ? shelterId : 0;
            mgrState.page = 1;
            mgrState.status = 'IN';
            mgrState.search = '';
			document.getElementById('mgr-search').value = '';
            toggleSearchClearBtn();

            // êµ¬í˜¸ì†Œ ë“œë¡­ë‹¤ìš´ êµ¬ì„±
            var select = document.getElementById('mgr-shelter-select');
            select.innerHTML = '<option value="0">ğŸ¢ ì „ì²´ êµ¬í˜¸ì†Œ í†µí•©</option>';
            locations.forEach(loc => {
                if(loc.type === 'shelter') {
                    var option = document.createElement('option');
                    option.value = loc.id;
                    option.text = loc.name;
                    select.appendChild(option);
                }
            });
            select.value = mgrState.shelterId; 

            // íƒ­ UI ì´ˆê¸°í™”
            updateTabUI();
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            
            // ë°ì´í„° ë¡œë“œ
            fetchManagerData();
        }

        function closeManagerModal() {
            var modal = document.getElementById('resident-manager-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 200);
            
            // ë©”ì¸í™”ë©´ ê°±ì‹  (ë³€ê²½ì‚¬í•­ ë°˜ì˜)
            if(currentEditingShelterId) openDetailPanel(currentEditingShelterId);
            updateDashboardData();
        }

        // 2. ì„œë²„ ë°ì´í„° ìš”ì²­ (í•µì‹¬)
        function fetchManagerData() {
            var grid = document.getElementById('mgr-card-grid');
            grid.innerHTML = '<div style="text-align:center; padding:50px; width:100%; grid-column:1/-1;">â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            // API í˜¸ì¶œ (ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì¡°í•©)
            var query = `?page=${mgrState.page}&status=${mgrState.status}&shelter_id=${mgrState.shelterId}&search=${encodeURIComponent(mgrState.search)}`;

            fetch('/api/residents/search' + query)
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    // íƒ­ ì¹´ìš´íŠ¸ ê°±ì‹ 
                    if (data.counts) {
                        document.getElementById('cnt-IN').innerText = data.counts.IN || 0;
                        document.getElementById('cnt-HOSPITAL').innerText = data.counts.HOSPITAL || 0;
                        document.getElementById('cnt-OUT').innerText = data.counts.OUT || 0;
                    }
                    
                    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                    renderManagerCards(data.list);
                    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
                    renderPagination(data.total_pages, data.current_page);
                } else {
                    grid.innerHTML = '<div style="text-align:center; padding:50px; color:red;">' + data.msg + '</div>';
                }
            })
            .catch(err => {
                console.error(err);
                grid.innerHTML = '<div style="text-align:center; padding:50px; color:red;">ì„œë²„ í†µì‹  ì˜¤ë¥˜</div>';
            });
        }

        // 3. ì¹´ë“œ ë Œë”ë§
        function renderManagerCards(list) {
            var grid = document.getElementById('mgr-card-grid');
            
            if(!list || list.length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding:50px; width:100%; grid-column:1/-1; color:#999;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            grid.innerHTML = list.map(item => `
                <div class="data-card">
                    <div class="card-title">
                        <div style="display:flex; align-items:center; gap:5px;">
                            ${item.name} 
                            <span style="font-size:13px; font-weight:normal; color:#555;">(${item.gender}, ${item.age})</span>
                        </div>
                        ${item.note ? '<span style="font-size:18px; cursor:help; color:#e74c3c;" title="'+item.note+'">âš ï¸</span>' : ''}
                    </div>
                    
                    <div class="card-meta">
                        <div style="font-weight:bold; color:#2980b9; margin-bottom:4px;">ğŸ  ${item.shelter_name}</div>
                        ğŸ“ ${item.phone || '-'} <br>
                        ${getStatusBadge(item.status, item.time)}
                    </div>
                    
                    ${item.note ? '<div style="font-size:11px; color:#c0392b; background:#fff5f5; padding:4px; border-radius:4px; margin-top:5px;">âš ï¸ '+item.note+'</div>' : ''}

                    <div class="card-actions">
                        ${getActionButtons(item.incident_id, item.id, item.name, item.shelter_id)}
                    </div>
                </div>
            `).join('');
        }

        // 4. í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        function renderPagination(totalPages, currentPage) {
            var container = document.getElementById('mgr-pagination');
            container.innerHTML = "";
            
            if (totalPages <= 1) return;

            // [ì´ì „]
            if(currentPage > 1) {
                container.innerHTML += `<button class="page-btn" onclick="goToPage(${currentPage-1})">&lt;</button>`;
            }

            // [í˜ì´ì§€ ë²ˆí˜¸] (ê°„ì†Œí™”)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            for(var i=startPage; i<=endPage; i++) {
                var activeClass = (i === currentPage) ? 'active' : '';
                container.innerHTML += `<button class="page-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
            }

            // [ë‹¤ìŒ]
            if(currentPage < totalPages) {
                container.innerHTML += `<button class="page-btn" onclick="goToPage(${currentPage+1})">&gt;</button>`;
            }
        }

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        function switchManagerTab(status) {
            mgrState.status = status;
            mgrState.page = 1; 
            updateTabUI();
            fetchManagerData();
        }
        
        function updateTabUI() {
            document.querySelectorAll('.status-tab').forEach(el => el.className = 'status-tab');
            var activeClass = mgrState.status === 'IN' ? 'active-in' : (mgrState.status === 'HOSPITAL' ? 'active-hosp' : 'active-out');
            document.getElementById('tab-' + mgrState.status).classList.add(activeClass);
        }

        function changeManagerShelter() {
            var select = document.getElementById('mgr-shelter-select');
            mgrState.shelterId = parseInt(select.value);
            mgrState.page = 1;
            fetchManagerData();
        }

        function searchManagerCards() {
            mgrState.search = document.getElementById('mgr-search').value;
            mgrState.page = 1;
            fetchManagerData();
        }

        function goToPage(page) {
            mgrState.page = page;
            fetchManagerData();
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function getStatusBadge(status, time) {
            if (status === 'OUT') return `<span style="color:#7f8c8d;">ğŸšª í‡´ì†Œ (${time})</span>`;
            if (status === 'HOSPITAL') return `<span style="color:#e67e22;">ğŸ¥ ë³‘ì› ì´ì†¡ (${time})</span>`;
            return `<span style="color:#27ae60;">ğŸ•’ ${time} ì…ì†Œ</span>`;
        }

        // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ (ID ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëŒ€ì‹  ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬)
        function getActionButtons(incident_id, resId, resName, shelterId) {

            // í˜„ì¬ íƒ­ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ë¶„ê¸°
            if(mgrState.status === 'IN') {
                return `
                    <button class="btn-action btn-act-orange" onclick="changeResidentStatus(${incident_id}, ${resId}, '${resName}', 'HOSPITAL')">ğŸš‘ ë³‘ì›</button>
                    <button class="btn-action btn-act-gray" onclick="changeResidentStatus(${incident_id}, ${resId}, '${resName}', 'OUT')">ğŸ  í‡´ì†Œ</button>
                `;
            } else {
                return `
                    <button class="btn-action btn-act-green" onclick="changeResidentStatus(${incident_id}, ${resId}, '${resName}', 'IN')">ğŸ”„ ì¬ì…ì†Œ</button>
                `;
            }
        }
        
        // --- ê¸°ëŠ¥ ì‹¤í–‰ (ë¬¼í’ˆ ì§€ê¸‰) ---
        function mgrDistribute(resId) {
            var supId = document.getElementById(`mgr-sup-${resId}`).value;
            if(!supId) return alert("ë¬¼í’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            var formData = new FormData();
			formData.append('incident_id', document.getElementById('incident_id').value);
            formData.append('res_id', resId);
            formData.append('sup_id', supId);
            formData.append('quantity', 1);

            fetch('/manage_distribute', { method: 'POST', body: formData })
            .then(r => {
                if(r.ok) { 
					//openResidentInfoPanel(resId); 
					//alert("ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤."); 
				} else { alert("ì§€ê¸‰ ì‹¤íŒ¨"); }
            });
        }
		
		// ============================================================
        // [New] ê²€ìƒ‰ UI ì œì–´ í•¨ìˆ˜ë“¤
        // ============================================================

        // 1. ì…ë ¥ ë‚´ìš©ì— ë”°ë¼ X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        function toggleSearchClearBtn() {
            var input = document.getElementById('mgr-search');
            var btn = document.getElementById('btn-mgr-clear');
            btn.style.display = (input.value.length > 0) ? 'flex' : 'none';
        }

        // 2. ì—”í„°í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
        function handleSearchEnter(e) {
            if (e.key === 'Enter') {
                executeManagerSearch();
            }
        }

        // 3. ê²€ìƒ‰ì–´ ì´ˆê¸°í™” (X ë²„íŠ¼ í´ë¦­) -> ì „ì²´ ëª©ë¡ ë¡œë“œ
        function clearManagerSearch() {
            var input = document.getElementById('mgr-search');
            input.value = '';
            toggleSearchClearBtn(); // ë²„íŠ¼ ìˆ¨ê¹€
            
            // ê²€ìƒ‰ì–´ ì—†ì´ ê²€ìƒ‰ ì‹¤í–‰ (=ì´ˆê¸°í™”)
            executeManagerSearch();
        }

        // 4. ì‹¤ì œ ê²€ìƒ‰ ì‹¤í–‰ (ì„œë²„ ìš”ì²­)
        function executeManagerSearch() {
            mgrState.search = document.getElementById('mgr-search').value.trim();
            mgrState.page = 1; // ê²€ìƒ‰ ì‹œ 1í˜ì´ì§€ë¡œ ë¦¬ì…‹
            fetchManagerData();
        }
        
        // ============================================================
        // [New] ì„œë¸Œ ëª¨ë‹¬ (ë“±ë¡) ì œì–´ ë¡œì§
        // ============================================================

        // 1. ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
        function openSubModal() {
            var modal = document.getElementById('resident-add-modal');
            var shelterSelect = document.getElementById('modal-reg-shelter');
            
            // êµ¬í˜¸ì†Œ ëª©ë¡ ì±„ìš°ê¸°
            shelterSelect.innerHTML = "";
            locations.forEach(loc => {
                if(loc.type === 'shelter') {
                    var opt = document.createElement('option');
                    opt.value = loc.id;
                    opt.text = loc.name;
                    shelterSelect.appendChild(opt);
                }
            });

            // í˜„ì¬ ë³´ê³  ìˆëŠ” êµ¬í˜¸ì†Œê°€ 'íŠ¹ì • êµ¬í˜¸ì†Œ'ë¼ë©´ ê·¸ê±¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„ íƒ
            if (mgrState.shelterId && mgrState.shelterId != 0) {
                shelterSelect.value = mgrState.shelterId;
            }

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('modal-reg-name').value = '';
            document.getElementById('modal-reg-age').value = '';
            document.getElementById('modal-reg-phone').value = '';
            document.getElementById('modal-reg-note').value = '';
            document.getElementById('modal-reg-head-phone').value = '';
            document.getElementById('modal-reg-fam-role').value = 'ì„¸ëŒ€ì£¼';
            toggleModalRegHeadPhone();

            modal.classList.add('open');
        }

        // 2. ëª¨ë‹¬ ë‹«ê¸°
        function closeSubModal() {
            document.getElementById('resident-add-modal').classList.remove('open');
        }

        // 3. ì„¸ëŒ€ì› ì„ íƒ ì‹œ UI ë³€ê²½
        function toggleModalRegHeadPhone() {
            var role = document.getElementById('modal-reg-fam-role').value;
            var display = (role === 'ì„¸ëŒ€ì›') ? 'block' : 'none';
            document.getElementById('modal-reg-head-phone').style.display = display;
        }

        // 4. [í•µì‹¬] ë“±ë¡ ì‹¤í–‰ (API í˜¸ì¶œ)
        function registerResidentManager() {
            // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
            var shelterId = document.getElementById('modal-reg-shelter').value;
            var name = document.getElementById('modal-reg-name').value.trim();
            var age = document.getElementById('modal-reg-age').value.trim();
            var gender = document.getElementById('modal-reg-gender').value;
            var phone = document.getElementById('modal-reg-phone').value.trim();
            var note = document.getElementById('modal-reg-note').value.trim();
            var famRole = document.getElementById('modal-reg-fam-role').value;
            var headPhone = document.getElementById('modal-reg-head-phone').value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!shelterId) return alert("ë“±ë¡í•  êµ¬í˜¸ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (famRole === 'ì„¸ëŒ€ì›' && !headPhone) return alert("ì„¸ëŒ€ì›ì€ ì„¸ëŒ€ì£¼ ì—°ë½ì²˜ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            // API í˜¸ì¶œ
            fetch('/api/resident/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    shelter_id: shelterId,
                    name: name,
                    age: age,
                    gender: gender,
                    phone: phone,
                    notes: note, // app.py API ìŠ¤í™ì— ë§ì¶¤ (note or notes í™•ì¸ í•„ìš”, ë³´í†µ notes)
                    note: note,  // í˜¹ì‹œ ëª°ë¼ ë‘˜ ë‹¤ ë³´ëƒ„
                    family_role: famRole,
                    head_phone: headPhone
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.result === 'ok') {
                    alert(data.msg);
                    closeSubModal();     // ë“±ë¡ì°½ ë‹«ê¸°
                    fetchManagerData();  // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë“±ë¡ëœ ì‚¬ëŒ ë°”ë¡œ ë³´ì´ê²Œ)
                    
                    // ëŒ€ì‹œë³´ë“œ í†µê³„ ê°±ì‹ 
                    updateDashboardData();
                } else {
                    alert("ë“±ë¡ ì‹¤íŒ¨: " + data.msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }
		
		// ============================================================
        // [New] ì´ì¬ë¯¼ ìƒì„¸ ì •ë³´ íŒ¨ë„ (Drill-down) ë¡œì§
        // ============================================================
        var currentResidentInfoId = null;

        // [ìˆ˜ì •] íŒ¨ë„ ì—´ê¸° (ì• ë‹ˆë©”ì´ì…˜ ì ìš©ì„ ìœ„í•œ íƒ€ì´ë° ì¡°ì ˆ)
        function openResidentInfoPanel(resId) {
            currentResidentInfoId = resId;
            var panel = document.getElementById('resident-info-panel');
            
            panel.style.display = 'flex';
            setTimeout(() => { panel.classList.add('open'); }, 10);
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('res-info-name').innerText = "ë¡œë”© ì¤‘...";
            document.getElementById('res-info-dist-list').innerHTML = "<li class='empty-msg'>...</li>";
            document.getElementById('res-info-history-list').innerHTML = "<li class='empty-msg'>...</li>"; // ì´ë ¥ ë¡œë”©

            fetch(`/api/resident/${resId}/info`)
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    // 1. ê¸°ë³¸ ì •ë³´
                    document.getElementById('res-info-name').innerText = data.name;
                    document.getElementById('res-info-gender-age').innerText = `${data.gender}, ${data.age || '?'}ì„¸`;
                    document.getElementById('res-info-phone').innerText = data.phone || '-';
                    document.getElementById('res-info-note').innerText = data.notes ? `âš ï¸ ${data.notes}` : '';
                    
                    var shelterName = document.getElementById('panel-header-title').innerText; 
                    document.getElementById('res-info-shelter').innerText = `ğŸ  ${shelterName}`;

                    // 2. ë²„íŠ¼ ì—°ê²°
                    document.getElementById('btn-info-hosp').onclick = function() {
                        changeResidentStatus(data.incident_id, resId, data.name, 'HOSPITAL', currentEditingShelterId);
                    };
                    document.getElementById('btn-info-out').onclick = function() {
                        changeResidentStatus(data.incident_id, resId, data.name, 'OUT', currentEditingShelterId);
                    };

                    // 3. ë¬¼í’ˆ ì§€ê¸‰ ë“œë¡­ë‹¤ìš´
                    var select = document.getElementById('res-info-supply-select');
                    select.innerHTML = '<option value="">ğŸ ì§€ê¸‰í•  ë¬¼í’ˆ ì„ íƒ</option>';
                    if (data.shelter_supplies && data.shelter_supplies.length > 0) {
                        data.shelter_supplies.forEach(s => {
                            var opt = document.createElement('option');
                            opt.value = s.id;
                            opt.text = `${s.name} (${s.qty}ê°œ ë‚¨ìŒ)`;
                            select.appendChild(opt);
                        });
                    } else {
                        var opt = document.createElement('option');
                        opt.text = "(ì§€ê¸‰ ê°€ëŠ¥í•œ ë¬¼í’ˆ ì—†ìŒ)";
                        opt.disabled = true;
                        select.appendChild(opt);
                    }

                    document.getElementById('btn-info-distribute').onclick = function() {
                        distributeToResidentInPanel(resId);
                    };

                    // 4. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                    renderDistHistory(data.distributions);
                    renderStatusHistory(data.history); // [New] ì´ë ¥ ë Œë”ë§ í˜¸ì¶œ
                } else {
                    alert("ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    closeResidentInfoPanel();
                }
            })
            .catch(err => {
                console.error(err);
                closeResidentInfoPanel();
            });
        }

        // [New] ì…í‡´ì†Œ ì´ë ¥ ë Œë”ë§ í•¨ìˆ˜
        function renderStatusHistory(history) {
			var container = document.getElementById('res-info-history-list');
			if (!history || history.length === 0) {
				container.innerHTML = "<li class='empty-msg'>ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
				return;
			}
			
			container.innerHTML = history.map((h, index) => {
				let html = '';
				
				// [CASE A] íŠ¹ì´ì‚¬í•­(NOTE)ì¸ ê²½ìš°
				if (h.status === 'NOTE') {
					html = `
						<li class="history-item">
							<div class="res-list-content" style="flex-direction: column; align-items: flex-start;">
								<div style="width:100%; display:flex; justify-content:space-between;">
									<div><span class="note-label">ğŸ“ </span> <span style="font-size:11px; color:#999;">${h.time}</span></div>
									<button class="btn-del-mini" onclick="deleteStatusLog(${h.id})" title="ì‚­ì œ">Ã—</button>
								</div>
								<div class="note-content-box">
									${h.content}
								</div>
							</div>
						</li>
					`;
				} 
				// [CASE B] ì¼ë°˜ ìƒíƒœ ë³€ê²½(ì…/í‡´ì†Œ/ë³‘ì›)ì¸ ê²½ìš°
				else {
					let badgeClass = 'badge-in';
					let statusText = 'ì…ì†Œ';
					let btntext = ''; 

					if (h.status === 'OUT') { badgeClass = 'badge-out'; statusText = 'í‡´ì†Œ'; }
					else if (h.status === 'HOSPITAL') { badgeClass = 'badge-hosp'; statusText = 'ë³‘ì›'; }

					// ìµœì´ˆ ì´ë ¥ ì—¬ë¶€ ì²´í¬
					if (index === history.length - 1) {
						statusText = 'ìµœì´ˆì…ì†Œ';
					} else {
						btntext = `<button class="btn-del-mini" onclick="deleteStatusLog(${h.id})" title="ê¸°ë¡ ì‚­ì œ">Ã—</button>`;
					}

					html = `
						<li class="history-item">
							<div class="res-list-content">
								<div>
									<span class="history-badge ${badgeClass}">${statusText}</span>
									<span style="font-weight:500;">${h.shelter_name}</span>
								</div>
								<div>
									<span style="font-size:11px; color:#a0aec0; margin-right:5px;">${h.time}</span>
									${btntext}
								</div>
							</div>
						</li>
					`;
				}
				return html;
			}).join('');
		}
		
		// [NEW] íŠ¹ì´ì‚¬í•­ ì €ì¥ í•¨ìˆ˜
		function addResidentNote() {
			var input = document.getElementById('res-note-input');
			var content = input.value.trim();
			
			if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			if(!currentResidentInfoId) return;

			var incident_id = document.getElementById('incident_id').value;

			fetch('/api/resident/note/add', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					incident_id: incident_id,
					resident_id: currentResidentInfoId,
					shelter_id: currentEditingShelterId, // í˜„ì¬ ë³´ê³ ìˆëŠ” êµ¬í˜¸ì†Œ ID ì‚¬ìš©
					content: content
				})
			})
			.then(r => r.json())
			.then(data => {
				if(data.result === 'ok') {
					input.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
					openResidentInfoPanel(currentResidentInfoId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
				} else {
					alert("ì €ì¥ ì‹¤íŒ¨: " + data.msg);
				}
			})
			.catch(err => console.error(err));
		}

		// [Tip] ì—”í„°í‚¤ ì…ë ¥ ì‹œ ì €ì¥ë˜ë„ë¡ ì´ë²¤íŠ¸ ì—°ê²°
		document.getElementById('res-note-input').addEventListener("keyup", function(event) {
			if (event.key === "Enter") {
				addResidentNote();
			}
		});

        // [ìˆ˜ì •] íŒ¨ë„ ë‹«ê¸° (ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ ìˆ¨ê¹€ ì²˜ë¦¬)
        function closeResidentInfoPanel() {
            var panel = document.getElementById('resident-info-panel');
            var mainPanel = document.getElementById('detail-panel'); // êµ¬í˜¸ì†Œ íŒ¨ë„
            
            // 1. ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ë‹«ê¸°)
            panel.classList.remove('open');
			
			panel.style.display = 'none';
            
            // [í•µì‹¬ ìˆ˜ì •] êµ¬í˜¸ì†Œ íŒ¨ë„ì´ í˜„ì¬ 'ì—´ë ¤ìˆëŠ” ìƒíƒœ(open í´ë˜ìŠ¤ ë³´ìœ )'ì¼ ë•Œë§Œ ìƒˆë¡œê³ ì¹¨ ìˆ˜í–‰
            // -> X ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ êµ¬í˜¸ì†Œ íŒ¨ë„ì„ ë‹«ëŠ” ì¤‘ì´ë¼ë©´(.remove('open') ì§í›„ë¼ë©´) ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
            if(currentEditingShelterId && mainPanel.classList.contains('open')) {
                openDetailPanel(currentEditingShelterId);
            }
        }


        // ì§€ê¸‰ ì‹¤í–‰
        function distributeToResidentInPanel(resId) {
            var supId = document.getElementById('res-info-supply-select').value;
            if(!supId) return alert("ë¬¼í’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            var formData = new FormData();
			formData.append('incident_id', document.getElementById('incident_id').value);
            formData.append('res_id', resId);
            formData.append('sup_id', supId);
            formData.append('quantity', 1);

            fetch('/manage_distribute', { method: 'POST', body: formData })
            .then(r => {
                if(r.ok) {
                    //alert("ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
                    openResidentInfoPanel(resId); 
					if(currentEditingShelterId) {
						openDetailPanel(currentEditingShelterId);
					}
                } else {
                    alert("ì§€ê¸‰ ì‹¤íŒ¨ (ì¬ê³  ë¶€ì¡± ë“±)");
                }
            });
        }

        // ì§€ê¸‰ ì´ë ¥ ë Œë”ë§
        function renderDistHistory(list) {
			var container = document.getElementById('res-info-dist-list');
			if(!list || list.length === 0) {
				container.innerHTML = "<li class='empty-msg'>ì§€ê¸‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
				return;
			}
			
			container.innerHTML = list.map(d => `
				<li class="supply-history-item">
					<div class="res-list-content">
						<span>${d.item_name} <b style="color:#2980b9;">${d.qty}ê°œ</b></span>
						<div>
							<span style="color:#a0aec0; font-size:11px; margin-right:5px;">${d.time}</span>
							<button class="btn-del-mini" onclick="deleteDistLog(${d.id})" title="ì§€ê¸‰ ì·¨ì†Œ">Ã—</button>
						</div>
					</div>
				</li>
			`).join('');
		}
		
		// [NEW] ë¬¼í’ˆ ì§€ê¸‰ ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜
		function deleteDistLog(logId) {
			if(!confirm("í•´ë‹¹ ë¬¼í’ˆ ì§€ê¸‰ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì¬ê³ ëŠ” ìë™ìœ¼ë¡œ ë³µêµ¬ë©ë‹ˆë‹¤)")) return;

			fetch('/api/dist_log/delete', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({ id: logId })
			})
			.then(r => r.json())
			.then(data => {
				if(data.result === 'ok') {
					// ì„±ê³µ ì‹œ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ ì—´ë ¤ìˆëŠ” ì´ì¬ë¯¼ ID ê¸°ì¤€)
					if(currentResidentInfoId) openResidentInfoPanel(currentResidentInfoId);
					if(currentEditingShelterId) openDetailPanel(currentEditingShelterId);
					// ì „ì²´ í†µê³„(ë¬¼í’ˆ ìˆ˜ëŸ‰ ë“±) ê°±ì‹ ì„ ìœ„í•´ í˜¸ì¶œ
					//updateDashboardData();
				} else {
					alert("ì‚­ì œ ì‹¤íŒ¨: " + data.msg);
				}
			})
			.catch(err => console.error(err));
		}

		// [NEW] ìƒíƒœ ë³€ê²½ ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜
		function deleteStatusLog(logId) {
			if(!confirm("ì´ ìƒíƒœ ë³€ê²½ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ ì‹œ ì´ì „ ìƒíƒœê°€ í˜„ì¬ ìƒíƒœê°€ ë©ë‹ˆë‹¤)")) return;

			fetch('/api/status_log/delete', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({ id: logId })
			})
			.then(r => r.json())
			.then(data => {
				if(data.result === 'ok') {
					// ì„±ê³µ ì‹œ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨
					if(currentResidentInfoId) openResidentInfoPanel(currentResidentInfoId);
					if(currentEditingShelterId) openDetailPanel(currentEditingShelterId);
					//updateDashboardData();
				} else {
					alert("ì‚­ì œ ì‹¤íŒ¨: " + data.msg);
				}
			})
			.catch(err => console.error(err));
		}
		
		// [NEW] ê·¼ë¬´ì ì‚­ì œ í•¨ìˆ˜ ì¶”ê°€ (script íƒœê·¸ ë§¨ ì•„ë˜ìª½ì´ë‚˜ ì ì ˆí•œ ê³³ì— ì¶”ê°€)
			function deleteStaff(id) {
				// ê¶Œí•œ ì²´í¬ (UI ë ˆë²¨)
				if (userRole > 2) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");

				if(!confirm("í•´ë‹¹ ê·¼ë¬´ìë¥¼ ëª…ë‹¨ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

				fetch('/api/staff/delete', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify({ id: id })
				})
				.then(r => r.json())
				.then(data => {
					if(data.result === 'ok') {
						// ì„±ê³µ ì‹œ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨
						if(currentEditingShelterId) openDetailPanel(currentEditingShelterId);
					} else {
						alert("ì‚­ì œ ì‹¤íŒ¨: " + data.msg);
					}
				})
				.catch(err => console.error(err));
			}
    </script>
</body>
</html>