<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¯¼ë³´í˜¸ì‹œìŠ¤í…œ</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #layout-container { display: flex; width: 100%; height: 100vh; }

        /* --- [ì‚¬ì´ë“œë°”] --- */
        #sidebar {
            width: 280px; top:0px; bottom:-30px; background: white; border-right: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: width 0.3s ease-in-out;
            display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 1000;
        }
        #sidebar.collapsed { width: 40px; }
        
        #sidebar.collapsed .sidebar-header-content,
        #sidebar.collapsed .sidebar-content-wrapper { opacity: 0; pointer-events: none; transition: opacity 0.2s; }

        .sidebar-vertical-text {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            writing-mode: vertical-rl; text-orientation: upright;
            font-weight: bold; color: #2c3e50; font-size: 14px; letter-spacing: 5px;
            white-space: nowrap; opacity: 0; transition: opacity 0.3s 0.2s;
        }
        #sidebar.collapsed .sidebar-vertical-text { opacity: 1; pointer-events: auto; }

        .toggle-btn {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; background: #f1f3f5; border: none; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 2001; font-size: 10px; color: #555;
        }
        #sidebar.collapsed .toggle-btn { right: 50%; transform: translateX(50%); top: 10px; }

        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; height: 40px; display: flex; align-items: center;}
        .sidebar-header-content { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .btn-back { text-decoration: none; background: #2c3e50; color: white; padding: 5px 10px; border-radius: 4px; font-size: 11px; }
        .sidebar-content-wrapper { flex: 1; overflow-y: auto; padding: 10px; }
        
		.panel-section-title {
            font-size: 14px;
            font-weight: 800; /* ë” êµµê²Œ */
            color: #2d3748;
            margin-top: 20px;
            margin-bottom: 10px;
            padding: 10px 12px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
            background: #f7fafc; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
            border-radius: 8px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            display: flex;
            align-items: center;
            gap: 8px;
            /* ì™¼ìª½ í¬ì¸íŠ¸ ë¼ì¸ íš¨ê³¼ */
            border-left: 5px solid #cbd5e0; 
            transition: all 0.2s;
        }

        /* êµ¬í˜¸ì†Œ íƒ€ì´í‹€ ê°•ì¡° (íŒŒë€ìƒ‰ í…Œë§ˆ) */
        .panel-section-title.shelter-title {
            background: #ebf8ff; /* ì•„ì£¼ ì—°í•œ íŒŒë‘ ë°°ê²½ */
            border-left-color: #3182ce; /* ì§„í•œ íŒŒë‘ í¬ì¸íŠ¸ */
            color: #2b6cb0;
        }

        /* ì§‘ê²°ì§€ íƒ€ì´í‹€ ê°•ì¡° (ë¹¨ê°„ìƒ‰ í…Œë§ˆ) */
        .panel-section-title.assembly-title {
            background: #fff5f5; /* ì•„ì£¼ ì—°í•œ ë¹¨ê°• ë°°ê²½ */
            border-left-color: #e53e3e; /* ì§„í•œ ë¹¨ê°• í¬ì¸íŠ¸ */
            color: #c53030;
        }
        
        /* ì²« ë²ˆì§¸ íƒ€ì´í‹€ ìƒë‹¨ ì—¬ë°± ì œê±° */
        .panel-section-title:first-child { margin-top: 0; }

        /* ==========================================================================
           [ìˆ˜ì •] ì¢Œì¸¡ íŒ¨ë„ ë¦¬ìŠ¤íŠ¸ ë””ìì¸ ê°œì„  (ì¹´ë“œí˜• UI)
           ========================================================================== */
        
        /* 1. ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ (ì¹´ë“œ í˜•íƒœ) */
        .marker-item { 
            display: flex; 
            align-items: center; 
            padding: 8px 10px; /* ì—¬ë°±ì„ ë„‰ë„‰í•˜ê²Œ */
            margin-bottom: 8px; 
            background: #ffffff; 
            border: 1px solid #edf2f7; /* ì•„ì£¼ ì—°í•œ í…Œë‘ë¦¬ */
            border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02); /* ì•„ì£¼ ì‚´ì§ ê·¸ë¦¼ì */
        }
        
        /* 2. ë¹„í™œì„±(ìš´ì˜ì¤‘ì§€) ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .marker-item.inactive { 
            background: #f8f9fa; /* íšŒìƒ‰ ë°°ê²½ */
            border-color: transparent;
            box-shadow: none;
            opacity: 0.8; /* ë„ˆë¬´ íë¦¬ì§€ ì•Šê²Œ ì¡°ì • */
        }
        
        /* 3. ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .marker-icon { 
            width: 20px; 
            height: 28px; 
            object-fit: contain; 
            flex-shrink: 0; 
            margin-right: 12px; /* í…ìŠ¤íŠ¸ì™€ ê°„ê²© ë²Œë¦¼ */
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        /* ë¹„í™œì„± ì•„ì´ì½˜: í‘ë°± + íˆ¬ëª…ë„ */
        .marker-item.inactive .marker-icon { 
            filter: grayscale(100%) opacity(0.4); 
        }

        /* 4. í…ìŠ¤íŠ¸ ì •ë³´ ì˜ì—­ */
        .marker-info-box { 
            display: flex; 
            flex-direction: column; /* ìœ„ì•„ë˜ ë°°ì¹˜ */
            justify-content: center;
            flex: 1;
        }

        .marker-name { 
            font-size: 14px; 
            font-weight: 700; /* ì¡°ê¸ˆ ë” êµµê²Œ */
            color: #2d3748; 
            margin-bottom: 5px; /* ì´ë¦„ê³¼ ë±ƒì§€ ì‚¬ì´ ê°„ê²© */
            letter-spacing: -0.3px;
        }
        
        /* ë¹„í™œì„± í…ìŠ¤íŠ¸: ì·¨ì†Œì„  ëŒ€ì‹  ìƒ‰ìƒì„ ì—°í•˜ê²Œ í•˜ê³  'ìš´ì˜ì¤‘ì§€' í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´ íš¨ê³¼ */
        .marker-item.inactive .marker-name { 
            color: #a0aec0; 
            text-decoration: none; /* ì·¨ì†Œì„  ì œê±° (ì§€ì €ë¶„í•´ ë³´ì„) */
        }

        /* 5. í†µê³„ ë±ƒì§€ ì˜ì—­ */
        .marker-stats { 
            display: flex; 
            gap: 6px; /* ë±ƒì§€ ì‚¬ì´ ê°„ê²© */
        }
		
		/* [ìˆ˜ì •] ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ (ìœ„ì¹˜ ë³´ì • ì†ì„± ì œê±°) */
        .marker-content {
            /* position, bottom, left ì‚­ì œ -> APIê°€ ì•Œì•„ì„œ ì¡ì•„ì¤ë‹ˆë‹¤ */
            width: 30px; 
            height: 41px; 
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        /* ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .marker-content img { 
            width: 100%; 
            height: 100%; 
            display: block; 
            filter: drop-shadow(2px 3px 3px rgba(0,0,0,0.3)); 
        }

        /* í˜¸ë²„ íš¨ê³¼ */
        .marker-content:hover,
        .marker-content.highlight {
            transform: translateY(-5px); 
            z-index: 100; 
        }
        
        /* í‘ë°± í•„í„° */
        .marker-content.grayscale img { 
            filter: grayscale(100%) opacity(0.7) drop-shadow(1px 2px 2px rgba(0,0,0,0.2)); 
        }

        /* ê³µí†µ ë±ƒì§€ ìŠ¤íƒ€ì¼ (ì•Œì•½ ëª¨ì–‘) */
        .stat-badge, .staff-badge { 
            display: inline-flex;
            align-items: center;
            padding: 3px 8px; 
            border-radius: 12px; /* ë‘¥ê¸€ê²Œ */
            font-size: 11px; 
            font-weight: 600;
        }

        /* ì…ì†Œì ë±ƒì§€ (íŒŒë€ìƒ‰ ê³„ì—´) */
        .stat-badge { 
            background: #ebf8ff; 
            color: #3182ce; 
        }

        /* ê·¼ë¬´ì ë±ƒì§€ (ì´ˆë¡ìƒ‰ ê³„ì—´) */
        .staff-badge { 
            background: #f0fff4; 
            color: #38a169; 
        }
        
        /* ë¹„í™œì„± ìƒíƒœì¼ ë•Œ ë±ƒì§€ë„ íšŒìƒ‰ ì²˜ë¦¬ */
        .marker-item.inactive .stat-badge, 
        .marker-item.inactive .staff-badge {
            background: #edf2f7;
            color: #a0aec0;
        }

        /* ìˆ¨ê¹€ ìƒíƒœ (ëˆˆ ê»ì„ ë•Œ) */
        .marker-item.hidden-map { 
            opacity: 0.4; 
            filter: grayscale(100%);
        }

        /* --- [ì§€ë„ ì˜ì—­] --- */
        #map-area { flex: 1; position: relative; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* [ìˆ˜ì •] ëª©ë¡ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .marker-icon { 
            width: 20px; 
            height: 28px; 
            object-fit: contain; 
            flex-shrink: 0; 
            margin-right: 12px; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ ì»¤ì„œ */
            transition: transform 0.2s, filter 0.2s;
        }
        
        /* ì•„ì´ì½˜ í˜¸ë²„ ì‹œ í™•ëŒ€ íš¨ê³¼ (ë²„íŠ¼ ëŠë‚Œ) */
        .marker-icon:hover {
            transform: scale(1.2); 
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2));
        }

        /* ë¹„í™œì„± ì•„ì´ì½˜ */
        .marker-item.inactive .marker-icon { 
            filter: grayscale(100%) opacity(0.4); 
        }

        /* ë²”ë¡€ & ê¸°íƒ€ UI */
        .route-legend-container { position: absolute; top: 5px; right: 40px; z-index: 1000; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); max-height: 80vh; overflow-y: auto; width: 220px; }
        .legend-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .route-item { display: flex; align-items: center; gap: 8px; padding: 6px; margin-bottom: 4px; background: #f8f9fa; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .color-box { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0;}
        .arrow-overlay { font-size: 16px; font-weight: 900; text-shadow: 2px 0 0 #fff, -2px 0 0 #fff, 0 2px 0 #fff, 0 -2px 0 #fff; pointer-events: none; opacity: 1; }
        
        #contextMenu { position: absolute; display: none; z-index: 3000; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow: hidden; min-width: 140px; }
        .context-item { padding: 10px 15px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #eee; }
        .context-item:hover { background: #f1f3f5; }

        .iw-btn { display: block; width: 100%; margin-top: 5px; padding: 4px 0; background: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .iw-btn:hover { background: #d35400; }
        /* [New] ìƒíƒœ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .status-btn { background: #95a5a6; margin-top: 5px; }
        .status-btn.active-btn { background: #e74c3c; } /* ì¤‘ì§€í•˜ê¸° ìƒ‰ìƒ */
        .status-btn.inactive-btn { background: #2ecc71; } /* ì¬ê°œí•˜ê¸° ìƒ‰ìƒ */
		
		/* [New] ìŠ¬ë¼ì´ë“œ íŒ¨ë„ í—¤ë”ì˜ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .header-actions { display: flex; align-items: center; gap: 10px; }
        
        /* ì•„ì´í° ìŠ¤íƒ€ì¼ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; } /* í™œì„± ë…¹ìƒ‰ */
        input:checked + .slider:before { transform: translateX(18px); }
        .toggle-label { font-size: 12px; color: white; margin-right: 5px;}

        /* [New] ì§‘ê²°ì§€ ë§í’ì„ (InfoWindow) ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .iw-container { padding: 5px; text-align: center; min-width: 140px; }
        .iw-title { font-weight: bold; margin-bottom: 8px; display: block; font-size: 14px; }
        .iw-controls { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        
        /* ë§í’ì„  ë²„íŠ¼ë“¤ */
        .iw-btn-action { 
            border: none; padding: 6px 0; border-radius: 4px; 
            font-size: 11px; font-weight: bold; cursor: pointer; color: white; width: 100%;
            transition: opacity 0.2s;
        }
        .iw-btn-action:hover { opacity: 0.9; }
        .btn-connect { background-color: #e67e22; } /* ì£¼í™© */
        .btn-stop { background-color: #e74c3c; }    /* ë¹¨ê°• (ì¤‘ì§€) */
        .btn-start { background-color: #2ecc71; }   /* ë…¹ìƒ‰ (ì¬ê°œ) */

        #connect-guide { display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(44, 62, 80, 0.9); color: white; padding: 8px 16px; border-radius: 30px; font-size: 13px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
		
		/* [New] ìƒì„¸ ì •ë³´ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ */
        #detail-panel {
            position: absolute;
            top: 0; left: 0; bottom: 0; /* ì§€ë„ ì˜ì—­ì˜ ì™¼ìª½ ëì— ë¶™ì„ */
            width: 370px;
            background: white;
            z-index: 999; /* ì§€ë„ ì»¨íŠ¸ë¡¤ë³´ë‹¤ ìœ„ì— */
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            transform: translateX(-100%); /* ê¸°ë³¸ì€ í™”ë©´ ë°–(ì™¼ìª½)ìœ¼ë¡œ ìˆ¨ê¹€ */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column;
            border-right: 1px solid #eee;
        }
        
        #detail-panel.open {
            transform: translateX(0); /* í™œì„±í™” ì‹œ ë‚˜íƒ€ë‚¨ */
        }

        /* ìƒì„¸ íŒ¨ë„ í—¤ë” */
        /* [ìˆ˜ì •] ìƒì„¸ íŒ¨ë„ í—¤ë” (ì •ë ¬ ê¹¨ì§ ë°©ì§€) */
        .detail-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #2c3e50;
            color: white;
            display: flex; 
            justify-content: space-between; 
            align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
            height: 50px; /* ë†’ì´ ê³ ì • */
            flex-shrink: 0;
        }
        
        /* ì œëª© ì˜ì—­: ë„ˆë¬´ ê¸¸ë©´ ... ì²˜ë¦¬ */
        .detail-header-title-box {
            flex: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
            min-width: 0; /* flex ìì‹ì˜ text-overflow ì‘ë™ í•„ìˆ˜ ì¡°ê±´ */
            margin-right: 10px;
        }
        .detail-header h3 { 
            margin: 0; 
            font-size: 1.1rem; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            line-height: 1.2;
        }

        /* ë²„íŠ¼ ì˜ì—­: ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ê³ ì • */
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0; /* ì ˆëŒ€ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }

        /* ìˆ˜ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .btn-edit-mode {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-edit-mode:hover { background: rgba(255, 255, 255, 0.3); }

        /* ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ ê·¸ë£¹ */
        .edit-btn-group { display: flex; gap: 5px; }
        .btn-save-action { background: #27ae60; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .btn-cancel-action { background: #95a5a6; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }

        /* ìƒì„¸ íŒ¨ë„ ì½˜í…ì¸  */
        .detail-content { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }

        .detail-section {
            background: white; border-radius: 8px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #edf2f7;
        }
        .detail-section h4 {
            margin: 0 0 12px 0; font-size: 14px; color: #2d3748;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #f1f3f5; padding-bottom: 8px;
        }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .detail-list { list-style: none; padding: 0; margin: 0; font-size: 13px; }
        .detail-list li {
            padding: 8px 0; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between;
        }
        .detail-list li:last-child { border-bottom: none; }
        
        .empty-msg { color: #a0aec0; font-size: 12px; text-align: center; padding: 10px; }
        
        /* ë±ƒì§€ */
        .badge-count { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
		
		/* [New] ìƒë‹¨ ëŒ€ì‹œë³´ë“œ ì˜¤ë²„ë ˆì´ */
        .dashboard-overlay {
            position: absolute;
            top: 5px;
            left: 35%;
            transform: translateX(-50%); /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            z-index: 998; /* ì§€ë„ ë° ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— */
            display: flex;
            gap: 15px;
        }

        /* í†µê³„ ì¹´ë“œ ë””ìì¸ */
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 8px 12px;
            min-width: 140px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-bottom: 4px solid #ddd; /* ê¸°ë³¸ í•˜ë‹¨ ë°” */
            transition: transform 0.2s;
        }
        
        .stat-card:hover { transform: translateY(-3px); }

        /* ì¹´ë“œ ë‚´ë¶€ í…ìŠ¤íŠ¸ */
        .stat-title { font-size: 14px; font-weight: bold; color: #555; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;}
        .stat-value { font-size: 20px; font-weight: 800; color: #2c3e50; }
        .stat-unit { font-size: 12px; font-weight: normal; color: #7f8c8d; margin-left: 2px; }

        /* ì¹´ë“œë³„ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
        .stat-card.blue { border-bottom-color: #3498db; }
        .stat-card.green { border-bottom-color: #2ecc71; }
        .stat-card.navy { border-bottom-color: #34495e; }
        .stat-card.orange { border-bottom-color: #e67e22; }
		
		
#notification-panel {
    position: fixed;
    bottom: 0px; /* ë„¤ë¹„ê²Œì´ì…˜ë°” ë°”ë¡œ ìœ„ */
    left: -1px; right: -1px;
    background: #ffffff;
    border: 1px solid #ced4da;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    z-index: 1501;
    display: flex;
    flex-direction: column;
    min-height: 45px;
    max-height: 80vh;
    height: 150px; /* ê¸°ë³¸ ë†’ì´ */
    transition: transform 0.3s;
}

#panel-resizer {
    height: 45px;
    background: #2c3e50;
    color: white;
    cursor: ns-resize; /* ìœ„ì•„ë˜ ë“œë˜ê·¸ ì•„ì´ì½˜ */
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 10px 10px 0 0;
    position: relative;
}

.handle-line {
    width: 40px; height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
    position: absolute; top: 8px;
}

#notification-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
}

.noti-item {
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 5px solid #3498db;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

@keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

#supply-panel {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 370px; /* êµ¬í˜¸ì†Œ íŒ¨ë„ê³¼ ë™ì¼ ë„ˆë¹„ */
            background: white;
            z-index: 999; /* êµ¬í˜¸ì†Œ íŒ¨ë„(999)ë³´ë‹¤ ë†’ê²Œ */
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column;
            border-right: 1px solid #eee;
        }
        
        #supply-panel.open { transform: translateX(0); }

        /* ë¬¼í’ˆ ë“±ë¡(ì…ê³ ) í¼ ìŠ¤íƒ€ì¼ */
        .add-supply-form {
            background: #ebf8ff; /* ì—°í•œ íŒŒë‘ ë°°ê²½ */
            padding: 15px;
            border-bottom: 1px solid #bee3f8;
            margin-bottom: 5px;
        }
        .form-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .form-row input, .form-row select {
			min-width: 0;
            padding: 5px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px;
        }
        .btn-add-stock {
            width: 100%; background: #2b6cb0; color: white; border: none; padding: 8px; 
            border-radius: 4px; font-weight: bold; cursor: pointer;
        }
        .btn-add-stock:hover { background: #2c5282; }

        /* ë¬¼í’ˆ ë¦¬ìŠ¤íŠ¸ (ì¹´ë“œí˜•) */
        .supply-card-item {
            background: white; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 12px; margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .supply-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; border-bottom: 2px solid #f1f3f5; padding-bottom: 5px;
        }
        .supply-name { font-weight: bold; color: #2d3748; font-size: 14px; }
        .supply-total { font-weight: 800; color: #3182ce; font-size: 15px; }
        
        /* ë°°ë¶„ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .dist-control {
            display: flex; gap: 5px; align-items: center; background: #f7fafc; padding: 5px; border-radius: 4px;
        }
        .dist-select { flex: 1; min-width: 0; padding: 5px;} /* min-width:0 ìˆì–´ì•¼ flexì•ˆì—ì„œ ì¤„ì–´ë“¦ */
        .dist-input { width: 50px; text-align: center; padding: 5px;}
        .btn-dist { 
            background: #38a169; color: white; border: none; border-radius: 4px; 
            padding: 5px 8px; font-size: 12px; cursor: pointer; flex-shrink: 0;
        }
        .btn-dist:hover { background: #2f855a; }
		
		/* ë¬¼í’ˆ ì¹´ë“œ ë””ìì¸ */
        .supply-item-card {
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e9ecef;
        }
        .supply-head { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color: #34495e;}
        .supply-qty { font-size: 1.2rem; color: #3498db; }
        
        .distribute-form {
            display: flex; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
        }
        .distribute-form select { flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .distribute-form input { width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-distribute {
            background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }
        .btn-distribute:hover { background: #2980b9; }

        /* [New] êµ¬í˜¸ì†Œ ìˆ˜ì •ìš© ìŠ¤íƒ€ì¼ */
        .edit-input { 
            width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 5px;
        }
        .btn-edit-action { cursor: pointer; font-size: 12px; padding: 3px 8px; border-radius: 4px; border: none; color: white; margin-left: 5px; }
        .btn-save { background: #2ecc71; }
        .btn-cancel { background: #95a5a6; }
        .cursor-pointer { cursor: pointer; }
		
		/* [New] ë³´ê¸°/ìˆ˜ì • ëª¨ë“œ ì „í™˜ ìŠ¤íƒ€ì¼ */
        .view-mode { display: block; }
        .edit-mode { display: none; }
        
        /* ë¶€ëª¨ì— .editing í´ë˜ìŠ¤ê°€ ìˆìœ¼ë©´ ë°˜ëŒ€ë¡œ ë™ì‘ */
        .editing .view-mode { display: none; }
        .editing .edit-mode { display: block; width: 100%; box-sizing: border-box; }

        /* ì •ë³´ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .info-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .info-table th { text-align: left; color: #718096; padding: 6px 0; width: 70px; vertical-align: top; }
        .info-table td { padding: 6px 0; color: #2d3748; font-weight: 500; }
        
        /* ì¸í’‹ ìŠ¤íƒ€ì¼ */
        .info-input {
            padding: 5px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px;
            background: #fff;
        }
    </style>
</head>
<body>

    <div id="layout-container">
        <div id="sidebar">
            <button class="toggle-btn" onclick="toggleSidebar()">â—€</button>
            <div class="sidebar-vertical-text">ì£¼ë¯¼ë³´í˜¸ì‹œìŠ¤í…œ</div>

            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <strong style="font-size: 1.1rem;">ğŸ—ºï¸ ì£¼ë¯¼ë³´í˜¸ì‹œìŠ¤í…œ</strong>
                </div>
            </div>
            
            <div class="sidebar-content-wrapper">
                <div class="panel-section-title">ğŸ¥ êµ¬í˜¸ì†Œ</div>
                <div id="shelter-list"></div>
                
                <div class="panel-section-title" style="margin-top: 20px;">ğŸš© ì§‘ê²°ì§€</div>
                <div id="assembly-list"></div>
            </div>
        </div>

        <div id="map-area">
			<div class="dashboard-overlay">
                <div class="stat-card blue">
                    <div class="stat-title">ğŸ‘¥ í˜„ì¬ ì´ì¬ë¯¼</div>
                    <div class="stat-value">
                        <span id="val-residents">{{ summary.residents }}</span><span class="stat-unit">ëª…</span>
                    </div>
                </div>
                <div class="stat-card green cursor-pointer" onclick="openSupplyPanel()">
                    <div class="stat-title">ğŸ“¦ êµ¬í˜¸ë¬¼í’ˆ (ê´€ë¦¬)</div>
                    <div class="stat-value">
                        <span id="val-supplies">{{ summary.supplies }}</span><span class="stat-unit">ê°œ</span>
                    </div>
                </div>
                <div class="stat-card navy">
                    <div class="stat-title">ğŸ¥ ìš´ì˜ êµ¬í˜¸ì†Œ</div>
                    <div class="stat-value">
                        <span id="val-shelters">{{ summary.shelters }}</span><span class="stat-unit">ê°œì†Œ</span>
                    </div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-title">ğŸš© ìš´ì˜ ì§‘ê²°ì§€</div>
                    <div class="stat-value">
                        <span id="val-assemblies">{{ summary.assemblies }}</span><span class="stat-unit">ê°œì†Œ</span>
                    </div>
                </div>
            </div>
			
			<div id="detail-panel">
                <div class="detail-header">
                    <h3 id="panel-header-title">êµ¬í˜¸ì†Œ ì •ë³´</h3>
                    
                    <div class="header-actions">
                        <button id="btn-edit-mode" class="btn-edit-action" style="background:none; border:1px solid rgba(255,255,255,0.3);" onclick="enableEditMode()">âœï¸ ìˆ˜ì •</button>
                        
                        <div id="edit-actions" style="display:none; gap:5px;">
                            <button class="btn-edit-action btn-save" onclick="saveShelterInfo()">ì €ì¥</button>
                            <button class="btn-edit-action btn-cancel" onclick="cancelEditMode()">ì·¨ì†Œ</button>
                        </div>
                        
                        <div id="admin-switch-area"></div> 
                        <button class="btn-close-detail" onclick="closeDetailPanel()">Ã—</button>
                    </div>
                </div>

                <div class="detail-content" id="shelter-detail-content">
                    
                    <div class="detail-section">
                        <h4>â„¹ï¸ ê¸°ë³¸ ì •ë³´</h4>
                        <table class="info-table">
                            <tr>
                                <th>ì´ë¦„</th>
                                <td>
                                    <span class="view-mode" id="v-name"></span>
                                    <input type="text" class="edit-mode info-input" id="e-name">
                                </td>
                            </tr>
                            <tr>
                                <th>ì£¼ì†Œ</th>
                                <td>
                                    <span class="view-mode" id="v-addr"></span>
                                    <input type="text" class="edit-mode info-input" id="e-addr">
                                </td>
                            </tr>
                            <tr>
                                <th>ìˆ˜ìš©ì¸ì›</th>
                                <td>
                                    <span class="view-mode"><span id="v-cap"></span>ëª…</span>
                                    <input type="number" class="edit-mode info-input" id="e-cap">
                                </td>
                            </tr>
                            <tr>
                                <th>ìœ„ì¹˜</th>
                                <td>
                                    <div class="view-mode" style="font-size:11px; color:#718096;">
                                        ìœ„ë„: <span id="v-lat"></span>, ê²½ë„: <span id="v-lng"></span>
                                    </div>
                                    <div class="edit-mode" style="display:none; gap:5px;">
                                        <input type="text" class="info-input" id="e-lat" placeholder="ìœ„ë„" style="width:48%;">
                                        <input type="text" class="info-input" id="e-lng" placeholder="ê²½ë„" style="width:48%;">
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="detail-section">
                        <h4>ğŸ‘¥ ì´ì¬ë¯¼ ëª…ë‹¨ <span id="dt-res-count" class="badge-count">0</span></h4>
                        <ul id="dt-res-list" class="detail-list"></ul>
                    </div>

                    <div class="detail-section">
                        <h4>ğŸ“¦ ë¬¼í’ˆ í˜„í™©</h4>
                        <ul id="dt-inv-list" class="detail-list"></ul>
                    </div>

                    <div class="detail-section">
                        <h4>ğŸ‘· ê·¼ë¬´ì í˜„í™©</h4>
                        <ul id="dt-staff-list" class="detail-list"></ul>
                    </div>

                </div>
            </div>
			
			<div id="supply-panel">
                <div class="detail-header" style="background:#2980b9;"> <h3>ğŸ“¦ êµ¬í˜¸ë¬¼í’ˆ ê´€ë¦¬</h3>
                    <button class="btn-close-detail" onclick="closeSupplyPanel()">Ã—</button>
                </div>
                
                <div class="detail-content" style="padding:0;">
                    
                    <div class="add-supply-form">
                        <div style="font-size:13px; font-weight:bold; color:#2c5282; margin-bottom:8px;">â• ë³¸ì²­ ë¬¼í’ˆ ì…ê³  (ì‹ ê·œ/ì¶”ê°€)</div>
                        <div class="form-row">
                            <input type="text" id="new-item-name" placeholder="í’ˆëª©ëª… (ì˜ˆ: ìƒìˆ˜, ë¼ë©´)">
                            <input type="number" id="new-item-qty" placeholder="ìˆ˜ëŸ‰">
                        </div>
                        <button class="btn-add-stock" onclick="addHqSupply()">ì…ê³  ë“±ë¡</button>
                    </div>

                    <div style="padding: 15px;">
                        <div style="font-size:13px; font-weight:bold; color:#4a5568; margin-bottom:10px;">ğŸ“‹ ë³¸ì²­ ì¬ê³  í˜„í™© ë° ë°°ë¶„</div>
                        <div id="hq-supply-list">
                            </div>
                    </div>
                </div>
            </div>
            <div id="map"></div>
			
<div id="notification-panel" style="position: fixed; bottom:-140px; background: white; border-radius: 15px 15px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); z-index: 1501; height: 180px; display: flex; flex-direction: column; transition: height 0.3s ease;">
    <div id="panel-resizer" onclick="togglePanel(event)" style="height: 45px; background: #2c3e50; color: white; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0 15px;">
        <div style="width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%);"></div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <span id="toggle-icon">â–²</span>
            <span style="font-weight: bold; font-size: 0.9rem;">ğŸ“¢ ì‹¤ì‹œê°„ ìƒí™© ì•Œë¦¼</span>
        </div>
        <button onclick="clearNotifications(event)" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; cursor: pointer;">ë¹„ìš°ê¸°</button>
    </div>
    <div id="notification-list" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
        <div class="empty-msg" style="text-align:center; color:#94a3b8; margin-top:30px;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
</div>
            <div class="route-legend-container">
                <div class="legend-title">ğŸšŒ ì£¼ë¯¼ì†Œê°œ ê²½ë¡œ</div>
                <div id="legend-list"></div>
            </div>
            <div id="connect-guide">
                ğŸ”— ì—°ê²°í•  'êµ¬í˜¸ì†Œ(íŒŒë€ìƒ‰)'ë¥¼ í´ë¦­í•˜ì„¸ìš”! <button onclick="cancelConnect()" style="margin-left:10px; padding:2px 8px; border-radius:10px; border:none; background:#e74c3c; color:white; cursor:pointer;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="contextMenu">
        <div class="context-item" onclick="addNode('shelter')">ğŸ¥ êµ¬í˜¸ì†Œ ì¶”ê°€</div>
        <div class="context-item" onclick="addNode('assembly')">ğŸš© ì§‘ê²°ì§€ ì¶”ê°€</div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        var userRole = {{ user_role|default(3) }}; 

        var mapContainer = document.getElementById('map'), 
            mapOption = { center: new kakao.maps.LatLng(36.391401, 127.365340), level: 7 };
        var map = new kakao.maps.Map(mapContainer, mapOption); 
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        var locations = {{ locations | tojson }};
		
		const socket = io(); 

		// 2. ì—°ê²° í™•ì¸ ë¡œê·¸
		socket.on('connect', () => {
			console.log("âœ… ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: " + socket.id + ")");
		});

		socket.on('disconnect', () => {
			console.log("âŒ ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
		});

		socket.on('sys_notification', (data) => {
			console.log("ğŸ“¢ ì†Œì¼“ ì•Œë¦¼:", data);
			handleNotification(data);
		});

		socket.on('map_update', function(msg) {
			console.log(msg);
			updateDashboardData();
			var panel = document.getElementById('supply-panel');
            if (panel.classList.contains('open')) {
                loadHqSupplies();
            }
		});
        
        // ============================================================
        // [ìˆ˜ì •] ì•„ì´ì½˜ ì´ë¯¸ì§€ë¥¼ ì™¸ë¶€ ë§í¬ ëŒ€ì‹  SVG ì½”ë“œë¡œ ì§ì ‘ ì •ì˜
        // ============================================================
        
        // 1. êµ¬í˜¸ì†Œ ì•„ì´ì½˜
        const SVG_SHELTER = `
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="41" viewBox="0 0 38 52">
            <path d="M19 2C9.6 2 2 9.6 2 19C2 31 19 50 19 50S36 31 36 19C36 9.6 28.4 2 19 2Z" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
            <circle cx="19" cy="19" r="9" fill="white"/>
        </svg>`;

        // 2. ì§‘ê²°ì§€ ì•„ì´ì½˜
        const SVG_ASSEMBLY = `
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="41" viewBox="0 0 38 52">
            <path d="M19 2C9.6 2 2 9.6 2 19C2 31 19 50 19 50S36 31 36 19C36 9.6 28.4 2 19 2Z" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
            <circle cx="19" cy="19" r="7" fill="white"/>
        </svg>`;

        // SVG ë¬¸ìì—´ì„ ë°ì´í„° URI í¬ë§·ìœ¼ë¡œ ë³€í™˜
        const IMG_SHELTER = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(SVG_SHELTER);
        const IMG_ASSEMBLY = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(SVG_ASSEMBLY);

        var pendingSourceNode = null; 
        var clickedLat = 0, clickedLng = 0;
        var routeManager = {};
        var markerManager = {}; // { 'type_id': {overlay: obj, data: loc, div: element} }
        var routeCount = 0;
        var colorIndex = 0;
        const ROUTE_COLORS = ['#E74C3C', '#8E44AD', '#3498DB', '#16A085', '#F39C12', '#2C3E50'];
        var currentInfowindow = null;

        // ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var btn = document.querySelector('.toggle-btn');
            sidebar.classList.toggle('collapsed');
            btn.innerHTML = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
            setTimeout(function() { map.relayout(); }, 300);
        }

        // ì´ˆê¸°í™”
        var bounds = new kakao.maps.LatLngBounds();
        locations.forEach(function(loc) {
            if (loc.lat && loc.lng) {
                var coords = new kakao.maps.LatLng(loc.lat, loc.lng);
                createCustomMarker(coords, loc); // [ìˆ˜ì •] CustomOverlay ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
                
                if (loc.type === 'assembly' && loc.route_infos) {
                    loc.route_infos.forEach(function(route) {
                        if (route.path_data && route.path_data.length > 0) {
                            var linePath = route.path_data.map(p => new kakao.maps.LatLng(p.lat, p.lng));
                            drawPathAndAddToLegend(linePath, loc.name, route.shelter_name);
                            linePath.forEach(p => bounds.extend(p));
                        }
                    });
                }
            }
        });

        // ==============================
        // [í•µì‹¬] CustomOverlay ë§ˆì»¤ ìƒì„± (ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ì ìš©ì„ ìœ„í•´)
        // ==============================
        function createCustomMarker(coords, loc) {
            var markerKey = loc.type + '_' + loc.id;
            
            // 1. ë§ˆì»¤ ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±
            var contentDiv = document.createElement('div');
            contentDiv.className = 'marker-content';
            if (!loc.is_active) contentDiv.classList.add('grayscale'); // ë¹„í™œì„± ì‹œ í‘ë°± ì²˜ë¦¬

            var img = document.createElement('img');
            img.src = (loc.type === 'shelter') ? IMG_SHELTER : IMG_ASSEMBLY;
            contentDiv.appendChild(img);

            // 2. CustomOverlay ìƒì„±
            var customOverlay = new kakao.maps.CustomOverlay({
                position: coords,
                content: contentDiv,
                xAnchor: 0.5, // [New] ê°€ë¡œ ì¤‘ì•™ì„ ì¢Œí‘œì— ë§ì¶¤
                yAnchor: 1,   // [New] ì„¸ë¡œ ë°”ë‹¥ì„ ì¢Œí‘œì— ë§ì¶¤ (ê¼¬ë¦¬ ë¶€ë¶„)
                zIndex: 3
            });
            customOverlay.setMap(map);

            // 3. ê´€ë¦¬ ê°ì²´ì— ë“±ë¡
            markerManager[markerKey] = {
                overlay: customOverlay,
                div: contentDiv,
                data: loc,
                visible: true
            };
            
            // 4. íŒ¨ë„ì— ë“±ë¡
            addMarkerToPanel(loc, markerKey);

            // 5. í´ë¦­ ì´ë²¤íŠ¸ (OverlayëŠ” map eventë¥¼ ë§‰ì§€ ì•Šìœ¼ë¯€ë¡œ divì— ì§ì ‘ ì´ë²¤íŠ¸)
            contentDiv.onclick = function(e) {
                e.stopPropagation(); // ì§€ë„ í´ë¦­ ì „íŒŒ ë°©ì§€
                
                // 1. ì—°ê²° ëª¨ë“œ ì¤‘ì´ë©´ ì—°ê²° ë¡œì§ ìˆ˜í–‰
                if (pendingSourceNode) {
                    if (loc.type === 'shelter') completeConnection(loc); 
                    else alert("âš ï¸ êµ¬í˜¸ì†Œ(íŒŒë€ìƒ‰)ë¥¼ ì„ íƒí•´ì•¼ ì—°ê²°ë©ë‹ˆë‹¤.");
                    return; 
                }

                // 2. [New] êµ¬í˜¸ì†Œì¸ ê²½ìš° ìƒì„¸ íŒ¨ë„ ì—´ê¸°
                if (loc.type === 'shelter') {
                    openDetailPanel(loc.id);
                } 
                // 3. ì§‘ê²°ì§€ì¸ ê²½ìš° ê¸°ì¡´ ë§í’ì„ (InfoWindow) ì—´ê¸°
                else {
                    openInfoWindow(loc, coords);
                }
            };
        }

        // ============================================================
        // [New] ìƒì„¸ íŒ¨ë„ ì œì–´ í•¨ìˆ˜
        // ============================================================
		var currentEditingShelterId = null;
        function openDetailPanel(shelterId) {
            closeSupplyPanel(); // ë¬¼í’ˆ íŒ¨ë„ ë‹«ê¸°
            currentEditingShelterId = shelterId;
            
            var panel = document.getElementById('detail-panel');
            var contentDiv = document.getElementById('shelter-detail-content');
            
            // 1. UI ì´ˆê¸°í™” (ë³´ê¸° ëª¨ë“œë¡œ ë¦¬ì…‹)
            contentDiv.classList.remove('editing'); 
            document.getElementById('btn-edit-mode').style.display = (userRole <= 2) ? 'inline-block' : 'none';
            document.getElementById('edit-actions').style.display = 'none';
            document.getElementById('panel-header-title').innerText = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

            // 2. íŒ¨ë„ ì—´ê¸°
            panel.classList.add('open');

            // 3. API ë°ì´í„° ìš”ì²­
            fetch(`/api/shelter/${shelterId}/details`)
                .then(r => r.json())
                .then(data => {
                    if(data.result === 'ok') {
                        // í—¤ë” ì œëª©
                        document.getElementById('panel-header-title').innerText = data.name;
                        
                        // [ê¸°ë³¸ ì •ë³´ ë°”ì¸ë”©]
                        // ë³´ê¸° ëª¨ë“œ ê°’ ë„£ê¸°
                        document.getElementById('v-name').innerText = data.name;
                        document.getElementById('v-addr').innerText = data.address || "-";
                        document.getElementById('v-cap').innerText = data.capacity || "0";
                        document.getElementById('v-lat').innerText = data.lat;
                        document.getElementById('v-lng').innerText = data.lng;

                        // ìˆ˜ì • ëª¨ë“œ ê°’ ë„£ê¸° (ë¯¸ë¦¬ ì±„ì›Œë‘ )
                        document.getElementById('e-name').value = data.name;
                        document.getElementById('e-addr').value = data.address || "";
                        document.getElementById('e-cap').value = data.capacity || 0;
                        document.getElementById('e-lat').value = data.lat;
                        document.getElementById('e-lng').value = data.lng;

                        // ê´€ë¦¬ì ìŠ¤ìœ„ì¹˜ UI (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                        var switchArea = document.getElementById('admin-switch-area');
                        switchArea.innerHTML = "";
                        if (userRole <= 2) {
                            var currentLoc = locations.find(l => l.id == shelterId && l.type == 'shelter');
                            var isChecked = currentLoc ? currentLoc.is_active : false;
                            var labelText = isChecked ? "ìš´ì˜ì¤‘" : "ì¤‘ì§€ë¨";
                            
                            switchArea.innerHTML = `
                                <span class="toggle-label">${labelText}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleStatus('shelter', ${shelterId}, '${data.name}')">
                                    <span class="slider"></span>
                                </label>`;
                        }

                        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§)
                        renderList('dt-res-list', data.residents, (item) => `<span>${item.name} (${item.gender})</span> <small>${item.time} ì…ì†Œ</small>`);
                        document.getElementById('dt-res-count').innerText = data.residents.length;
                        renderList('dt-inv-list', data.inventory, (item) => `<span>${item.name}</span> <b>${item.qty}ê°œ</b>`, "ì¬ê³  ì—†ìŒ");
                        renderList('dt-staff-list', data.staff, (item) => `<span>${item.name}</span> <span style="color:#27ae60">ê·¼ë¬´ì¤‘</span>`, "ê·¼ë¬´ì ì—†ìŒ");

                    } else {
                        alert("ì •ë³´ ë¡œë”© ì‹¤íŒ¨: " + data.msg);
                        closeDetailPanel();
                    }
                });
        }

        function closeDetailPanel() {
            document.getElementById('detail-panel').classList.remove('open');
        }
		
		// ìˆ˜ì • ëª¨ë“œ ì§„ì…
        function enableEditMode() {
            // CSS í´ë˜ìŠ¤ í•˜ë‚˜ë¡œ ëª¨ë“  í…ìŠ¤íŠ¸ -> ì¸í’‹ ì „í™˜
            document.getElementById('shelter-detail-content').classList.add('editing');
            
            // ë²„íŠ¼ ì „í™˜
            document.getElementById('btn-edit-mode').style.display = 'none';
            document.getElementById('edit-actions').style.display = 'flex';
        }

        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEditMode() {
            document.getElementById('shelter-detail-content').classList.remove('editing');
            
            document.getElementById('btn-edit-mode').style.display = 'inline-block';
            document.getElementById('edit-actions').style.display = 'none';
            
            // (ì„ íƒ) ì›ë˜ ê°’ìœ¼ë¡œ ì¸í’‹ ë¦¬ì…‹í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ë‹¤ì‹œ API ê°’ í• ë‹¹ ê°€ëŠ¥
        }

        // ìˆ˜ì • ì‚¬í•­ ì €ì¥
        function saveShelterInfo() {
            var id = currentEditingShelterId;
            var payload = {
                name: document.getElementById('e-name').value,
                address: document.getElementById('e-addr').value,
                capacity: document.getElementById('e-cap').value,
                lat: document.getElementById('e-lat').value,
                lng: document.getElementById('e-lng').value
            };

            if(!payload.name) return alert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            fetch(`/api/shelter/${id}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    //alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    
                    // UI ê°±ì‹ ì„ ìœ„í•´ ìƒì„¸ì •ë³´ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                    openDetailPanel(id);
                    
                    // ì§€ë„ ë§ˆì»¤ ìœ„ì¹˜ ë“±ì´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì „ì²´ ìƒˆë¡œê³ ì¹¨ ì‹ í˜¸
                    // (ì†Œì¼“ì´ ìˆë‹¤ë©´ ì†Œì¼“ì´ í•´ì£¼ê² ì§€ë§Œ, ë‚´ í™”ë©´ì€ ì¦‰ì‹œ ë°˜ì˜)
                    updateDashboardData(); 
                } else {
                    alert("ì˜¤ë¥˜: " + data.msg);
                }
            });
        }

        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜
        function renderList(elementId, dataArray, templateFunc, emptyText="ë°ì´í„° ì—†ìŒ") {
            var el = document.getElementById(elementId);
            if (!dataArray || dataArray.length === 0) {
                el.innerHTML = `<li class="empty-msg">${emptyText}</li>`;
                return;
            }
            var html = "";
            dataArray.forEach(item => {
                html += `<li>${templateFunc(item)}</li>`;
            });
            el.innerHTML = html;
        }

        // [ì¶”ê°€] ì§€ë„ ë¹ˆ ê³³ í´ë¦­ ì‹œ íŒ¨ë„ ë‹«ê¸°
        kakao.maps.event.addListener(map, 'click', function() { 
            contextMenu.style.display = 'none'; 
            if(currentInfowindow) currentInfowindow.close(); 
            closeDetailPanel(); // ìƒì„¸ íŒ¨ë„ë„ ë‹«ê¸°
        });

        // [New] ìƒíƒœ í† ê¸€ ìš”ì²­
        window.toggleStatus = function(type, id, name) {
            if(!confirm(`'${name}'ì˜ ìš´ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            fetch('/api/map/toggle_status', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: type, id: id })
            })
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    //alert(data.msg);
                    
                    // UI ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
                    var key = type + '_' + id;
                    var item = markerManager[key];
                    if(item) {
                        item.data.is_active = data.new_status; // ë°ì´í„° ê°±ì‹ 
                        
                        // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ê°±ì‹ 
                        if(data.new_status) item.div.classList.remove('grayscale');
                        else item.div.classList.add('grayscale');
                        
                        // íŒ¨ë„ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ê°±ì‹ 
                        updatePanelItem(key, data.new_status);
                        
                        // ì¸í¬ìœˆë„ìš° ë‹«ê¸° (ë‚´ìš© ê°±ì‹  í•„ìš”í•˜ë¯€ë¡œ)
                        if(currentInfowindow) currentInfowindow.close();
                    }
                } else {
                    alert("ì‹¤íŒ¨: " + data.msg);
                }
            });
        };

        // [ìˆ˜ì •] ì¢Œì¸¡ íŒ¨ë„ ë“±ë¡ í•¨ìˆ˜ (ì´ë²¤íŠ¸ ì—°ê²° ì¶”ê°€)
        function addMarkerToPanel(loc, key) {
            var containerId = loc.type === 'shelter' ? 'shelter-list' : 'assembly-list';
            var container = document.getElementById(containerId);
            
            // 1. ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
            var div = document.createElement('div');
            div.className = 'marker-item';
            div.id = 'panel-' + key;
            if(!loc.is_active) div.classList.add('inactive'); 
            
            // 2. ì´ë²¤íŠ¸ 1: ì¹´ë“œ ì „ì²´ í´ë¦­ -> ìƒì„¸ì •ë³´(êµ¬í˜¸ì†Œ) ë˜ëŠ” ì§€ë„ì´ë™(ì§‘ê²°ì§€)
            div.onclick = function() {
                if (loc.type === 'shelter') {
                    // êµ¬í˜¸ì†ŒëŠ” ìƒì„¸ íŒ¨ë„ ì—´ê¸°
                    openDetailPanel(loc.id);
                } else {
                    // ì§‘ê²°ì§€ëŠ” í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™ ë° ë§í’ì„  ì—´ê¸°
                    var moveLatLon = new kakao.maps.LatLng(loc.lat, loc.lng);
                    map.panTo(moveLatLon);
                    openInfoWindow(loc, moveLatLon);
                }
            };

            // ë§ˆìš°ìŠ¤ ì˜¤ë²„ íš¨ê³¼ (ê¸°ì¡´ ìœ ì§€)
            div.onmouseenter = function() { highlightMarker(key); };
            div.onmouseleave = function() { unhighlightMarker(key); };

            // 3. ì•„ì´ì½˜ ì´ë¯¸ì§€ ìƒì„± (ë²„íŠ¼ ì—­í• )
            var iconImg = document.createElement('img');
            iconImg.src = (loc.type === 'shelter') ? IMG_SHELTER : IMG_ASSEMBLY;
            iconImg.className = 'marker-icon';
            iconImg.title = "í´ë¦­í•˜ì—¬ ì§€ë„ì—ì„œ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°"; // íˆ´íŒ ì¶”ê°€
            
            // [í•µì‹¬] ì´ë²¤íŠ¸ 2: ì•„ì´ì½˜ í´ë¦­ -> ì§€ë„ ë§ˆì»¤ í† ê¸€ (ìƒìœ„ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨)
            iconImg.onclick = function(e) {
                e.stopPropagation(); // ì¹´ë“œ í´ë¦­(ìƒì„¸ë³´ê¸°)ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë§‰ìŒ
                toggleMapVisibility(key);
            };

            // 4. ì •ë³´ í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
            var infoBox = document.createElement('div');
            infoBox.className = 'marker-info-box';
            
            var html = `<div class="marker-name">${loc.name}</div>`;
            if (loc.type === 'shelter' && (loc.stat_resident || loc.stat_staff)) {
                html += `<div class="marker-stats">`;
                html += `<span class="stat-badge">ğŸ‘¥${loc.stat_resident || 0}</span>`;
                html += `<span class="staff-badge">ğŸ‘®${loc.stat_staff || 0}</span>`;
                html += `</div>`;
            }
            infoBox.innerHTML = html;

            // 5. ì¡°ë¦½
            div.appendChild(iconImg);
            div.appendChild(infoBox);
            container.appendChild(div);
        }

        // [New] ë§ˆì»¤ í•˜ì´ë¼ì´íŠ¸ ì œì–´ í•¨ìˆ˜
        function highlightMarker(key) {
            var item = markerManager[key];
            if (item && item.div) {
                item.div.classList.add('highlight'); // CSS í´ë˜ìŠ¤ ì¶”ê°€
            }
        }

        function unhighlightMarker(key) {
            var item = markerManager[key];
            if (item && item.div) {
                item.div.classList.remove('highlight'); // CSS í´ë˜ìŠ¤ ì œê±°
            }
        }

        function updatePanelItem(key, isActive) {
            var div = document.getElementById('panel-' + key);
            if(isActive) div.classList.remove('inactive');
            else div.classList.add('inactive');
        }

        // ì§€ë„ í‘œì‹œ í† ê¸€ (ëˆˆ ë„ê¸°/ì¼œê¸°)
        function toggleMapVisibility(key) {
            var item = markerManager[key];
            if (!item) return;
            var isVisible = !item.visible;
            item.visible = isVisible;
            item.overlay.setMap(isVisible ? map : null);
            
            var uiItem = document.getElementById('panel-' + key);
            if (!isVisible) uiItem.classList.add('hidden-map');
            else uiItem.classList.remove('hidden-map');
        }

        // ==============================
        // ì—°ê²° ë¡œì§ (Helper wrappers)
        // ==============================
        window.startConnectModeId = function(id) {
            // IDë¡œ loc ê°ì²´ ì°¾ê¸°
            var key = 'assembly_' + id;
            var item = markerManager[key];
            if(item) startConnectMode(item.data);
        }

        function startConnectMode(loc) {
            if (currentInfowindow) currentInfowindow.close(); 
            pendingSourceNode = loc; 
            document.getElementById('connect-guide').style.display = 'block';
        }
        window.cancelConnect = function() {
            pendingSourceNode = null;
            document.getElementById('connect-guide').style.display = 'none';
        }
        function completeConnection(targetLoc) {
            var sourceNode = pendingSourceNode; 
            if (confirm(`[${sourceNode.name}] â¡ï¸ [${targetLoc.name}]\nì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch('/api/map/connect', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ assembly_id: sourceNode.id, shelter_id: targetLoc.id })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.result === 'ok') {
                        var startStr = sourceNode.lng + "," + sourceNode.lat;
                        var endStr = targetLoc.lng + "," + targetLoc.lat;
                        var wayString = encodeURIComponent(data.waypoints || ""); 
                        var url = `/get_kakao_route?start=${startStr}&end=${endStr}&way=${wayString}`;
                        fetch(url).then(res => res.json()).then(json => {
                            if (json.result === 'ok') {
                                var linePath = json.path.map(p => new kakao.maps.LatLng(p.lat, p.lng));
                                drawPathAndAddToLegend(linePath, sourceNode.name, targetLoc.name);
                            }
                        });
                    } else { alert("ì˜¤ë¥˜: " + data.msg); }
                });
            }
            cancelConnect();
        }

        // 1. ê²½ë¡œ ê·¸ë¦¬ê¸° ë° ë²”ë¡€ ì¶”ê°€
        function drawPathAndAddToLegend(linePath, startName, endName) {
            var routeColor = ROUTE_COLORS[colorIndex++ % ROUTE_COLORS.length];
            
            // ì„  ê·¸ë¦¬ê¸°
            var polyline = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 5,
                strokeColor: routeColor,
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
            });
            polyline.setMap(map);
            
            // í™”ì‚´í‘œ ê·¸ë¦¬ê¸°
            var arrows = createArrowsOnPath(linePath, routeColor);
            
            // ê´€ë¦¬ ê°ì²´ ë“±ë¡
            var routeId = `route_${routeCount++}`;
            routeManager[routeId] = { polyline: polyline, arrows: arrows, visible: true };
            
            // ë²”ë¡€ì— ì¶”ê°€
            var div = document.createElement('div');
            div.className = 'route-item';
            div.id = 'legend-' + routeId;
            div.onclick = function() { toggleRoute(routeId); }; 
            div.innerHTML = `<div class="color-box" style="background:${routeColor};"></div><div style="overflow:hidden; text-overflow:ellipsis;"><b>${startName}</b> â†’ ${endName}</div>`;
            document.getElementById('legend-list').appendChild(div);
        }

        // 2. ê²½ë¡œ í† ê¸€ í•¨ìˆ˜
        window.toggleRoute = function(routeId) {
            var routeData = routeManager[routeId];
            if (!routeData) return;
            var isVisible = !routeData.visible;
            routeData.visible = isVisible;
            if (isVisible) {
                routeData.polyline.setMap(map);
                routeData.arrows.forEach(a => a.setMap(map));
                document.getElementById('legend-' + routeId).classList.remove('hidden');
            } else {
                routeData.polyline.setMap(null);
                routeData.arrows.forEach(a => a.setMap(null));
                document.getElementById('legend-' + routeId).classList.add('hidden');
            }
        };

        // ==============================
        // ìš°í´ë¦­ ë©”ë‰´ (ê¶Œí•œ ì œì–´)
        // ==============================
        var contextMenu = document.getElementById('contextMenu');
        if (userRole <= 2) {
            kakao.maps.event.addListener(map, 'rightclick', function(mouseEvent) {
                var latlng = mouseEvent.latLng;
                clickedLat = latlng.getLat(); clickedLng = latlng.getLng();
                contextMenu.style.display = 'block';
                var evt = window.event; 
                contextMenu.style.left = evt.clientX + 'px'; contextMenu.style.top = evt.clientY + 'px';
            });
        }
        kakao.maps.event.addListener(map, 'click', function() { 
            contextMenu.style.display = 'none'; 
            if(currentInfowindow) currentInfowindow.close(); 
        });

        window.addNode = function(type) {
            contextMenu.style.display = 'none';
            var typeName = type === 'shelter' ? 'ğŸ¥êµ¬í˜¸ì†Œ' : 'ğŸš©ì§‘ê²°ì§€';
            var name = prompt(`${typeName}ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš” :`);
            if (name) {
                fetch('/api/map/add_node', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: type, name: name, lat: clickedLat, lng: clickedLng })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.result === 'ok') {
                        //alert(data.msg);
                        // ìƒˆë¡œ ì¶”ê°€ëœ ë…¸ë“œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í™œì„± ìƒíƒœ
                        var newLoc = { id: data.id, name: name, lat: clickedLat, lng: clickedLng, type: type, route_infos: [], is_active:true, stat_resident:0, stat_staff:0 };
                        locations.push(newLoc);
                        createCustomMarker(new kakao.maps.LatLng(clickedLat, clickedLng), newLoc); 
                    } else { alert("ì˜¤ë¥˜: " + data.msg); }
                });
            }
        };

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function calculateAngle(startLat, startLng, endLat, endLng) {
            var dy = endLat - startLat; var dx = endLng - startLng;
            var theta = Math.atan2(dy, dx); theta *= 180 / Math.PI; return theta; 
        }
        function createArrowsOnPath(path, color) {
            var arrows = []; var step = 10; 
            for (var i = 0; i < path.length - step; i += step) {
                var p1 = path[i]; var p2 = path[i + 5]; if (!p2) continue;
                var angle = calculateAngle(p1.getLat(), p1.getLng(), p2.getLat(), p2.getLng());
                var content = `<div class="arrow-overlay" style="color:${color}; transform: rotate(${-angle}deg);">â¤</div>`;
                var overlay = new kakao.maps.CustomOverlay({ map: map, position: p1, content: content, yAnchor: 0.5, xAnchor: 0.5 });
                arrows.push(overlay);
            }
            return arrows;
        }
		
		function openInfoWindow(loc, coords) {
            if (currentInfowindow) currentInfowindow.close();

            var content = document.createElement('div');
            
            // ì œëª© ì„¤ì •
            var titleColor = loc.is_active ? '#e74c3c' : '#777'; // ì§‘ê²°ì§€ëŠ” ë¹¨ê°•/íšŒìƒ‰
            var statusText = loc.is_active ? '' : '(ìš´ì˜ì¤‘ì§€)';
            
            var html = `<div class="iw-container">`;
            html += `<span class="iw-title" style="color:${titleColor}">${loc.name} </span>`;//<small>${statusText}</small>
            
            // [New] ê´€ë¦¬ì ì „ìš© ì»¨íŠ¸ë¡¤ ë²„íŠ¼
            if (userRole <= 2) {
                html += `<div class="iw-controls">`;
                
                // 1. ì—°ê²° ë²„íŠ¼ (í™œì„± ìƒíƒœì¼ ë•Œë§Œ)
                if (loc.is_active) {
                    html += `<button class="iw-btn-action btn-connect" onclick="startConnectModeId(${loc.id})">ğŸ”— êµ¬í˜¸ì†Œ ì—°ê²°</button>`;
                }
                
                // 2. ìš´ì˜ í† ê¸€ ë²„íŠ¼
                if (loc.is_active) {
                    html += `<button class="iw-btn-action btn-stop" onclick="toggleStatus('${loc.type}', ${loc.id}, '${loc.name}')">â›” ìš´ì˜ ì¤‘ì§€</button>`;
                } else {
                    html += `<button class="iw-btn-action btn-start" onclick="toggleStatus('${loc.type}', ${loc.id}, '${loc.name}')">âœ… ìš´ì˜ ì¬ê°œ</button>`;
                }
                
                html += `</div>`;
            }
            html += `</div>`;

            content.innerHTML = html;

            var infowindow = new kakao.maps.InfoWindow({
                content: content,
                position: coords,
                removable: true,
                zIndex: 10
            });
            infowindow.open(map); 
            currentInfowindow = infowindow;
        }
		
		// ============================================================
        // [í•µì‹¬] í™”ë©´ ê°±ì‹  í•¨ìˆ˜ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°ì´í„°ë§Œ ì‹¹ ë°”ê¿ˆ)
        // ============================================================
        function updateDashboardData() {
            fetch('/api/map/refresh_data')
            .then(r => r.json())
            .then(data => {
                if(data.result !== 'ok') return;

                // (A) ìƒë‹¨ í†µê³„ ì¹´ë“œ ìˆ«ì ê°±ì‹  (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¥¼ ì£¼ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬)
                document.getElementById('val-residents').innerText = data.summary.residents;
                document.getElementById('val-supplies').innerText = data.summary.supplies;
                document.getElementById('val-shelters').innerText = data.summary.shelters;
                document.getElementById('val-assemblies').innerText = data.summary.assemblies;

                // (B) ê° ì‹œì„¤ë³„ ìƒíƒœ(ìš´ì˜ì¤‘/ì¤‘ì§€, ì¸ì›ìˆ˜) ê°±ì‹ 
                data.locations.forEach(loc => {
                    var key = loc.type + '_' + loc.id;
                    var item = markerManager[key]; // ê´€ë¦¬ ê°ì²´ì—ì„œ ì°¾ìŒ
                    
                    if (item) {
                        // 1. ë°ì´í„° ì—…ë°ì´íŠ¸
                        item.data.is_active = loc.is_active;
                        if(loc.type === 'shelter') {
                            item.data.stat_resident = loc.stat_resident;
                            item.data.stat_staff = loc.stat_staff;
                        }

                        // 2. ì§€ë„ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (í‘ë°±ì²˜ë¦¬)
                        if (item.div) {
                            if (loc.is_active) item.div.classList.remove('grayscale');
                            else item.div.classList.add('grayscale');
                        }

                        // 3. ì¢Œì¸¡ íŒ¨ë„(ëª©ë¡) ì—…ë°ì´íŠ¸
                        var panelItem = document.getElementById('panel-' + key);
                        if (panelItem) {
                            // (3-1) ë°°ê²½/ì•„ì´ì½˜ ìŠ¤íƒ€ì¼
                            if (loc.is_active) panelItem.classList.remove('inactive');
                            else panelItem.classList.add('inactive');

                            // (3-2) ë±ƒì§€ ìˆ«ì ì—…ë°ì´íŠ¸ (êµ¬í˜¸ì†Œì¸ ê²½ìš°)
                            if (loc.type === 'shelter') {
                                // querySelectorë¡œ ë‚´ë¶€ ë±ƒì§€ ì°¾ì•„ì„œ ìˆ«ì ë³€ê²½
                                var badgeRes = panelItem.querySelector('.stat-badge');
                                var badgeStaff = panelItem.querySelector('.staff-badge');
                                if(badgeRes) badgeRes.innerText = `ğŸ‘¥${loc.stat_resident}`;
                                if(badgeStaff) badgeStaff.innerText = `ğŸ‘®${loc.stat_staff}`;
                            }
                        }
                    }
                });
                
                // ë§Œì•½ í˜„ì¬ ì—´ë ¤ìˆëŠ” ìƒì„¸ íŒ¨ë„ì´ ìˆë‹¤ë©´ ì •ë³´ ê°±ì‹  (ì„ íƒì‚¬í•­)
                // í˜„ì¬ ë³´ê³  ìˆëŠ” êµ¬í˜¸ì†Œë¼ë©´ refreshDetailPanel() ê°™ì€ ê±¸ í˜¸ì¶œí•  ìˆ˜ë„ ìˆìŒ
            })
            .catch(err => console.error("Data Refresh Error:", err));
        }
		
		
// ============================================================
        // [New] ë¬¼í’ˆ ê´€ë¦¬ íŒ¨ë„ (Slide-out) ê¸°ëŠ¥
        // ============================================================
        
        // 1. íŒ¨ë„ ì—´ê¸°/ë‹«ê¸°
        function openSupplyPanel() {
            if (userRole > 2) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            // êµ¬í˜¸ì†Œ ìƒì„¸íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸° (ê²¹ì¹¨ ë°©ì§€)
            closeDetailPanel();
            
            var panel = document.getElementById('supply-panel');
            panel.classList.add('open');
            
            loadHqSupplies(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        }

        function closeSupplyPanel() {
            document.getElementById('supply-panel').classList.remove('open');
        }

        // 2. ë³¸ì²­ ë¬¼í’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadHqSupplies() {
            var listContainer = document.getElementById('hq-supply-list');
            listContainer.innerHTML = "<div class='empty-msg'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>";

            fetch('/api/supplies/hq')
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    renderSupplyCards(data.supplies, data.shelters);
                } else {
                    listContainer.innerHTML = "<div class='empty-msg'>ì˜¤ë¥˜ ë°œìƒ</div>";
                }
            });
        }

        // 3. ë³¸ì²­ ë¬¼í’ˆ ì…ê³  (ì¶”ê°€)
        function addHqSupply() {
            var nameInput = document.getElementById('new-item-name');
            var qtyInput = document.getElementById('new-item-qty');
            
            var name = nameInput.value.trim();
            var qty = qtyInput.value;

            if(!name) return alert("í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if(!qty || qty <= 0) return alert("ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");

            fetch('/api/supplies/add_hq', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_name: name, quantity: qty })
            })
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    alert(data.msg);
                    nameInput.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
                    qtyInput.value = '';
                    loadHqSupplies(); // ëª©ë¡ ê°±ì‹ 
                } else {
                    alert("ì‹¤íŒ¨: " + data.msg);
                }
            });
        }

        // 4. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì¹´ë“œ í˜•íƒœ)
        function renderSupplyCards(supplies, shelters) {
            var container = document.getElementById('hq-supply-list');
            
            if(!supplies || supplies.length === 0) {
                container.innerHTML = "<div class='empty-msg'>ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ ì‹ ê·œ ì…ê³ ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.</div>";
                return;
            }
            
            // ë°°ë¶„ ëŒ€ìƒ êµ¬í˜¸ì†Œ ì˜µì…˜ ë¯¸ë¦¬ ìƒì„±
            var shelterOptions = shelters.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            container.innerHTML = supplies.map(item => `
                <div class="supply-card-item">
                    <div class="supply-card-header">
                        <span class="supply-name">${item.name}</span>
                        <span class="supply-total">${item.qty}ê°œ</span>
                    </div>
                    
                    <div class="dist-control">
                        <select id="sel-target-${item.id}" class="dist-select">
                            <option value="">êµ¬í˜¸ì†Œ ì„ íƒ</option>
                            ${shelterOptions}
                        </select>
                        <input type="number" id="inp-qty-${item.id}" class="dist-input" placeholder="0" min="-999" max="${item.qty}">
                        <button class="btn-dist" onclick="distributeSupply('${item.name}', ${item.id})">ë°°ë¶„</button>
                    </div>
                </div>
            `).join('');
        }

        // 5. ë¬¼í’ˆ ë°°ë¶„ (ë³¸ì²­ -> êµ¬í˜¸ì†Œ)
        function distributeSupply(itemName, itemId) {
            var targetId = document.getElementById(`sel-target-${itemId}`).value;
            var qty = document.getElementById(`inp-qty-${itemId}`).value;

            if(!targetId) return alert("ë°°ë¶„í•  êµ¬í˜¸ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if(!qty) return alert("ë°°ë¶„í•  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            if(!confirm(`[${itemName}] ${qty}ê°œë¥¼ ì„ íƒí•œ êµ¬í˜¸ì†Œë¡œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            fetch('/api/supplies/distribute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    item_name: itemName,
                    quantity: qty,
                    target_id: targetId
                })
            })
            .then(r => r.json())
            .then(data => {
                if(data.result === 'ok') {
                    alert(data.msg);
                    // ì†Œì¼“ì´ ìë™ìœ¼ë¡œ ê°±ì‹ í•´ì£¼ê² ì§€ë§Œ, ì¦‰ê° ë°˜ì‘ì„ ìœ„í•´ í˜¸ì¶œ
                    loadHqSupplies(); 
                } else {
                    alert("ì‹¤íŒ¨: " + data.msg);
                }
            });
        }
		
	
		
// ì•Œë¦¼ì°½ í† ê¸€ ë¡œì§
let isCollapsed = true;

function togglePanel(event) {
    // ë¹„ìš°ê¸° ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” í† ê¸€ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
    if (event.target.tagName === 'BUTTON') return;

    const notificationpanel = document.getElementById('notification-panel');
    const icon = document.getElementById('toggle-icon');
    
    if (!isCollapsed) {
        notificationpanel.style.bottom = '-140px';
        icon.innerText = 'â–²';
        isCollapsed = true;
    } else {
        notificationpanel.style.bottom = '-1px';
        icon.innerText = 'â–¼';
        isCollapsed = false;
    }
}		
		
// 4. í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì•Œë¦¼ ë Œë”ë§
document.addEventListener("DOMContentLoaded", () => {
	// 1. ê¸°ì¡´ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
	const saved = JSON.parse(localStorage.getItem('shelter_notifications') || '[]');
	renderNotifications(saved);

	// 2. ì„œë²„ì—ì„œ ë³´ë‚¸ Flash ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸ (Jinja2 ë¬¸ë²•)
	{% with messages = get_flashed_messages(with_categories=true) %} 
		{% if messages %}
			{% for category, message in messages %}
				// ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì•„ì´ì½˜/ìƒ‰ìƒ ê²°ì •
				let icon = 'ğŸ“¢';
				let color = '#3498db'; // ê¸°ë³¸ íŒŒë‘

				if ("{{ category }}" === "error") {
					icon = 'âŒ';
					color = '#e74c3c'; // ë¹¨ê°•
				} else if ("{{ category }}" === "warning") {
					icon = 'âš ï¸';
					color = '#f1c40f'; // ë…¸ë‘
				} else if ("{{ category }}" === "success") {
					icon = 'âœ…';
					color = '#2ecc71'; // ì´ˆë¡
				}

				// ê°€ì§œ ì•Œë¦¼ ê°ì²´ ìƒì„±
				const flashNoti = {
					message: message,
					time: new Date().toLocaleTimeString('ko-KR', {hour12: false}),
					type: "{{ category }}", // ì €ì¥ìš© íƒ€ì…
					color: color,           // UIìš© ìƒ‰ìƒ
					icon: icon              // UIìš© ì•„ì´ì½˜
				};
				
				// ì•Œë¦¼ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
				handleNotification(flashNoti);
			{% endfor %}
		{% endif %}
	{% endwith %}
});

// [UI í•¨ìˆ˜] ì•Œë¦¼ ëª©ë¡ ê·¸ë¦¬ê¸°
function renderNotifications(dataArray) {
	const notiList = document.getElementById('notification-list');
	if (!notiList) return;

	if (dataArray.length === 0) {
		notiList.innerHTML = '<div class="empty-msg" style="text-align:center; color:#94a3b8; margin-top:30px;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
		return;
	}
	notiList.innerHTML = dataArray.map(data => {
        // ë°ì´í„°ì— ì €ì¥ëœ ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        const borderCol = data.color || '#3498db'; 
        const icon = data.icon || '';
        
        return `
            <div style="background:white; padding:12px; border-radius:10px; margin-bottom:10px; border-left:5px solid ${borderCol}; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <strong style="font-size:0.9rem;">${icon} ${data.message}</strong>
                    <small style="color:#999;">${data.time}</small>
                </div>
            </div>
        `;
    }).join('');
}

function handleNotification(data) {
	// 1. ì €ì¥
	let saved = JSON.parse(localStorage.getItem('shelter_notifications') || '[]');
	saved.unshift(data);
	if (saved.length > 50) saved.pop();
	localStorage.setItem('shelter_notifications', JSON.stringify(saved));

	// 2. ë Œë”ë§
	renderNotifications(saved);
	/*
	// 3. íŒ¨ë„ ì—´ê¸°
	const panel = document.getElementById('notification-panel');
	const icon = document.getElementById('toggle-icon');
	if (panel) {
		panel.style.bottom = '-1px';
		if(icon) icon.innerText = 'â–¼';
	}
	*/
}


// 4. ì•Œë¦¼ ë¹„ìš°ê¸°
function clearNotifications() {
    if (confirm('ëª¨ë“  ì•Œë¦¼ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('shelter_notifications');
        renderNotifications([]);
    }
}
    </script>
</body>
</html>