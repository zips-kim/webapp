{% extends "layout.html" %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3">
        <h4 class="mb-0 fw-bold">
            {% if mode == 'edit' %}
                ğŸ› ï¸ {{ form_def.title }} <span class="text-warning fs-6">ì„¤ì • ìˆ˜ì •</span>
            {% else %}
                âœ¨ ìƒˆ ì‹œìŠ¤í…œ ë§Œë“¤ê¸° <span class="text-primary fs-6">Form Builder</span>
            {% endif %}
        </h4>
    </div>
    <div class="card-body p-4">
        
        <form method="POST">
            <div class="row mb-4">
                <div class="col-12 mb-3">
                    <label class="form-label fw-bold">ì‹œìŠ¤í…œ ì´ë¦„ (Title)</label>
                    <input type="text" name="title" class="form-control" 
                           placeholder="ì˜ˆ: ì„ì§ì› ê´€ë¦¬, ì¥ë¹„ í˜„í™©" 
                           value="{{ form_def.title if form_def else '' }}" required>
                </div>
				
				<div class="col-12 mb-3">
					<label class="form-label fw-bold small text-muted">ì‹œìŠ¤í…œ ì„±ê²© (Data Type)</label>
					<div class="d-flex gap-3 border rounded p-2 bg-light">
						<div class="form-check">
							<input class="form-check-input" type="radio" name="category" id="cat_general" value="general"
								   {% if not form_def or form_def.category == 'general' %}checked{% endif %}>
							<label class="form-check-label" for="cat_general">
								ğŸ“„ ì¼ë°˜ ë°ì´í„° (Data) <small class="text-muted ms-1">- ì—…ë¬´ ë‚´ì—­, íŠ¸ëœì­ì…˜</small>
							</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="category" id="cat_standard" value="standard"
								   {% if form_def and form_def.category == 'standard' %}checked{% endif %}>
							<label class="form-check-label fw-bold text-primary" for="cat_standard">
								ğŸ·ï¸ ê¸°ì´ˆ ì½”ë“œ (Master) <small class="text-muted ms-1">- ë¶€ì„œ, í’ˆëª©, ì°½ê³  ë“± ê¸°ì¤€ ì •ë³´</small>
							</label>
						</div>
					</div>
				</div>

                <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">ëª©ë¡ ë³´ê¸° ë°©ì‹</label>
                    <div class="d-flex gap-3 mt-1">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="view_type" id="view_list" value="list"
                                   {% if not form_def or form_def.view_type == 'list' %}checked{% endif %}>
                            <label class="form-check-label" for="view_list">ğŸ“‹ ë¦¬ìŠ¤íŠ¸í˜• (Table)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="view_type" id="view_card" value="card"
                                   {% if form_def and form_def.view_type == 'card' %}checked{% endif %}>
                            <label class="form-check-label" for="view_card">ğŸªª ì¹´ë“œí˜• (Grid)</label>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">í˜ì´ì§€ë‹¹ í‘œì‹œ ê°œìˆ˜</label>
                    <input type="number" name="page_limit" class="form-control" style="max-width: 150px;"
                           value="{{ form_def.page_limit if form_def and form_def.page_limit else 10 }}" 
                           min="1" max="500" required>
                </div>
            </div>

            <hr>

            <h5 class="fw-bold mb-3">ë°ì´í„° í•­ëª© ì •ì˜</h5>
            <div id="field-container">
                {% if schema %}
                    {% for field in schema %}
                    <div class="card p-3 mb-3 bg-light field-row border-0 shadow-sm">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">
                                    {% if loop.first %}ğŸ“Œ ëŒ€í‘œ í•­ëª© (í•„ìˆ˜){% else %}í•­ëª© ì´ë¦„{% endif %}
                                </label>
                                <input type="text" name="field_name[]" class="form-control" value="{{ field.key }}" required>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="small fw-bold text-muted">íƒ€ì…</label>
                                <select name="field_type[]" class="form-select" onchange="toggleRelationOptions(this)">
                                    <option value="text" {% if field.type == 'text' %}selected{% endif %}>ì§§ì€ ê¸€ (Text)</option>
                                    <option value="number" {% if field.type == 'number' %}selected{% endif %}>ìˆ«ì (Number)</option>
                                    <option value="date" {% if field.type == 'date' %}selected{% endif %}>ë‚ ì§œ (Date)</option>
                                    <option value="file" {% if field.type == 'file' %}selected{% endif %}>íŒŒì¼ ì²¨ë¶€ (File)</option>
                                    <option value="relation" {% if field.type == 'relation' %}selected{% endif %}>ğŸ”— ë‹¤ë¥¸ í¼ ì°¸ì¡°</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">ì„¤ì •</label>
                                <div class="d-flex gap-2 mt-1">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="field_required[]" value="{{ loop.index0 }}" 
                                               {% if field.required or loop.first %}checked{% endif %}
                                               {% if loop.first %}onclick="return false;" style="opacity: 0.5;"{% endif %}>
                                        <label class="form-check-label small">í•„ìˆ˜</label>
                                        {% if loop.first %}<input type="hidden" name="field_required[]" value="{{ loop.index0 }}">{% endif %}
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="field_unique[]" value="{{ loop.index0 }}" {% if field.unique %}checked{% endif %}>
                                        <label class="form-check-label small">ì¤‘ë³µê¸ˆì§€</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="field_show_list[]" value="{{ loop.index0 }}" 
                                               {% if field.show_list or loop.first %}checked{% endif %}>
                                        <label class="form-check-label small">ëª©ë¡ë…¸ì¶œ</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-1 text-end">
                                <label class="d-block small">&nbsp;</label>
                                {% if not loop.first %}
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeField(this)">ğŸ—‘ï¸</button>
                                {% else %}
                                    <button type="button" class="btn btn-light btn-sm" disabled>ğŸ”’</button>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mt-2" id="option-row" style="display: {% if field.type == 'relation' %}none{% else %}block{% endif %};">
                            <input type="text" name="field_options[]" class="form-control form-control-sm bg-white" 
                                   placeholder="ì„ íƒ ì˜µì…˜ ì…ë ¥ (ì˜ˆ: ë‚¨,ì—¬,ê¸°íƒ€ / ì„œìš¸,ê²½ê¸°,ì¸ì²œ) - ì½¤ë§ˆë¡œ êµ¬ë¶„" 
                                   value="{{ field.options }}">
                        </div>

                        <div class="relation-options mt-2 p-2 border rounded bg-white" style="display: {% if field.type == 'relation' %}block{% else %}none{% endif %};">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted">ì°¸ì¡°í•  ì‹œìŠ¤í…œ</small>
                                    <select name="field_target[]" class="form-select form-select-sm">
                                        <option value="">-- ì„ íƒ --</option>
                                        {% for f in all_forms %}
                                            <option value="{{ f.id }}" {% if field.target_id|string == f.id|string %}selected{% endif %}>{{ f.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">í‘œì‹œ ë°©ì‹</small>
                                    <select name="field_widget[]" class="form-select form-select-sm">
                                        <option value="select" {% if field.widget == 'select' %}selected{% endif %}>ë“œë¡­ë‹¤ìš´ (Single)</option>
                                        <option value="radio" {% if field.widget == 'radio' %}selected{% endif %}>ë¼ë””ì˜¤ë²„íŠ¼ (Single)</option>
                                        <option value="checkbox" {% if field.widget == 'checkbox' %}selected{% endif %}>ì²´í¬ë°•ìŠ¤ (Multi)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>

            <button type="button" class="btn btn-outline-primary w-100 py-2 border-dashed fw-bold" onclick="addField()">
                + í•­ëª© ì¶”ê°€í•˜ê¸°
            </button>

            <hr class="my-4">

            <h4 class="fw-bold mb-3">ğŸ”’ ìƒì„¸ ê¶Œí•œ ì„¤ì •</h4>
            <div class="card bg-light border-0 mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="authTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-create" type="button">â• ë“±ë¡ ê¶Œí•œ</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-update" type="button">âœï¸ ìˆ˜ì • ê¶Œí•œ</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-delete" type="button">ğŸ—‘ï¸ ì‚­ì œ ê¶Œí•œ</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body bg-white border border-top-0">
                    <div class="tab-content" id="authTabContent">
                        
                        {% macro user_checkboxes(name, saved_value) %}
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input check-all" type="checkbox" data-target="{{ name }}" 
                                           {% if not saved_value %}checked{% endif %}>
                                    <label class="form-check-label fw-bold small">ì „ì²´ í—ˆìš© (ê¸°ë³¸ê°’)</label>
                                </div>
                            </div>
                            <div class="row g-2 ps-2 border-start border-3">
                                {% for user in all_users %}
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <div class="form-check">
                                            <input class="form-check-input user-check-{{ name }}" type="checkbox" 
                                                   name="{{ name }}" value="{{ user.id }}"
                                                   {% if saved_value and user.id in saved_value.split(',') %}checked{% endif %}>
                                            <label class="form-check-label small">{{ user.name }}</label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="form-text small mt-2">* ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ 'ì „ì²´ í—ˆìš©'ì´ ë©ë‹ˆë‹¤. (ê´€ë¦¬ìëŠ” í•­ìƒ ê°€ëŠ¥)</div>
                        {% endmacro %}

                        <div class="tab-pane fade show active" id="tab-create">
                            {{ user_checkboxes('access_create', form_def.access_create if form_def else '') }}
                        </div>
                        
                        <div class="tab-pane fade" id="tab-update">
                            {{ user_checkboxes('access_update', form_def.access_update if form_def else '') }}
                        </div>
                        
                        <div class="tab-pane fade" id="tab-delete">
                            {{ user_checkboxes('access_delete', form_def.access_delete if form_def else '') }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {% if mode == 'edit' %}
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteForm()">
                            ğŸ—‘ï¸ ì´ ì‹œìŠ¤í…œ ì‚­ì œ
                        </button>
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <a href="/" class="btn btn-secondary px-4">ì·¨ì†Œ</a>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </form>
        
        {% if mode == 'edit' %}
        <form id="deleteForm" action="/form/delete/{{ form_def.id }}" method="POST" style="display:none;"></form>
        <script>
            function confirmDeleteForm() {
                if(confirm("âš ï¸ ê²½ê³ : ì´ ì‹œìŠ¤í…œì„ ì‚­ì œí•˜ë©´ ëª¨ë“  ë°ì´í„°ì™€ ë©”ë‰´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    document.getElementById('deleteForm').submit();
                }
            }
        </script>
        {% endif %}
        
    </div>
</div>

<template id="field-template">
    <div class="card p-3 mb-3 bg-light field-row border-0 shadow-sm">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <label class="small fw-bold text-muted">í•­ëª© ì´ë¦„</label>
                <input type="text" name="field_name[]" class="form-control" placeholder="í•­ëª©ëª…" required>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold text-muted">íƒ€ì…</label>
                <select name="field_type[]" class="form-select" onchange="toggleRelationOptions(this)">
                    <option value="text">ì§§ì€ ê¸€ (Text)</option>
                    <option value="number">ìˆ«ì (Number)</option>
                    <option value="date">ë‚ ì§œ (Date)</option>
                    <option value="file">íŒŒì¼ (File)</option>
                    <option value="relation">ğŸ”— ê´€ê³„í˜•</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold text-muted">ì„¤ì •</label>
                <div class="d-flex gap-2 mt-1">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="field_required[]">
                        <label class="form-check-label small">í•„ìˆ˜</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="field_unique[]">
                        <label class="form-check-label small">ì¤‘ë³µê¸ˆì§€</label>
                    </div>
                     <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="field_show_list[]" checked>
                        <label class="form-check-label small">ëª©ë¡ë…¸ì¶œ</label>
                    </div>
                </div>
            </div>
            <div class="col-md-1 text-end">
                <label class="d-block small">&nbsp;</label>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeField(this)">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="mt-2" id="option-row">
            <input type="text" name="field_options[]" class="form-control form-control-sm bg-white" 
                   placeholder="ì„ íƒ ì˜µì…˜ ì…ë ¥ (ì˜ˆ: ë‚¨,ì—¬ / ì„œìš¸,ê²½ê¸°) - ì½¤ë§ˆ êµ¬ë¶„">
        </div>

        <div class="relation-options mt-2 p-2 border rounded bg-white" style="display:none;">
            <div class="row g-2">
                <div class="col-6">
                    <small>ì°¸ì¡°í•  ì‹œìŠ¤í…œ</small>
                    <select name="field_target[]" class="form-select form-select-sm">
                        <option value="">-- ì„ íƒ --</option>
                        {% for f in all_forms %}
                            <option value="{{ f.id }}">{{ f.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-6">
                    <small>í‘œì‹œ ë°©ì‹</small>
                    <select name="field_widget[]" class="form-select form-select-sm">
                        <option value="select">ë“œë¡­ë‹¤ìš´</option>
                        <option value="radio">ë¼ë””ì˜¤ë²„íŠ¼</option>
                        <option value="checkbox">ì²´í¬ë°•ìŠ¤</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if(document.querySelectorAll('.field-row').length === 0) {
            addFirstField();
        }
        
        // [NEW] ê¶Œí•œ ì„¤ì • ì²´í¬ë°•ìŠ¤ ë™ì‘ ë¡œì§
        document.querySelectorAll('.check-all').forEach(allBox => {
            const targetName = allBox.dataset.target;
            const subBoxes = document.querySelectorAll(`.user-check-${targetName}`);
            
            // ì „ì²´ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ -> í•˜ìœ„ ëª¨ë‘ í•´ì œ
            allBox.addEventListener('change', function() {
                if(this.checked) {
                    subBoxes.forEach(box => box.checked = false);
                }
            });

            // í•˜ìœ„ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ -> ì „ì²´ ì²´í¬ í•´ì œ
            subBoxes.forEach(box => {
                box.addEventListener('change', function() {
                    if(this.checked) {
                        allBox.checked = false;
                    }
                });
            });
        });
    });

    function addField() {
        const tpl = document.getElementById('field-template');
        const container = document.getElementById('field-container');
        const clone = tpl.content.cloneNode(true);
        
        // ì¸ë±ìŠ¤ ì²˜ë¦¬ (ì²´í¬ë°•ìŠ¤ìš©)
        const idx = container.querySelectorAll('.field-row').length;
        clone.querySelectorAll('input[type="checkbox"]').forEach(chk => {
            chk.value = idx;
        });
        
        container.appendChild(clone);
    }

    function addFirstField() {
        addField();
        const rows = document.querySelectorAll('.field-row');
        const firstRow = rows[rows.length-1]; // ë°©ê¸ˆ ì¶”ê°€ëœ í–‰
        
        // 1. ë¼ë²¨ ë³€ê²½
        firstRow.querySelector('label').innerText = "ğŸ“Œ ëŒ€í‘œ í•­ëª© (í•„ìˆ˜)";
        
        // 2. ì‚­ì œ ë²„íŠ¼ ì ê¸ˆ
        const delBtn = firstRow.querySelector('.btn-outline-danger');
        if(delBtn) delBtn.parentElement.innerHTML = '<button type="button" class="btn btn-light btn-sm" disabled>ğŸ”’</button>';
        
        // 3. í•„ìˆ˜ ì²´í¬ë°•ìŠ¤ ê°•ì œ
        const reqChk = firstRow.querySelector('input[name="field_required[]"]');
        if(reqChk) {
            reqChk.checked = true;
            reqChk.setAttribute("onclick", "return false;");
            reqChk.style.opacity = "0.5";
            // íˆë“  ì¸í’‹ ì¶”ê°€
            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "field_required[]";
            hidden.value = reqChk.value;
            reqChk.parentElement.appendChild(hidden);
        }
    }

    function removeField(btn) {
        btn.closest('.field-row').remove();
        // ì¸ë±ìŠ¤ ì¬ì •ë ¬ ë¡œì§ ìƒëµ
    }

    function toggleRelationOptions(select) {
        const row = select.closest('.field-row');
        const relOpt = row.querySelector('.relation-options');
        const txtOpt = row.querySelector('#option-row');
        
        if (select.value === 'relation') {
            relOpt.style.display = 'block';
            txtOpt.style.display = 'none'; // ê´€ê³„í˜•ì¼ ë• í…ìŠ¤íŠ¸ ì˜µì…˜ ìˆ¨ê¹€
        } else {
            relOpt.style.display = 'none';
            txtOpt.style.display = 'block';
        }
    }
</script>
{% endblock %}