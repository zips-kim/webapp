{% extends "layout.html" %}

{% block content %}

	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2 class="fw-bold m-0">ğŸ“„ {{ form.title }}</h2>
		<span class="text-muted fs-6">ì´ {{ total_count }}ê±´ì˜ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.</span>
		
		<div class="d-flex gap-2">
            {# [ê¶Œí•œ ì ìš©] ê´€ë¦¬ìë§Œ 'ì„¤ì •' ë²„íŠ¼ ë³´ì„ #}
            {% if current_user.is_admin %}
			    <a href="{{ url_for('flexible.edit_form', form_id=form.id) }}"  class="btn btn-primary">âš™ï¸ ì„¤ì •</a>
            {% endif %}

			<div class="btn-group" role="group">
				<button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
					ğŸ“Š ì—‘ì…€ ê´€ë¦¬
				</button>
				<ul class="dropdown-menu dropdown-menu-end shadow">
					<li>
						<a class="dropdown-item" href="{{ url_for('flexible.excel_download_entries', form_id=form.id) }}">
							ğŸ’¾ ì „ì²´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
						</a>
					</li>
					{# [ê¶Œí•œ ì ìš©] ë“±ë¡ ê¶Œí•œ ì²´í¬ #}
					{% if has_permission(form, 'create') %}
					<li><hr class="dropdown-divider"></li>
					<li>
						<a class="dropdown-item" href="{{ url_for('flexible.excel_download_template', form_id=form.id) }}">
							â¬‡ï¸ ì—…ë¡œë“œìš© ì„œì‹ ë‹¤ìš´ë¡œë“œ
						</a>
					</li>
					<li>
						<button class="dropdown-item" onclick="document.getElementById('excelInput').click()">
							â¬†ï¸ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
						</button>
					</li>
					{% endif %}

                    {# [ê¶Œí•œ ì ìš©] ê´€ë¦¬ìë§Œ 'ì „ì²´ ì‚­ì œ' ë©”ë‰´ ë³´ì„ #}
                    {% if current_user.is_admin %}
					    <li><hr class="dropdown-divider"></li>
					    <li>
						    <form action="{{ url_for('flexible.delete_all_entries', form_id=form.id) }}" method="POST"
							      onsubmit="return confirm('âš ï¸ ê²½ê³ : ì •ë§ë¡œ ì´ í¼ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ì ˆëŒ€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');">
							    <button type="submit" class="dropdown-item text-danger fw-bold">
								    ğŸ’£ ë°ì´í„° ì „ì²´ ì‚­ì œ (ì´ˆê¸°í™”)
							    </button>
						    </form>
					    </li>
                    {% endif %}
				</ul>
			</div>

			<div class="d-flex gap-2">
                {# [ê¶Œí•œ ì ìš©] ë“±ë¡ ê¶Œí•œ ì²´í¬ #}
				{% if has_permission(form, 'create') %}
					<a href="{{ url_for('flexible.create_entry', form_id=form.id) }}" class="btn btn-primary">
						+ ë°ì´í„° ë“±ë¡
					</a>
				{% endif %}
			</div>
		</div>
	</div>

	<form id="uploadForm" action="{{ url_for('flexible.excel_upload_entries', form_id=form.id) }}" method="POST" enctype="multipart/form-data" style="display:none;">
		<input type="file" name="file" id="excelInput" accept=".xlsx, .xls" onchange="document.getElementById('uploadForm').submit();">
	</form>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
            <a href="{{ url_for('flexible.list_network', form_id=form.id) }}" class="btn btn-outline-info">ğŸ•¸ï¸ ê´€ê³„ ë¶„ì„</a>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                ğŸ” ìƒì„¸ ê²€ìƒ‰ í•„í„°
            </button>
            <form class="d-flex" role="search">
                <input class="form-control me-2" type="search" name="q" value="{{ search_query }}" placeholder="í†µí•© ê²€ìƒ‰...">
                <button class="btn btn-outline-dark" type="submit">Go</button>
            </form>
        </div>
    </div>

<div class="collapse mb-4" id="filterPanel">
    <div class="card card-body bg-light border-0 shadow-sm">
        <form method="GET" action="{{ url_for('flexible.list_entries', form_id=form.id) }}">
            <div class="row g-3">
                {% for field in schema %}
                    {% if field.show_list %} <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">{{ field.label }}</label>
                        
                        {% if field.type == 'date' %}
                            <div class="input-group input-group-sm">
                                <input type="date" name="start_{{ field.key }}" class="form-control" 
                                       value="{{ current_filters.get('start_' + field.key, '') }}">
                                <span class="input-group-text">~</span>
                                <input type="date" name="end_{{ field.key }}" class="form-control" 
                                       value="{{ current_filters.get('end_' + field.key, '') }}">
                            </div>

                        {% elif field.type == 'relation' or field.options %}
							<select name="filter_{{ field.key }}" class="form-select form-select-sm">
								<option value="">ì „ì²´</option>
								
								{# 1. ê´€ê³„í˜•(Relation)ì¸ ê²½ìš° DBì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° í‘œì‹œ #}
								{% if field.type == 'relation' %}
									{% for opt in filter_options[field.key] %}
										<option value="{{ opt.id }}" {% if current_filters.get('filter_' + field.key) == opt.id %}selected{% endif %}>
											{{ opt.text }}
										</option>
									{% endfor %}
									
								{# 2. ì¼ë°˜ í…ìŠ¤íŠ¸ì§€ë§Œ ì˜µì…˜(options)ì´ ì •ì˜ëœ ê²½ìš° #}
								{% elif field.options %}
									{% for opt in field.options.split(',') %}
										{% set val = opt.strip() %} <option value="{{ val }}" {% if current_filters.get('filter_' + field.key) == val %}selected{% endif %}>
											{{ val }}
										</option>
									{% endfor %}
								{% endif %}
							</select>

                        {% else %}
                            <input type="text" name="filter_{{ field.key }}" class="form-control form-control-sm" 
                                   value="{{ current_filters.get('filter_' + field.key, '') }}" placeholder="ê²€ìƒ‰ì–´...">
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <div class="d-flex justify-content-end gap-2 mt-3 border-top pt-3">
                <a href="{{ url_for('flexible.list_entries', form_id=form.id) }}" class="btn btn-sm btn-outline-secondary">ğŸ”„ ì´ˆê¸°í™”</a>
                <button type="submit" class="btn btn-sm btn-primary fw-bold px-4">í•„í„° ì ìš©</button>
            </div>
        </form>
    </div>
</div>
    
    {# === CASE 1: ì¹´ë“œí˜• ë·° (Card View) === #}
    {% if form.view_type == 'card' %}
    
        <div class="row g-3">
            {% for item in data_list %}
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card h-100 shadow-sm hover-shadow transition-all">
                    
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <h5 class="card-title m-0 fw-bold text-truncate" style="max-width: 70%;">
                            {% set first_key = schema[0].key %}
                            {{ item.data[first_key] }}
                        </h5>
                        
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm rounded-circle" type="button" data-bs-toggle="dropdown">
                                â‹®
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{{ url_for('flexible.entry_network', entry_id=item.id) }}">ğŸ•¸ï¸ ê´€ê³„ ë¶„ì„</a></li>
                                
                                {# [ê¶Œí•œ ì ìš©] ìˆ˜ì • ê¶Œí•œ #}
                                {% if has_permission(form, 'update') %}
                                    <li><a class="dropdown-item" href="{{ url_for('flexible.edit_entry', entry_id=item.id, page=page) }}">âœï¸ ìˆ˜ì •</a></li>
                                {% endif %}

                                {# [ê¶Œí•œ ì ìš©] ì‚­ì œ ê¶Œí•œ #}
                                {% if has_permission(form, 'delete') %}
                                    <li>
                                        <form action="{{ url_for('flexible.delete_entry', entry_id=item.id) }}" method="POST" onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                            <button class="dropdown-item text-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                                        </form>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    <div class="card-body">
                        
                        {% for field in schema %}
                            {% if field.type == 'file' and item.data[field.key] %}
                                {% set ext = item.data[field.key].split('.')[-1].lower() %}
                                {% if ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                    <div class="mb-3 text-center bg-light rounded overflow-hidden" style="height: 150px;">
                                        <img src="{{ url_for('flexible.static', filename='uploads/' + item.data[field.key]) }}" 
                                             class="w-100 h-100 object-fit-cover" alt="image">
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        <div class="vstack gap-2">
                            {% for field in schema %}
                                {# ì²«ë²ˆì§¸ í•„ë“œ(ì œëª©)ì™€ íŒŒì¼ì€ ì œì™¸í•˜ê³  í‘œì‹œ #}
                                {% if not loop.first and field.type != 'file' and field.show_list %}
                                    <div class="d-flex justify-content-between small">
                                        <span class="text-muted">{{ field.label }}</span>
                                        <span class="fw-medium text-end text-truncate" style="max-width: 60%;">
                                            {% if field.type == 'relation' %}
                                                {% set val = item.data[field.key] %}
                                                {% if val is iterable and val is not string %}
                                                    {# ë¦¬ìŠ¤íŠ¸ì¸ ê²½ìš° #}
                                                    <span class="badge bg-secondary">{{ val|length }}ê°œ ì—°ê²°</span>
                                                {% else %}
                                                    {# ë‹¨ì¼ ê°’ì¸ ê²½ìš° #}
                                                    {{ lookup_map[field.key][val|string] if val else '-' }}
                                                {% endif %}
                                            {% else %}
                                                {{ item.data[field.key] }}
                                            {% endif %}
                                        </span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="card-footer bg-light py-2">
                        <small class="text-muted">ğŸ“… {{ item.created_at[:10] }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    {# === CASE 2: ë¦¬ìŠ¤íŠ¸í˜• ë·° (Table View) === #}
    {% else %}

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="50">No</th>
                        {% for field in schema %}
                            {% if field.show_list %}
                            <th>{{ field.label }}</th>
                            {% endif %}
                        {% endfor %}
                        <th width="150">ë“±ë¡ì¼</th>
                        <th width="150" class="text-end">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data_list %}
                    <tr>
                        <td>{{ item.id }}</td>
                        
                        {% for field in schema %}
                            {% if field.show_list %}
                            <td>
                                {% if field.type == 'file' and item.data[field.key] %}
                                    <a href="{{ url_for('flexible.static', filename='uploads/' + item.data[field.key]) }}" target="_blank" class="text-decoration-none">
                                        ğŸ“ <small>{{ item.data[field.key][:10] }}...</small>
                                    </a>
                                
                                {% elif field.type == 'relation' %}
                                    {% set val = item.data[field.key] %}
                                    {% if val %}
                                        {% if val is iterable and val is not string %}
                                            {% for v in val %}
                                                <span class="badge bg-secondary me-1">
                                                    {{ lookup_map[field.key][v|string] }}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="badge bg-light text-dark border">
                                                {{ lookup_map[field.key][val|string] }}
                                            </span>
                                        {% endif %}
                                    {% endif %}

                                {% else %}
                                    {{ item.data[field.key] }}
                                {% endif %}
                            </td>
                            {% endif %}
                        {% endfor %}

                        <td><small class="text-muted">{{ item.created_at[:16] }}</small></td>
                        
                        <td class="text-end text-nowrap">
                            <a href="{{ url_for('flexible.entry_network', entry_id=item.id) }}" class="btn btn-sm btn-outline-info me-1" title="ì—°ê´€ ë¶„ì„">ğŸ•¸ï¸</a>
                            
                            {# [ê¶Œí•œ ì ìš©] ìˆ˜ì • ê¶Œí•œ #}
                            {% if has_permission(form, 'update') %}
								<a href="{{ url_for('flexible.edit_entry', entry_id=item.id, page=page) }}" class="btn btn-sm btn-outline-primary me-1">ìˆ˜ì •</a>
							{% endif %}

                            {# [ê¶Œí•œ ì ìš©] ì‚­ì œ ê¶Œí•œ #}
                            {% if has_permission(form, 'delete') %}
                                <form action="{{ url_for('flexible.delete_entry', entry_id=item.id) }}" method="POST" onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="display:inline-block;">
                                    <button class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    {% endif %}

    {% if total_pages > 1 %}
    <nav class="mt-4">
        {# [ìˆ˜ì •ë¨] íŒŒë¼ë¯¸í„° ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ request.args ë³µì‚¬ í›„ page í‚¤ ì œê±° #}
        {% set args = request.args.copy() %}
        {% do args.pop('page', None) %}

        <ul class="pagination justify-content-center">
			<li class="page-item {% if page == 1 %}disabled{% endif %}">
                {# **args ë¡œ ë³€ê²½í•˜ì—¬ ì¶©ëŒ í•´ê²° #}
				<a class="page-link" href="{{ url_for('flexible.list_entries', form_id=form.id, page=page-1, **args) }}">ì´ì „</a>
			</li>

			{% for p in range(1, total_pages + 1) %}
			<li class="page-item {% if p == page %}active{% endif %}">
				<a class="page-link" href="{{ url_for('flexible.list_entries', form_id=form.id, page=p, **args) }}">
					{{ p }}
				</a>
			</li>
			{% endfor %}

			<li class="page-item {% if page == total_pages %}disabled{% endif %}">
				<a class="page-link" href="{{ url_for('flexible.list_entries', form_id=form.id, page=page+1, **args) }}">ë‹¤ìŒ</a>
			</li>
		</ul>
    </nav>
    {% endif %}

{% endblock %}