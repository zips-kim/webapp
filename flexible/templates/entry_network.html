{% extends "layout.html" %}

{% block content %}
<script src="https://d3js.org/d3.v7.min.js"></script>

<div class="container-fluid px-4 h-100 d-flex flex-column">
    <div class="d-flex justify-content-between align-items-center my-3">
        <div>
            <span class="badge bg-primary me-2">CENTER</span>
            <h3 class="d-inline fw-bold">"{{ center_label }}" ì—°ê´€ ë¶„ì„</h3>
        </div>
        <div>
            <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">ğŸ”™ ë’¤ë¡œê°€ê¸°</a>
        </div>
    </div>

    <div class="card shadow-sm border-0 flex-grow-1 mb-4" style="overflow: hidden;">
        <div class="card-body p-0 position-relative" id="graph-container" style="height: 75vh; background: #fdfdfd;">
            
            <div class="position-absolute top-0 start-0 m-3 p-3 bg-white bg-opacity-90 rounded shadow-sm border" style="z-index: 10;">
                <h6 class="fw-bold mb-2 small">ë²”ë¡€ <span class="text-muted fw-normal ms-1">(ON/OFF)</span></h6>
                <div id="legend-container">
                    </div>
            </div>

            </div>
    </div>
</div>

<script>
    const nodes = {{ nodes | tojson }};
    const links = {{ links | tojson }};
    
    // ìˆ¨ê²¨ì§„ ê·¸ë£¹ ê´€ë¦¬
    const hiddenGroups = new Set();
    
    // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    // -------------------------------------------------------
    // [1] ë²”ë¡€(Legend) ë°ì´í„° ì¶”ì¶œ ë° ìƒì„± (Client-Side)
    // -------------------------------------------------------
    const groups = new Map();
    nodes.forEach(n => {
        // ê·¸ë£¹ IDì™€ ì´ë¦„ ë§¤í•‘
        if (!groups.has(n.group)) {
            groups.set(n.group, n.form_title);
        }
    });

    const legendContainer = document.getElementById('legend-container');
    
    // ê·¸ë£¹ë³„ë¡œ ë²”ë¡€ ì•„ì´í…œ ìƒì„±
    groups.forEach((title, groupId) => {
        // ìƒ‰ìƒ ê²°ì • (CenterëŠ” ë¹¨ê°•, ë‚˜ë¨¸ì§€ëŠ” ìë™)
        const color = (groupId === 0) ? "#ff5252" : colorScale(groupId);
        const label = (groupId === 0) ? `ğŸ”´ Center (${title})` : title; // Center êµ¬ë¶„

        const item = document.createElement('div');
        item.className = 'd-flex align-items-center mb-1 legend-item';
        item.style.cursor = 'pointer';
        item.style.transition = 'all 0.2s';
        item.onclick = function() { toggleGroup(groupId, this, color); };
        
        item.innerHTML = `
            <span class="d-inline-block rounded-circle me-2" 
                  style="width: 12px; height: 12px; background-color: ${color};"></span>
            <span class="small fw-bold">${label}</span>
        `;
        legendContainer.appendChild(item);
        
        // CSS ë³€ìˆ˜ ì„¤ì • (ë‚˜ì¤‘ì— ì“¸ ìˆ˜ë„ ìˆìŒ)
        document.documentElement.style.setProperty(`--color-${groupId}`, color);
    });

    // -------------------------------------------------------
    // [2] D3 ê·¸ë˜í”„ ì„¤ì •
    // -------------------------------------------------------
    const width = document.getElementById('graph-container').clientWidth;
    const height = document.getElementById('graph-container').clientHeight;

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(150))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(50));

    const svg = d3.select("#graph-container").append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", [0, 0, width, height])
        .call(d3.zoom().on("zoom", (event) => {
            g.attr("transform", event.transform);
        }));

    svg.append("defs").selectAll("marker")
        .data(["end"])
        .enter().append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 32)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#ccc");

    const g = svg.append("g");

    const link = g.append("g")
        .attr("stroke", "#ccc")
        .attr("stroke-width", 2)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("marker-end", "url(#arrow)");

    const node = g.append("g")
        .selectAll("g")
        .data(nodes)
        .join("g")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

    // ë…¸ë“œ ì›
    node.append("circle")
        .attr("r", d => d.is_center ? 25 : 18)
        .attr("fill", d => d.is_center ? "#ff5252" : colorScale(d.group))
        .attr("stroke", "#fff")
        .attr("stroke-width", 3)
        .style("cursor", "pointer")
        .style("filter", "drop-shadow(2px 3px 3px rgba(0,0,0,0.2))")
        .on("click", (e, d) => {
            if (hiddenGroups.has(d.group)) return; // ìˆ¨ê²¨ì§„ ë…¸ë“œëŠ” í´ë¦­ ë¶ˆê°€

            if (!d.is_center) {
                location.href = `/entry/network/${d.id}`;
            } else {
                location.href = `/entry/edit/${d.id}`;
            }
        });

    // í…ìŠ¤íŠ¸ ë¼ë²¨
    node.append("text")
        .text(d => d.label)
        .attr("x", 0)
        .attr("y", d => d.is_center ? 40 : 32)
        .attr("text-anchor", "middle")
        .style("font-size", d => d.is_center ? "16px" : "12px")
        .style("font-weight", "bold")
        .style("fill", "#333")
        .style("pointer-events", "none");

    // í¼ ì´ë¦„ (ì‘ê²Œ)
    node.append("text")
        .text(d => d.form_title)
        .attr("x", 0)
        .attr("y", d => d.is_center ? -32 : -25)
        .attr("text-anchor", "middle")
        .style("font-size", "10px")
        .style("fill", "#666")
        .style("pointer-events", "none");

    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    // ----------------------------------------------------
    // [3] í† ê¸€ ê¸°ëŠ¥ êµ¬í˜„
    // ----------------------------------------------------
    window.toggleGroup = function(groupId, element, originalColor) {
        if (hiddenGroups.has(groupId)) {
            hiddenGroups.delete(groupId); // ë³´ì´ê¸°
            element.style.opacity = "1";
            element.style.textDecoration = "none";
            element.querySelector('.rounded-circle').style.backgroundColor = originalColor;
        } else {
            hiddenGroups.add(groupId); // ìˆ¨ê¸°ê¸°
            element.style.opacity = "0.4";
            element.style.textDecoration = "line-through";
            element.querySelector('.rounded-circle').style.backgroundColor = "#ccc";
        }
        updateVisibility();
    };

    function updateVisibility() {
        // ë…¸ë“œ íˆ¬ëª…ë„
        node.style("opacity", d => hiddenGroups.has(d.group) ? 0.05 : 1)
            .style("pointer-events", d => hiddenGroups.has(d.group) ? "none" : "all");

        // ë§í¬ íˆ¬ëª…ë„
        link.style("opacity", d => {
            if (hiddenGroups.has(d.source.group) || hiddenGroups.has(d.target.group)) {
                return 0.05;
            }
            return 1;
        });
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
</script>
{% endblock %}