{% extends "layout.html" %}

{% block content %}
<div class="container-fluid px-4">
    <h2 class="fw-bold my-4">ğŸ› ï¸ ì‹œìŠ¤í…œ ê´€ë¦¬ì (DB)</h2>

    <div class="row mb-4">
        <div class="col-lg-3 mb-4 mb-lg-0">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold bg-light">ğŸ“‚ í…Œì´ë¸” ëª©ë¡</div>
                <div class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
                    {% for table in tables %}
                        <a href="{{ url_for('flexible.admin_page', table=table) }}" class="list-group-item list-group-item-action {% if current_table == table %}active{% endif %}">
                            {{ table }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>
                        {% if current_table %}
                            ğŸ“‹ í…Œì´ë¸” ë°ì´í„°: <span class="text-primary">{{ current_table }}</span>
                            <small class="text-muted ms-2 fw-normal">(í–‰ì„ í´ë¦­í•˜ë©´ UPDATE ì¿¼ë¦¬ê°€ ìƒì„±ë©ë‹ˆë‹¤)</small>
                        {% else %}
                            ğŸ‘ˆ ì™¼ìª½ì—ì„œ í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”
                        {% endif %}
                    </span>
                    {% if current_table %}
                        <span class="badge bg-secondary">ìµœê·¼ 100ê±´ ì¡°íšŒ</span>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if current_table and columns %}
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-sm table-hover mb-0" id="dataTable" style="font-size: 0.85rem; cursor: pointer;">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        {% for col in columns %}
                                            <th data-column="{{ col }}">{{ col }}</th>
                                        {% endfor %}
                                        <th>ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data %}
                                        <tr onclick="makeUpdateQuery(this)">
                                            {% for col in columns %}
                                                <td class="text-truncate" style="max-width: 200px;">{{ row[col] }}</td>
                                            {% endfor %}
                                            <td onclick="event.stopPropagation()">
                                                {% if current_table == 'users' %}
                                                <form method="POST" action="{{ url_for('flexible.delete_user', user_id=row['id']) }}" onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="display:inline;">
                                                    <button class="btn btn-danger btn-sm py-0" style="font-size:0.7rem;">ì‚­ì œ</button>
                                                </form>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% elif current_table %}
                        <div class="p-3 text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted p-5">
                            ë°ì´í„°ë¥¼ ë³´ë ¤ë©´ í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card shadow-sm border-0 bg-white">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="m-0">ğŸ’» SQL ì¿¼ë¦¬ ì‹¤í–‰</h5>
                    <span class="badge bg-warning text-dark">ì£¼ì˜: ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('flexible.admin_page') }}">
                        <div class="mb-3">
                            <textarea id="sqlQueryInput" name="sql_query" class="form-control font-monospace bg-light" rows="6" placeholder="SELECT * FROM users WHERE..." style="font-size: 0.9rem;">{% if sql_query %}{{ sql_query }}{% elif current_table %}SELECT * FROM {{ current_table }} LIMIT 100{% endif %}</textarea>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearQuery()">ì§€ìš°ê¸°</button>
                            <button type="submit" class="btn btn-primary">ğŸš€ ì‹¤í–‰ (Execute)</button>
                        </div>
                    </form>

                    <div class="mt-4">
                        {% if query_error %}
                            <div class="alert alert-danger shadow-sm">
                                <strong>âŒ ì‹¤í–‰ ì‹¤íŒ¨:</strong><br>
                                {{ query_error }}
                            </div>
                        {% endif %}

                        {% if query_result %}
                            {% if query_result.type == 'action' %}
                                <div class="alert alert-success shadow-sm">
                                    âœ… {{ query_result.message }}
                                </div>
                            {% elif query_result.type == 'select' %}
                                <h6 class="fw-bold text-success mb-2">ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ({{ query_result.rows|length }}ê±´)</h6>
                                <div class="table-responsive border rounded" style="max-height: 400px;">
                                    <table class="table table-sm table-striped table-hover mb-0" style="font-size: 0.85rem;">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                {% for col in query_result.cols %}
                                                    <th>{{ col }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in query_result.rows %}
                                                <tr>
                                                    {% for col in query_result.cols %}
                                                        <td>{{ row[col] }}</td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                            {% if not query_result.rows %}
                                                <tr><td colspan="100%" class="text-center py-3">ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì¿¼ë¦¬ì°½ ì§€ìš°ê¸°
function clearQuery() {
    document.getElementById('sqlQueryInput').value = '';
}

// [í•µì‹¬] í´ë¦­í•œ í–‰ì˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ UPDATE ì¿¼ë¦¬ ìƒì„±
function makeUpdateQuery(row) {
    const tableHeaders = document.querySelectorAll('#dataTable thead th');
    const cells = row.getElementsByTagName('td');
    const currentTable = "{{ current_table }}"; // Jinja2 ë³€ìˆ˜

    if (!currentTable) return;

    let setClauses = [];
    let whereClause = "";

    // í—¤ë”ì™€ ì…€ ë°ì´í„°ë¥¼ ë§¤í•‘
    for (let i = 0; i < cells.length; i++) {
        // 'ê´€ë¦¬' ì»¬ëŸ¼ ë“± ë°ì´í„°ê°€ ì•„ë‹Œ ì»¬ëŸ¼ì€ ì œì™¸
        if (i >= tableHeaders.length) break;
        
        let colName = tableHeaders[i].innerText.trim();
        if (colName === 'ê´€ë¦¬') continue;

        let cellValue = cells[i].innerText.trim();
        
        // SQL ì‹±ê¸€ ì¿¼íŠ¸ ì´ìŠ¤ì¼€ì´í”„ (' -> '')
        let safeValue = cellValue.replace(/'/g, "''");

        // id ì»¬ëŸ¼ì€ WHERE ì ˆë¡œ, ë‚˜ë¨¸ì§€ëŠ” SET ì ˆë¡œ
        if (colName === 'id') {
            whereClause = `WHERE id = '${safeValue}'`;
        } else {
            setClauses.push(`${colName} = '${safeValue}'`);
        }
    }

    // UPDATE ì¿¼ë¦¬ ì¡°ë¦½
    // idê°€ ì—†ìœ¼ë©´ ì•ˆì „ì„ ìœ„í•´ WHERE ì ˆì„ ë¹„ì›Œë‘ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ (ì—¬ê¸°ì„  ì—†ìœ¼ë©´ 1=0ìœ¼ë¡œ ë§‰ìŒ)
    if (!whereClause) whereClause = "WHERE id = '???' -- ID ì»¬ëŸ¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";

    const query = `UPDATE ${currentTable} SET\n    ${setClauses.join(',\n    ')}\n${whereClause};`;

    // ì¿¼ë¦¬ ì…ë ¥ì°½ì— ê°’ ë„£ê¸°
    const queryBox = document.getElementById('sqlQueryInput');
    queryBox.value = query;
    
    // ì¿¼ë¦¬ì°½ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ ì´ë™
    queryBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // ì…ë ¥ì°½ ê¹œë¹¡ì„ íš¨ê³¼ (ì„ íƒì  UX)
    queryBox.style.backgroundColor = "#fff3cd";
    setTimeout(() => { queryBox.style.backgroundColor = "#f8f9fa"; }, 500);
}
</script>

<style>
    /* í…Œì´ë¸” í–‰ í˜¸ë²„ íš¨ê³¼ ê°•í™” */
    #dataTable tbody tr:hover {
        background-color: #e2e6ea !important;
        cursor: pointer;
    }
</style>
{% endblock %}