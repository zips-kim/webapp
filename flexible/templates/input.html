{% extends "layout.html" %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3">
		<h4 class="mb-0 fw-bold">
			{% if mode == 'edit' %}
				ğŸ› ï¸ {{ form.title }} <span class="text-warning fs-6">ë°ì´í„° ìˆ˜ì •</span>
			{% else %}
				âœï¸ {{ form.title }} <span class="text-primary fs-6">ìƒˆ ë°ì´í„° ë“±ë¡</span>
			{% endif %}
		</h4>
	</div>
    <div class="card-body p-4">
        <form method="POST" enctype="multipart/form-data">
            
            {% for field in schema %}
            <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                    {{ field.label }}
                    {% if field.required %} <span class="text-danger">*</span> {% endif %}
                </label>

                {# ========================================== #}
                {#  CASE 1: ğŸ“ íŒŒì¼/ì‚¬ì§„ ì…ë ¥ (File)          #}
                {# ========================================== #}
                {% if field.type == 'file' %}
                    <input type="file" name="{{ field.key }}" class="form-control" 
                           {% if field.required and not saved_input[field.key] %}required{% endif %}>
                    <div class="form-text text-muted">jpg, png, pdf ë“±ì˜ íŒŒì¼ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    
                    {% if saved_input and saved_input[field.key] %}
                        <div class="mt-2 p-2 bg-light border rounded d-inline-block">
                            <span class="small text-muted me-2">í˜„ì¬ íŒŒì¼:</span>
                            <a href="{{ url_for('static', filename='uploads/' + saved_input[field.key]) }}" target="_blank" class="fw-bold text-decoration-none">
                                ğŸ“ {{ saved_input[field.key] }}
                            </a>
                            <input type="hidden" name="existing_{{ field.key }}" value="{{ saved_input[field.key] }}">
                        </div>
                    {% endif %}


                {# ========================================== #}
                {#  CASE 2: ğŸ”— ê´€ê³„í˜• ë°ì´í„° (Relation)        #}
                {# ========================================== #}
                {% elif field.type == 'relation' %}
                    
                    {% if relation_options.get(field.key) %}
                        
                        {# --- 2-A. ì²´í¬ë°•ìŠ¤ (ë‹¤ì¤‘ ì„ íƒ) --- #}
                        {% if field.widget == 'checkbox' %}
                            <div class="card p-3 bg-light border-0">
                                <div class="row">
                                    {% for opt in relation_options[field.key] %}
                                    <div class="col-md-4 col-6 mb-2">
                                        <div class="form-check">
                                            {% set saved_vals = saved_input[field.key] if saved_input and saved_input[field.key] else [] %}
                                            
                                            <input class="form-check-input" type="checkbox" 
                                                   name="{{ field.key }}" value="{{ opt.id }}" 
                                                   id="chk_{{ field.key }}_{{ opt.id }}"
                                                   {% if opt.id|string in saved_vals %}checked{% endif %}>
                                            
                                            <label class="form-check-label" for="chk_{{ field.key }}_{{ opt.id }}">
                                                {{ opt.text }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-text text-primary">â€» ì—¬ëŸ¬ í•­ëª©ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

                        {# --- 2-B. ë¼ë””ì˜¤ ë²„íŠ¼ (ë‹¨ì¼ ì„ íƒ) --- #}
                        {% elif field.widget == 'radio' %}
                            <div class="card p-3 bg-light border-0">
                                <div class="d-flex flex-wrap gap-3">
                                    {% for opt in relation_options[field.key] %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               name="{{ field.key }}" value="{{ opt.id }}" 
                                               id="radio_{{ field.key }}_{{ opt.id }}"
                                               {% if field.required %}required{% endif %}
                                               {% if saved_input and saved_input[field.key]|string == opt.id|string %}checked{% endif %}>
                                        
                                        <label class="form-check-label" for="radio_{{ field.key }}_{{ opt.id }}">
                                            {{ opt.text }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                        {# --- 2-C. ì…€ë ‰íŠ¸ ë°•ìŠ¤ (ê¸°ë³¸ê°’) --- #}
                        {% else %}
                            <select name="{{ field.key }}" class="form-select" {% if field.required %}required{% endif %}>
                                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                                {% for opt in relation_options[field.key] %}
                                    <option value="{{ opt.id }}" 
                                            {% if saved_input and saved_input[field.key]|string == opt.id|string %}selected{% endif %}>
                                        {{ opt.text }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% endif %}

                    {% else %}
                        <div class="alert alert-warning py-2 small">
                            âš ï¸ ì—°ê²°ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì°¸ì¡°í•  ë°ì´í„°ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.
                        </div>
                    {% endif %}
                    
                    <small class="text-muted d-block mt-1">ë‹¤ë¥¸ í¼ì˜ ë°ì´í„°ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.</small>


                {# ========================================== #}
                {#  CASE 3: ğŸ“ ì¼ë°˜ í…ìŠ¤íŠ¸/ìˆ«ì/ë‚ ì§œ (Basic)   #}
                {# ========================================== #}
                {% else %}
                    <input type="{{ field.type }}" name="{{ field.key }}" class="form-control" 
                           value="{{ saved_input[field.key] if saved_input and saved_input[field.key] else '' }}"
                           placeholder="{{ field.label }} ì…ë ¥"
                           {% if field.required %}required{% endif %}>
                {% endif %}
            </div>
            {% endfor %}

            <hr class="my-4">
			
			{% if mode == 'edit' and reverse_refs %}
            <div class="mt-5">
                <h5 class="fw-bold border-bottom pb-2 mb-3">ğŸ”— ì—°ê´€ëœ í•˜ìœ„ ì •ë³´ (References)</h5>
                <div class="row g-3">
                    {% for ref in reverse_refs %}
                    <div class="col-md-6">
                        <div class="card h-100 border-0 bg-light shadow-sm">
                            <div class="card-header bg-transparent fw-bold text-primary border-bottom-0">
                                ğŸ“‚ {{ ref.form_title }}
                                <span class="badge bg-white text-secondary border ms-1">{{ ref.children|length }}ê±´</span>
                            </div>
                            <div class="card-body py-2">
                                <small class="text-muted d-block mb-2">
                                    ã„´ ì—°ê²° í•­ëª©: <span class="fw-bold">{{ ref.field_label }}</span>
                                </small>
                                <ul class="list-group list-group-flush small bg-transparent">
                                    {% for item in ref.children %}
                                    <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                                        <span>{{ item.label }}</span>
                                        <a href="/entry/edit/{{ item.id }}" class="btn btn-xs btn-outline-secondary py-0" style="font-size: 11px;">
                                            ì´ë™ â†—
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
				
			<hr class="my-4">
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {% if mode == 'edit' %}
                        <button type="button" 
                                class="btn btn-outline-danger"
                                formaction="/entry/delete/{{ saved_input['id'] }}"
                                formnovalidate
                                onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <a href="/list/{{ form.id }}" class="btn btn-secondary px-4">ì·¨ì†Œ</a>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </form>
		
		{% if mode == 'edit' and history_list %}
        <div class="mt-5">
            <h5 class="fw-bold border-bottom pb-2 mb-4">ğŸ“œ ë³€ê²½ ì´ë ¥ (History)</h5>
            
            <div class="timeline">
                {% for log in history_list %}
                <div class="d-flex mb-3">
                    <div class="me-3 d-flex flex-column align-items-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center text-white small shadow-sm"
                             style="width: 32px; height: 32px; background-color: {% if log.action == 'ìƒì„±' %}#28a745{% else %}#007bff{% endif %};">
                            {% if log.action == 'ìƒì„±' %}âœ¨{% else %}âœï¸{% endif %}
                        </div>
                        {% if not loop.last %}
                        <div class="bg-light" style="width: 2px; flex-grow: 1; margin-top: 5px;"></div>
                        {% endif %}
                    </div>
                    
                    <div class="card border-0 bg-light flex-grow-1 shadow-sm">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div>
                                    <span class="fw-bold text-dark">{{ log.user_name }}</span>
                                    <span class="badge bg-white text-secondary border ms-1">{{ log.action }}</span>
                                </div>
                                <small class="text-muted">{{ log.created_at[:16] }}</small>
                            </div>
                            <p class="mb-0 small text-secondary">
                                {{ log.details if log.details else "ë‚´ìš© ì—†ìŒ" }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}