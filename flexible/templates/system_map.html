{% extends "layout.html" %}

{% block content %}
<div class="container-fluid px-4 h-100 d-flex flex-column">
    <div class="d-flex justify-content-between align-items-center my-3">
        <div>
            <h4 class="fw-bold m-0">ğŸ•¸ï¸ Data Map</h4>
            <small class="text-muted">ì‹œìŠ¤í…œ ê°„ì˜ ë°ì´í„° ì—°ê²° íë¦„ë„ì…ë‹ˆë‹¤. ì—£ì§€ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ê´€ê³„ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
        <div>
            <span class="badge bg-light text-dark border me-2">â¬œ ë…¸ë“œ: ë°ì´í„° í¼</span>
            <span class="badge bg-primary">ğŸ”µ ë¼ë²¨: ì—°ê²° ê´€ê³„</span>
            <a href="/" class="btn btn-outline-secondary btn-sm ms-3">ğŸ  í™ˆìœ¼ë¡œ</a>
        </div>
    </div>

    <div class="card shadow-sm border-0 flex-grow-1 mb-4" style="height: 80vh; min-height: 600px;">
        <div class="card-body p-0 position-relative h-100">
            <div id="mynetwork" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="networkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-light">
            <div class="modal-header py-2">
                <h5 class="modal-title fw-bold" id="modalTitle">ìƒì„¸ ë¶„ì„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="overflow: hidden;">
                <iframe id="networkFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const rawNodes = {{ nodes | tojson }};
        const rawLinks = {{ links | tojson }};

        // 1. ë…¸ë“œ ìŠ¤íƒ€ì¼
        const nodes = new vis.DataSet(
            rawNodes.map(node => {
                const isCode = node.is_code;
                // ì´ë¦„ì— ì¤„ë°”ê¿ˆ ì¶”ê°€ (ê´„í˜¸ ê¸°ì¤€)
                const label = node.label.replace(/\(/, '\n('); 
                return {
                    id: node.id,
                    label: label,
                    shape: 'box',
                    color: {
                        background: '#eff6ff', // ì—°í•œ íŒŒë‘ ë°°ê²½
                        border: '#3b82f6',     // íŒŒë€ í…Œë‘ë¦¬
                        highlight: { background: '#fff9db', border: '#fcc419' }
                    },
                    font: { size: 16, color: '#1e3a8a', face: 'arial', bold: true },
                    margin: 15, borderWidth: 2, shadow: true,
                    widthConstraint: { maximum: 150 } // ë„ˆë¹„ ì œí•œ
                };
            })
        );

        // 2. ì—£ì§€ ìŠ¤íƒ€ì¼
        const edges = new vis.DataSet(
            rawLinks.map(link => {
                return {
                    id: `edge_${link.source}_${link.target}_${link.field_key}`, // ê³ ìœ  ID
                    from: link.source,
                    to: link.target,
                    label: link.label, 
                    // í´ë¦­ ì‹œ ì‚¬ìš©í•  ë°ì´í„°
                    data_src: link.source,
                    data_tgt: link.target,
                    data_key: link.field_key,
                    
                    arrows: { to: { enabled: true, scaleFactor: 0.8 } },
                    color: { color: '#1e293b', opacity: 1 },
                    font: { 
                        align: 'horizontal', size: 12, color: '#ffffff', 
                        background: '#3b82f6', strokeWidth: 0, vadjust: -2
                    },
                    width: 2,
                    smooth: { type: 'cubicBezier', forceDirection: 'horizontal', roundness: 0.4 }
                };
            })
        );

        const container = document.getElementById('mynetwork');
        const data = { nodes: nodes, edges: edges };
        const options = {
            physics: {
                enabled: false, // ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ ì •ì ìœ¼ë¡œ ë°°ì¹˜í•˜ë ¤ë©´ false ê¶Œì¥ (ë˜ëŠ” hierarchical)
                hierarchicalRepulsion: { nodeDistance: 200 }
            },
            layout: {
                hierarchical: {
                    enabled: true,
                    direction: 'LR', // ì¢Œ->ìš° ë°°ì¹˜
                    sortMethod: 'directed',
                    levelSeparation: 250,
                    nodeSpacing: 100
                }
            },
            interaction: { hover: true }
        };

        const network = new vis.Network(container, data, options);
        const modal = new bootstrap.Modal(document.getElementById('networkModal'));
        const frame = document.getElementById('networkFrame');
        const title = document.getElementById('modalTitle');

        // [í•µì‹¬] í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        network.on("click", function (params) {
            // 1. ì—£ì§€(ì—°ê²°ì„ ) í´ë¦­ -> ìƒì„¸ ë°ì´í„° ê´€ê³„ë„
            if (params.edges.length > 0 && params.nodes.length === 0) {
                const edgeId = params.edges[0];
                const edge = edges.get(edgeId);
                
                if (edge.data_src && edge.data_tgt) {
                    title.innerText = `ğŸ”— ì—°ê²° ìƒì„¸ ë¶„ì„ : ${edge.label}`;
                    frame.src = `/network/edge/${edge.data_src}/${edge.data_tgt}/${edge.data_key}`;
                    modal.show();
                }
            }
            // 2. ë…¸ë“œ(í¼) í´ë¦­ -> í•´ë‹¹ í¼ ë‚´ë¶€ ê´€ê³„ë„
            else if (params.nodes.length > 0) {
                const formId = params.nodes[0];
                const node = nodes.get(formId);
                
                title.innerText = `ğŸ“‚ ${node.label.replace('\n', '')} : ë‚´ë¶€ ë°ì´í„° ë§µ`;
                frame.src = `/list/network/${formId}`; 
                modal.show();
            }
        });

        network.on("hoverNode", () => container.style.cursor = 'pointer');
        network.on("blurNode", () => container.style.cursor = 'default');
        network.on("hoverEdge", () => container.style.cursor = 'pointer');
        network.on("blurEdge", () => container.style.cursor = 'default');
    });
</script>
{% endblock %}